<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="icon" type="image/x-icon" href="/favicon.ico">

<script type="text/javascript" data-cmp-ab="1" src="https://cdn.consentmanager.net/delivery/autoblocking/8bffa521a2c48.js" data-cmp-host="c.delivery.consentmanager.net" data-cmp-cdn="cdn.consentmanager.net" data-cmp-codesrc="16"></script>

<script>(function(w,d,t,r,u){var f,n,i;w[u]=w[u]||[],f=function(){var o={ti:"187195412", enableAutoSpaTracking: true};o.q=w[u],w[u]=new UET(o),w[u].push("pageLoad")},n=d.createElement(t),n.src=r,n.async=1,n.onload=n.onreadystatechange=function(){var s=this.readyState;s&&s!=="loaded"&&s!=="complete"||(f(),n.onload=n.onreadystatechange=null)},i=d.getElementsByTagName(t)[0],i.parentNode.insertBefore(n,i)})(window,document,"script","//bat.bing.com/bat.js","uetq");</script>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JGTS57FHD3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-JGTS57FHD3');
</script>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3883501504990181"
     crossorigin="anonymous"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Himmelblau Documentation</title>
    <link rel="stylesheet" href="announcements.css">
</head>
<body>
    <div id="announcement-banner" style="display: none;">
        <span id="close-banner">&times;</span>
        <div id="announcement-content"></div>
    </div>
<div class="page-nav">
    <nav>
        <ul>
            <li><a href="#introduction">Introduction</a></li>
	    <li><a href="#integration">Integration</a></li>
	    <li><a href="#ecosystem">Ecosystem</a></li>
            <li><a href="#architecture">Architecture</a></li>
	    <li><a href="#workflows">Workflows</a></li>
	    <li><a href="#registration">Registration</a></li>
            <li><a href="#installation">Installation</a></li>
            <li><a href="#configuration">Configuration</a></li>
            <li><a href="#troubleshooting">Troubleshooting</a></li>
        </ul>
    </nav>
</div>
    <div class="document">
<header class="header-nav">
    <div class="nav-container">
        <h1>Himmelblau Documentation</h1>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="downloads.html">Installation</a></li>
                <li><a href="backers.html">Donations</a></li>
		<!-- <li><a href="docs.html">Documentation</a></li> -->
                <li><a href="index.html#community">Community</a></li>
                <li><a href="blog.html">Blog</a></li>
                <li><a href="about.html">About</a></li>
            </ul>
        </nav>
    </div>
</header>
        <section id="introduction">
            <h2>Introduction to Himmelblau</h2>
<h4 id="toc_0.1.1">What is Himmelblau?</h4>

<p>Himmelblau is an open-source project designed to integrate Azure Entra ID (formerly Azure Active Directory) authentication seamlessly with Linux environments. By enabling features like single sign-on (SSO), multi-factor authentication (MFA), and secure token handling, Himmelblau allows organizations to bridge the gap between Microsoft’s enterprise identity solutions and Linux systems. It serves as a middleware layer, providing tools for authentication, device registration, and identity management across various Linux distributions.</p>

<p>The name &#39;Himmelblau&#39; is derived from German, meaning &#39;Sky blue&#39;, or &#39;Azure blue,&#39; a nod to Microsoft Azure, which the project is designed to integrate with. This name reflects the project&#39;s purpose of bridging Linux systems with Azure Entra ID authentication. Himmelblau originated as an open-source initiative aimed at addressing the gap in identity integration between Linux environments and Microsoft&#39;s enterprise cloud solutions.</p>

<p>Himmelblau leverages protocols such as OAuth2 and Kerberos to deliver secure and efficient authentication mechanisms. The project’s modular and lightweight design ensures it can scale across small deployments or large enterprise environments, making it suitable for diverse use cases.</p>

<h4 id="toc_0.1.2">Why Integrate Azure Entra ID with Linux?</h4>

<p>Modern enterprises often operate in hybrid environments that combine Windows and Linux systems. Azure Entra ID is a cornerstone of Microsoft’s cloud-based identity and access management strategy, providing centralized control over authentication, access policies, and user management. However, native Linux support for Azure Entra ID has historically been limited, creating challenges for organizations aiming to unify their IT infrastructure.</p>

<h5 id="toc_0.1.2.4">Key Benefits of Himmelblau Integration:</h5>

<ol dir="auto">
<li><strong>Unified Identity Management:</strong> Himmelblau enables Linux systems to use the same credentials as Windows systems, reducing administrative overhead and improving user convenience.</li>
<li><strong>Enhanced Security:</strong> By supporting Azure Entra ID’s MFA options—such as FIDO2, SMS, and app-based authentication—Himmelblau enhances login security.</li>
<li><strong>Single Sign-On (SSO):</strong> Himmelblau’s integration with the Siemens linux-entra-sso framework ensures seamless SSO for browser-based applications, boosting productivity.</li>
<li><strong>Compliance and Auditability:</strong> Centralized identity management simplifies compliance with security policies and audit requirements, making it easier to meet regulatory standards.</li>
<li><strong>Scalability:</strong> Himmelblau’s modular architecture and compatibility with multiple Linux distributions make it ideal for both small and large-scale deployments.</li>
</ol>

<h4 id="toc_0.1.3">Himmelblau’s Role in the Open-Source Ecosystem</h4>

<p>Himmelblau stands out as an open-source alternative to proprietary identity integration solutions. By providing transparency and flexibility, it empowers organizations to:</p>

<ul dir="auto">
<li>Customize authentication workflows to suit their needs.</li>
<li>Contribute to the project’s development, fostering a collaborative community.</li>
<li>Avoid vendor lock-in, a common concern with proprietary tools.</li>
</ul>

<h4 id="toc_0.1.4">Summary</h4>

<p>Himmelblau is a transformative tool that bridges the gap between Azure Entra ID and Linux environments. By supporting secure, scalable, and seamless authentication workflows, it addresses the challenges of integrating diverse systems into a unified identity framework. This chapter introduced Himmelblau’s purpose, its advantages, and its importance in the open-source community. The next chapter will delve into the broader challenges of integrating Azure Entra ID with Linux systems and how Himmelblau mitigates these issues.</p>
        </section>
	<section id="integration">
		<h2>Azure Entra ID and Linux Integration Challenges</h2>

<h4 id="toc_0.2.1">Overview of Authentication Protocols</h4>

<p>Himmelblau uses OAuth2 as the primary protocol for authentication, leveraging Microsoft’s MS-OAPX and OAPXBC extensions. These extensions ensure secure and seamless integration with Azure Entra ID, providing robust support for modern authentication workflows.</p>

<h4 id="toc_0.2.2">Transitioning from On-Premises AD to Azure Entra ID</h4>

<p>For organizations migrating Linux systems from on-premises Active Directory (AD) to Azure Entra ID, the transition can be challenging, particularly with UID and GID mismatches. These discrepancies often arise due to differences in ID mapping between traditional tools like Winbind or SSSD and Himmelblau&#39;s default mapping strategies.</p>

<h5 id="toc_0.2.2.4">UID/GID Mismatch Issues</h5>

<ul dir="auto">
<li><strong>Cause:</strong> On-prem AD environments typically use either fixed UID/GID values from an Active Directory scheme extension or dynamically generated values using various ID mapping techniques from Winbind and SSSD. Himmelblau, however, generates UID/GID values dynamically based on its internal mapping logic.</li>
<li><strong>Impact:</strong> File ownerships and permissions may break, leading to potential access issues and administrative overhead.</li>
</ul>

<h5 id="toc_0.2.2.4">Workaround: SSSD for ID Mapping</h5>

<p>To mitigate UID/GID mismatch issues, organizations can continue using the SSSD NSS module for UID/GID mapping while utilizing Himmelblau solely for authentication. This hybrid approach allows:</p>

<ol dir="auto">
<li>Consistent UID/GID values by fetching them from the on-prem AD schema.</li>
<li>Modern OAuth2-based authentication through Himmelblau.</li>
</ol>

<p><strong>Configuration Example:</strong></p>

<ol dir="auto">
<li><p>Configure SSSD:</p>

<pre>[sssd]
domains = example.org

[domain/example.org]
id_provider = ad
ldap_id_mapping = false
</pre></li>
<li><p>Configure NSS:</p>

<pre>passwd:     files systemd sss
group:      files systemd sss
shadow:     files sss
</pre></li>
<li><p>Use Himmelblau for Authentication:
Ensure Himmelblau is configured in the PAM stack for <code>auth</code> , <code>account</code>, and <code>session</code> while disabling its NSS module.</p></li>
</ol>

<h5 id="toc_0.2.2.4">Future Improvements for ID Mapping</h5>

<p>To address these challenges more seamlessly, Himmelblau plans to:</p>

<ul dir="auto">
<li>Support synchronization of UID/GID attributes directly from Azure Entra ID using synced Active Directory extensions.</li>
<li>Develop enhanced ID mapping logic to maintain consistency across environments.</li>
</ul>

<h4 id="toc_0.2.3">Summary</h4>

<p>Integrating Linux systems with Azure Entra ID introduces unique challenges, particularly when transitioning from on-prem AD environments. By using OAuth2 with MS-OAPX/OAPXBC extensions for authentication and adopting workarounds like SSSD for ID mapping, organizations can achieve a smoother transition. Himmelblau’s future enhancements promise to further simplify these processes, ensuring consistent and secure identity management across hybrid infrastructures.</p>


	</section>
	<section id="ecosystem">
		<h2>The Himmelblau Ecosystem</h2>

<h4 id="toc_0.3.1">Core Features and Benefits</h4>

<p>Himmelblau provides a comprehensive suite of tools designed to integrate Azure Entra ID authentication into Linux environments. By leveraging open standards and implementing advanced features, it bridges the gap between Linux systems and Microsoft’s enterprise identity solutions. Below are the key features and benefits that define the Himmelblau ecosystem.</p>

<h5 id="toc_0.3.1.4">1. <strong>Azure Entra ID Integration</strong></h5>

<p>Himmelblau seamlessly integrates with Azure Entra ID, enabling Linux systems to utilize Azure’s robust identity and access management framework. This includes:</p>

<ul dir="auto">
<li>Multi-Factor Authentication (MFA) with app-based prompts, FIDO2 keys, and SMS codes.</li>
<li>Secure token exchange through OAuth2 flows.</li>
<li>Device registration, with future plans for compliance enforcement.</li>
</ul>

<h5 id="toc_0.3.1.4">2. <strong>Single Sign-On (SSO)</strong></h5>

<p>By incorporating the Siemens linux-entra-sso framework, Himmelblau ensures a consistent and secure SSO experience for browser-based applications. This functionality simplifies user workflows and boosts productivity by reducing the need for repeated logins.</p>

<h5 id="toc_0.3.1.4">3. <strong>Support for Kerberos Authentication</strong></h5>

<p>Himmelblau extends Azure Entra ID’s Kerberos capabilities to Linux environments. It retrieves and caches cloud-based Ticket Granting Tickets (TGTs) from Azure’s KDC, supporting both cloud and hybrid setups. This functionality ensures compatibility with existing Kerberos-based applications and workflows.</p>

<h5 id="toc_0.3.1.4">4. <strong>Modular Design</strong></h5>

<p>The Himmelblau ecosystem is designed with modularity in mind, allowing administrators to enable or disable features based on organizational needs. This flexibility ensures that Himmelblau can scale from small deployments to large enterprise environments.</p>

<h5 id="toc_0.3.1.4">5. <strong>Enhanced Security</strong></h5>

<p>Himmelblau incorporates features like encrypted token storage, PAM integration, and support for secure device authentication. These measures help organizations meet compliance requirements and protect sensitive data.</p>

<h5 id="toc_0.3.1.4">6. <strong>Open-Source Flexibility</strong></h5>

<p>As an open-source project, Himmelblau empowers organizations to:</p>

<ul dir="auto">
<li>Customize features to fit their unique requirements.</li>
<li>Contribute to the codebase and shape the project’s development.</li>
<li>Avoid vendor lock-in, ensuring long-term flexibility and cost savings.</li>
</ul>

<h4 id="toc_0.3.2">Supported Linux Distributions</h4>

<p>Himmelblau is compatible with a wide range of Linux distributions, including enterprise-grade and community-supported versions. Current supported distributions include:</p>

<ul dir="auto">
<li><strong>Enterprise Distributions:</strong> SUSE Linux Enterprise, Red Hat Enterprise Linux, Rocky Linux.</li>
<li><strong>Community Distributions:</strong> Ubuntu, Debian, Fedora, and openSUSE.</li>
</ul>

<p>This extensive compatibility ensures that organizations can adopt Himmelblau regardless of their Linux environment.</p>

<h4 id="toc_0.3.3">Interoperability with Microsoft Services</h4>

<p>Himmelblau’s design prioritizes seamless interaction with Microsoft’s ecosystem, enabling Linux clients to access:</p>

<ul dir="auto">
<li>Microsoft 365 services.</li>
<li>Azure-based applications and resources.</li>
<li>On-premises systems configured for Azure AD hybrid setups.</li>
</ul>

<p>This interoperability allows organizations to maintain consistent identity management across their entire infrastructure, regardless of the underlying operating system.</p>

<h4 id="toc_0.3.4">Summary</h4>

<p>The Himmelblau ecosystem represents a powerful solution for integrating Azure Entra ID with Linux environments. Its robust feature set, extensive distribution support, and open-source foundation make it a versatile tool for organizations of all sizes. The next chapter will explore the technical architecture and components that make Himmelblau such an effective bridge between these two ecosystems.</p>

	</section>
        <section id="architecture">
            <h2>Understanding Himmelblau Architecture</h2>

<h4 id="toc_0.4.1">Key Components of Himmelblau</h4>

<p>Himmelblau’s architecture is designed to seamlessly integrate Linux systems with Azure Entra ID, leveraging a modular and scalable framework. This chapter explores its core components and their roles in achieving secure and efficient authentication.</p>

<h5 id="toc_0.4.1.4">1. Authentication Daemon (<code>himmelblaud</code>)</h5>

<p>The <code>himmelblaud</code> daemon is the central component responsible for handling authentication requests and interacting directly with Azure Entra ID. Key functionalities include:</p>

<ul dir="auto">
<li><p><strong>User Authentication:</strong> Processes login attempts and validates credentials against Azure Entra ID.</p></li>
<li><p><strong>OAuth2 Flows:</strong> Initiates authentication and token exchanges with Azure Entra ID, passing tokens to the Himmelblau Broker via a secure socket.</p></li>
<li><p><strong>Token Management:</strong> Manages the secure storage, caching, and renewal of authentication tokens.</p></li>
<li><p><strong>Integration with PAM and NSS:</strong> Supports Pluggable Authentication Modules (PAM) for system-level authentication and integrates with NSS to provide consistent user and group information across the system.</p></li>
</ul>

<h5 id="toc_0.4.1.4">2. <strong>Himmelblau Broker</strong></h5>

<p>The Himmelblau Broker serves as a middleware layer, facilitating communication between Linux applications and Azure Entra ID. Key functions include:</p>

<ul dir="auto">
<li><p><strong>DBus Integration for SSO:</strong> Exposes a DBus interface for seamless interaction with browser and application plugins.</p></li>
<li><p><strong>Socket-Based Communication:</strong> Receives OAuth2 tokens and other data from the <code>himmelblaud</code> daemon via a secure socket for further processing.</p></li>
</ul>

<h5 id="toc_0.4.1.4">3. <strong>Configuration Management</strong></h5>

<p>Himmelblau’s configuration is managed through the <code>/etc/himmelblau/himmelblau.conf</code> file. Key elements include:</p>

<ul dir="auto">
<li>Domain and tenant configuration.</li>
<li>Debugging and logging options.</li>
<li>User and group mapping settings.</li>
</ul>

<p>Example configuration:</p>

<pre>[global]
domains = example.com
pam_allow_groups = f3c9a7e4-7d5a-47e8-832f-3d2d92abcd1
</pre>

<h5 id="toc_0.4.1.4">4. <strong>Kerberos Integration</strong></h5>

<p>Himmelblau extends Kerberos functionality to Azure Entra ID by acting as a Kerberos client. It retrieves and caches Ticket Granting Tickets (TGTs) from Azure Entra ID’s cloud-based KDC, enabling:</p>

<ul dir="auto">
<li>Secure, token-based access to resources.</li>
<li>Support for hybrid scenarios involving on-premises Active Directory.</li>
</ul>

<p>Example Kerberos configuration:</p>

<pre>[realms]
KERBEROS.MICROSOFTONLINE.COM = {
    kdc = https://login.microsoftonline.com/common/kerberos
}

[libdefaults]
default_ccache_name = DIR:/tmp/krb5cc_%{uid}
</pre>

<h5 id="toc_0.4.1.4">5. Support Services (<code>himmelblaud-tasks</code>)</h5>

<p>The <code>himmelblaud-tasks</code> service handles essential background operations, including:</p>

<ul dir="auto">
<li><strong>Kerberos Flows:</strong> Manages Kerberos ticket retrieval, caching, and renewal.</li>
<li><strong>Startup Script Execution:</strong> Executes scripts required during system initialization.</li>
<li><strong>Home Directory Creation:</strong> Ensures authenticated users have properly initialized home directories.</li>
</ul>

<h4 id="toc_0.4.2">Scalability and Modularity</h4>

<p>Himmelblau’s modular architecture ensures it can adapt to various organizational needs. Administrators can enable or disable components depending on the deployment scenario, ensuring optimal resource usage.</p>

<h5 id="toc_0.4.2.4">Deployment Scenarios</h5>

<ul dir="auto">
<li><strong>Small Deployments:</strong> Lightweight installations with minimal configurations.</li>
<li><strong>Enterprise Deployments:</strong> Scalable setups with Kerberos integration, hybrid configurations, and extensive logging for compliance.</li>
</ul>

<h4 id="toc_0.4.3">Summary</h4>

<p>Himmelblau’s architecture is built to bridge the gap between Azure Entra ID and Linux systems. By combining modular components, robust token management, and seamless Kerberos integration, Himmelblau provides a scalable and secure authentication framework. The next chapter will explore how these components interact in real-world deployment scenarios.</p>

        </section>
	<section id="workflows">
		<h2>Authentication Workflows</h2>

<h4 id="toc_0.5.1">Overview</h4>

<p>Himmelblau provides seamless authentication workflows that bridge the gap between Linux systems and Azure Entra ID. By leveraging protocols like OAuth2 and Kerberos, it ensures secure and efficient user authentication, supports single sign-on (SSO), and integrates with multi-factor authentication (MFA) mechanisms. This chapter outlines the main authentication workflows in Himmelblau, highlighting the steps involved and the components responsible for each.</p>

<h4 id="toc_0.5.2">Authentication Workflow</h4>

<p>Himmelblau enables Linux systems to interact securely with Azure Entra ID. The workflow involves the following steps:</p>

<ol dir="auto">
<li><strong>User Login Initiation:</strong>

<ul dir="auto">
<li>A user initiates a login process, typically through PAM.</li>
</ul></li>
<li><strong>Token Request:</strong>

<ul dir="auto">
<li>The <code>himmelblaud</code> daemon sends an OAuth2 token request to Azure Entra ID, including the user’s credentials or device code if applicable.</li>
</ul></li>
<li><strong>Primary Refresh Token (PRT) Issuance:</strong>

<ul dir="auto">
<li>Azure Entra ID validates the credentials and issues a Primary Refresh Token (PRT). The PRT serves as a long-lived token that can be used to request access and ID tokens without re-entering credentials.</li>
</ul></li>
<li><strong>SSO Token Request:</strong>

<ul dir="auto">
<li>When an application or service requires authentication, the PRT is used to request Single Sign-On (SSO) tokens from Azure Entra ID. These tokens are specific to the requested application or resource.</li>
</ul></li>
<li><strong>Token Handling:</strong>

<ul dir="auto">
<li>The access token and SSO tokens are passed securely to the Himmelblau Broker via a socket for further use by applications or services.</li>
</ul></li>
<li><strong>Session Initialization:</strong>

<ul dir="auto">
<li>The user’s session is authenticated, and any necessary initialization tasks, such as home directory creation, are handled by <code>himmelblaud-tasks</code>.</li>
</ul></li>
</ol>

<strong>About the Primary Refresh Token</strong>

<p>Himmelblau requests a Primary Refresh Token (PRT) as part of the login process. This token allows the system to request further access tokens without repeatedly prompting the user for credentials. Microsoft documents this behavior loosely under MS-OAPXBC, but Himmelblau's implementation often reflects undocumented or corrected behavior discovered through packet traces from Windows.</p>

<h4 id="toc_0.5.3">Kerberos Authentication Workflow</h4>

<p>Himmelblau integrates Azure Entra ID’s Kerberos capabilities to support existing Kerberos-dependent applications. The following steps outline the process:</p>

<ol dir="auto">
<li><strong>TGT Retrieval:</strong>

<ul dir="auto">
<li>Upon user login, <code>himmelblaud-tasks</code> retrieves a Ticket Granting Ticket (TGT) as part of the Primary Refresh Token (PRT) request from Azure Entra ID. The TGT is essential for Kerberos workflows and is obtained directly from the cloud-based KDC.</li>
</ul></li>
<li><strong>TGT Caching:</strong>

<ul dir="auto">
<li>The TGT is securely cached in the location specified by the Kerberos configuration (<code>/tmp/krb5cc_%{uid}</code>).</li>
</ul></li>
<li><strong>Service Ticket Requests:</strong>

<ul dir="auto">
<li>When a service requiring Kerberos authentication is accessed, the TGT is used to request a service ticket from the KDC.</li>
</ul></li>
<li><strong>Authentication Completion:</strong>

<ul dir="auto">
<li>The service ticket is presented to the target application or service, completing the authentication process.</li>
</ul></li>
</ol>

<h4 id="toc_0.5.4">Multi-Factor Authentication (MFA) Integration</h4>

<p>Himmelblau supports Azure Entra ID’s MFA capabilities, providing an additional layer of security.</p>

<p>Himmelblau emulates Azure Entra ID’s browser-based MFA flow using direct HTTP requests. This is necessary because native browser-based authentication is often not feasible on Linux login screens (e.g., GDM) or during SSH sessions. For compatibility, Himmelblau reproduces the web-based flow using GET and POST requests.</p>

<p>Common MFA methods include:</p>

<ul dir="auto">
<li><strong>App-Based Notifications:</strong> Users approve login attempts via the Microsoft Authenticator app. Himmelblau also supports passwordless authentication with Microsoft Authenticator, as well as other authenticator apps like Google Authenticator, where users receive a push notification and are prompted to enter an entropy code. This prompt is seamlessly integrated into the login process through PAM.</li>
<li><strong>FIDO2 Keys:</strong> Physical keys provide multi-factor authentication (MFA) by requiring both the key and the user’s password.</li>
<li><strong>SMS Codes:</strong> A one-time code sent to the user’s mobile device.</li>
</ul>

<p>These methods are seamlessly integrated into the OAuth2 and Kerberos workflows, ensuring robust security without complicating the user experience.</p>

<h4 id="toc_0.5.5">Single Sign-On (SSO) Workflow</h4>

<p>SSO is a critical feature for enterprise environments, allowing users to authenticate once and access multiple services. Himmelblau’s SSO implementation involves:</p>

<ol dir="auto">
<li><strong>Token Sharing via DBus:</strong>

<ul dir="auto">
<li>The Himmelblau Broker exposes tokens through a DBus interface, enabling applications and browser plugins to authenticate seamlessly.</li>
</ul></li>
<li><strong>Session Persistence:</strong>

<ul dir="auto">
<li>Tokens are securely stored and refreshed as needed, ensuring uninterrupted access to services.</li>
</ul></li>
</ol>

<h4 id="toc_0.5.6">Advanced Features</h4>

<h5 id="toc_0.5.6.4">Hybrid Authentication</h5>

<p>Himmelblau supports hybrid setups where both cloud and on-premises resources are accessible. In such environments:</p>

<ul dir="auto">
<li>Cloud TGTs from Azure Entra ID’s KDC can be exchanged for on-premises TGTs.</li>
<li>This flexibility allows organizations to transition gradually to cloud-first architectures.</li>
</ul>

<h5 id="toc_0.5.6.4">Token Management and Renewal</h5>

<ul dir="auto">
<li>Himmelblau’s components manage token lifecycles, ensuring timely renewal to prevent session interruptions.</li>
<li>Expired tokens are replaced automatically by <code>himmelblaud</code>, reducing administrative overhead.</li>
</ul>

<h4 id="toc_0.5.7">Linux Hello Authentication</h4>

<p>Himmelblau supports a passwordless authentication feature called Linux Hello, modeled after Windows Hello for Business. This mechanism allows users to authenticate using a PIN, and in the future, biometric devices such as fingerprint readers or facial recognition.</p>

<ul>
  <li><strong>Enrollment:</strong> Users can enroll a Hello credential (e.g., PIN) only after completing an MFA-based login.</li>
  <li><strong>Authentication:</strong> Future logins can use the Hello credential to prove possession of the secure key.</li>
  <li><strong>Protocol Enforcement:</strong> Microsoft requires MFA for Hello enrollment. Password-only or device authorization grant (DAG) flows are insufficient.</li>
</ul>

<p>This enables fast, secure login without passwords—ideal for desktop environments. The use of Linux Hello is discouraged for remote sessions (e.g. ssh).</p>

<h4 id="toc_0.5.8">Summary</h4>

<p>Himmelblau’s authentication workflows provide a robust framework for integrating Azure Entra ID with Linux systems. By supporting OAuth2, Kerberos, MFA, and SSO, it ensures secure and seamless user experiences. The next chapter will delve into deployment best practices, covering setup strategies for different organizational needs.</p>

	</section>
	<section id="registration">
		<h2>Device Registration with Azure Entra ID</h2>

<h4 id="toc_0.6.1">Overview</h4>

<p>Device registration is a cornerstone of Azure Entra ID’s security framework, enabling organizations to enforce compliance policies, manage access, and enhance security for connected devices. Himmelblau leverages the Device Registration Service (DRS) protocol, as outlined in the MS-DRS specification, to seamlessly register Linux devices with Azure Entra ID. This chapter provides a detailed explanation of the device registration process.</p>

<h4 id="toc_0.6.2">Purpose of Device Registration</h4>

<p>Device registration establishes a device identity in Azure Entra ID, enabling administrators to:</p>

<ul dir="auto">
<li>Apply conditional access policies.</li>
<li>Track device compliance.</li>
<li>Enable secure access to enterprise resources.</li>
</ul>

<p>For Linux environments, Himmelblau facilitates device registration, bridging a gap previously filled by proprietary tools on other platforms.</p>

<h4 id="toc_0.6.3">Workflow for Device Registration</h4>

<p>Himmelblau’s device registration process adheres to the <a href="https://github.com/himmelblau-idm/aad-join-spec/blob/main/aad-join-spec.md#ms-drs-device-registration-service">MS-DRS</a> protocol.</p>

<p>Unlike Active Directory, which typically requires a manual device join by an administrator, Himmelblau automatically joins a Linux system to Azure Entra ID during the first user login. This process is transparent to the end user and uses the authenticated session to initiate the join.</p>

<p>Below is a detailed step-by-step breakdown:</p>

<ol dir="auto">
<li><p><strong>Initiating the Registration Process:</strong></p>

<ul dir="auto">
<li>At authentication time, when the first user logs in, Himmelblau triggers the device registration process in <code>himmelblaud</code>.</li>
<li>The daemon initiates an OAuth2 flow with Azure Entra ID to authenticate the user or service account performing the registration.</li>
</ul></li>
<li><p><strong>Retrieving Enrollment Information:</strong></p>

<ul dir="auto">
<li>Himmelblau queries Azure Entra ID’s Device Registration Discovery Service to retrieve the appropriate enrollment endpoints.</li>
<li>The discovery service provides URLs for submitting registration requests and obtaining required metadata.</li>
</ul></li>
<li><p><strong>Generating the Device Certificate Request:</strong></p>

<ul dir="auto">
<li>Himmelblau generates a Certificate Signing Request (CSR) using software-based keys and stores them securely.</li>
<li>The CSR includes the following details:

<ul dir="auto">
<li><strong>Public Key</strong>: A transport key generated by Himmelblau.</li>
<li><strong>Device Attributes</strong>: Information such as the operating system version and device type.</li>
<li><strong>Nonce</strong>: Obtained from the discovery service to ensure request integrity.</li>
</ul></li>
</ul></li>
<li><p><strong>Submitting the Registration Request:</strong></p>

<ul dir="auto">
<li>The CSR and associated metadata are submitted to Azure Entra ID via the JoinEndpoint URL.</li>
<li>Himmelblau includes additional attributes such as device display name and join type (e.g., Azure AD join or hybrid join).</li>
</ul></li>
<li><p><strong>Receiving the Device Certificate:</strong></p>

<ul dir="auto">
<li>Azure Entra ID validates the registration request and issues an X.509 device certificate.</li>
<li>The certificate is signed by Azure Entra ID’s Certificate Authority and contains the Device Id (A unique identifier for the registered device).</li>
</ul></li>
<li><p><strong>Storing the Device Certificate:</strong></p>

<ul dir="auto">
<li>Himmelblau securely stores the device certificate and associated keys in a local secure storage mechanism, such as Soft HSM.</li>
<li>This ensures the certificate is accessible for future authentication requests.</li>
</ul></li>
<li><p><strong>Completing the Registration:</strong></p>

<ul dir="auto">
<li>Once the certificate is stored, Himmelblau updates the device’s status in Azure Entra ID.</li>
<li>The device is now visible in the Azure portal, and administrators can monitor activity.</li>
</ul></li>
</ol>

<h4 id="toc_0.6.4">Summary</h4>

<p>Himmelblau’s implementation of the MS-DRS protocol ensures seamless device registration with Azure Entra ID, establishing a secure and compliant foundation for managing Linux devices. By automating key steps and leveraging robust cryptographic mechanisms, Himmelblau simplifies a traditionally complex process. In the next chapter, we will explore best practices for optimizing Himmelblau deployments in enterprise environments.</p>

	</section>
        <section id="installation">
            <h2>Installing Himmelblau</h2>

<h4 id="toc_0.7.1">Overview</h4>

<p>Installing Himmelblau is the first step toward integrating Azure Entra ID with Linux systems. This chapter provides a detailed guide for setting up Himmelblau on various supported Linux distributions. By the end of this chapter, you will have a functioning Himmelblau installation configured for your environment.</p>

<h4 id="toc_0.7.2">Supported Distributions</h4>

<p>Himmelblau supports a wide range of Linux distributions, including:</p>

<ul dir="auto">
<li><strong>Enterprise Distributions:</strong> SUSE Linux Enterprise, Red Hat Enterprise Linux, Rocky Linux.</li>
<li><strong>Community Distributions:</strong> Ubuntu, Debian, Fedora, and openSUSE.</li>
</ul>

<p>This diversity ensures that organizations can adopt Himmelblau regardless of their preferred Linux environment.</p>

<h4 id="toc_0.7.3">Pre-Installation Requirements</h4>

<p>Before installing Himmelblau, ensure that the following prerequisites are met:</p>

<ol dir="auto">
<li><p><strong>System Updates:</strong></p>

<ul dir="auto">
<li>Update the system packages to their latest versions.
<pre>
sudo apt update &amp;&amp; sudo apt upgrade  # For Debian-based systems
sudo dnf update                     # For Red Hat-based systems
sudo zypper update                  # For SUSE-based systems
</pre></li>
</ul></li>
<li><p><strong>Azure Entra ID Preparation:</strong></p>

<ul dir="auto">
<li>Verify that the Azure Entra ID tenant is configured for device registration and authentication.</li>
<li>Ensure you have appropriate permissions to add devices to the tenant.</li>
</ul></li>
</ol>

<h4 id="toc_0.7.4">Installation Instructions</h4>

<p>Follow these steps to install Himmelblau:</p>

<h5 id="toc_0.7.4.4">Debian/Ubuntu</h5>

<ol dir="auto">
<li><p><strong>Download the Packages:</strong></p>

<ul dir="auto">
<li>Obtain the latest Himmelblau .deb packages from the official repository.</li>
</ul></li>
<li><p><strong>Install the Packages:</strong></p>

<ul dir="auto">
<li>Use <code>dpkg</code> to install Himmelblau and its components.</li>
</ul>

<pre>sudo dpkg -i himmelblau_0.8.2-debian12_amd64.deb \
            himmelblau-sshd-config_0.8.2-debian12_amd64.deb \
            himmelblau-sso_0.8.2-debian12_amd64.deb \
            nss-himmelblau_0.8.2-debian12_amd64.deb \
            pam-himmelblau_0.8.2-debian12_amd64.deb
</pre></li>
<li><p><strong>Resolve Dependencies:</strong></p>

<ul dir="auto">
<li>Run the following command to install missing dependencies.</li>
</ul>

<pre>sudo apt --fix-broken install
</pre></li>
</ol>

<h5 id="toc_0.7.4.4">Red Hat/Rocky Linux/Fedora</h5>

<ol dir="auto">
<li><p><strong>Download the RPM Packages:</strong></p>

<ul dir="auto">
<li>Obtain the latest Himmelblau RPMs from the official repository.</li>
</ul></li>
<li><p><strong>Install the Packages:</strong></p>

<ul dir="auto">
<li>Use <code>dnf</code> to install Himmelblau.</li>
</ul>

<pre>sudo dnf install ./himmelblau-0.8.2-1.x86_64-rocky8.rpm \
                ./himmelblau-sshd-config-0.8.2-1.x86_64-rocky8.rpm \
                ./himmelblau-sso-0.8.2-1.x86_64-rocky8.rpm \
                ./nss-himmelblau-0.8.2-1.x86_64-rocky8.rpm \
                ./pam-himmelblau-0.8.2-1.x86_64-rocky8.rpm
</pre></li>
</ol>

<h5 id="toc_0.7.4.4">SUSE/OpenSUSE</h5>

<ol dir="auto">
<li><p><strong>Download the RPM Packages:</strong></p>

<ul dir="auto">
<li>Obtain the Himmelblau RPMs for SUSE from the official repository.</li>
</ul></li>
<li><p><strong>Install the Packages:</strong></p>

<ul dir="auto">
<li>Use <code>zypper</code> to install Himmelblau.</li>
</ul>

<pre>sudo zypper install ./himmelblau-0.8.2-1.x86_64-sle15sp6.rpm \
                   ./himmelblau-sshd-config-0.8.2-1.x86_64-sle15sp6.rpm \
                   ./himmelblau-sso-0.8.2-1.x86_64-sle15sp6.rpm \
                   ./nss-himmelblau-0.8.2-1.x86_64-sle15sp6.rpm \
                   ./pam-himmelblau-0.8.2-1.x86_64-sle15sp6.rpm
</pre></li>
</ol>

<h4 id="toc_0.7.5">Post-Installation Steps</h4>

<ol dir="auto">
<li><p><strong>Configuration:</strong></p>

<ul dir="auto">
<li>Himmelblau services should not be started until after configuration is complete, which will be covered in the next chapter.</li>
</ul></li>
<li><p><strong>Disable Name Service Caching (Optional):</strong></p>

<ul dir="auto">
<li><p>Disable <code>nscd</code> to ensure up-to-date user and group information.</p>

<pre>sudo systemctl disable nscd
sudo systemctl stop nscd
</pre></li>
</ul></li>
</ol>

<h4 id="toc_0.7.6">Chapter Summary</h4>

<p>This chapter covered the steps required to install Himmelblau on various Linux distributions, ensuring compatibility and optimal setup. The next chapter will focus on configuring Himmelblau to meet organizational requirements.</p>

        </section>
        <section id="configuration">
            <h2>Configuring Himmelblau</h2>

<h4 id="toc_0.8.1">Overview</h4>

<p>After installing Himmelblau, the next step is configuring it to integrate seamlessly with your Azure Entra ID environment. This chapter provides a detailed guide to configuring Himmelblau, including editing its configuration file, setting up domain and user options, and preparing it for production use. Once configuration is complete, the required daemons can be started to activate Himmelblau.</p>

<h4 id="toc_0.8.2">Configuration File</h4>

<p>The main configuration file for Himmelblau is located at:</p>

<pre>/etc/himmelblau/himmelblau.conf
</pre>

<p>This file controls essential settings, including domains, user authentication policies, and logging.</p>

<h5 id="toc_0.8.2.4">Sample Configuration</h5>

<p>Below is an example configuration file:</p>

<pre>[global]
domains = contoso.onmicrosoft.com
pam_allow_groups = f3c9a7e4-7d5a-47e8-832f-3d2d92abcd12
id_attr_map = name
home_attr = CN
home_alias = CN
use_etc_skel = true
</pre>

<h4 id="toc_0.8.3">Key Configuration Options</h4>

<ol dir="auto">
<li><p><strong>Domains:</strong></p>

<ul dir="auto">
<li>Specifies the Azure Entra ID domains allowed to authenticate.</li>
<li><p>Example:</p>

<pre>domains = contoso.onmicrosoft.com
</pre></li>
</ul></li>
<li><p><strong>Group Filtering:</strong></p>

<ul dir="auto">
<li>Use <code>pam_allow_groups</code> to restrict authentication to specific Azure Entra ID groups.</li>
<li><p>Example:</p>

<pre>pam_allow_groups = f3c9a7e4-7d5a-47e8-832f-3d2d92abcd12
</pre></li>
</ul></li>
<li><p><strong>Home Directory Options:</strong></p>

<ul dir="auto">
<li>Configure attributes for home directory creation.</li>
<li><p>Example:</p>

<pre>home_attr = CN
home_alias = CN
use_etc_skel = true
</pre></li>
</ul></li>
<li><p><strong>Logging:</strong></p>

<ul dir="auto">
<li>Adjust logging levels for debugging.</li>
<li><p>Example:</p>

<pre>debug = true
</pre></li>
</ul></li>
</ol>

<h4 id="toc_0.8.4">Configuring NSS and PAM</h4>

<p>Himmelblau integrates with NSS and PAM for user and group management. Ensure the following configurations are applied:</p>

<h5 id="toc_0.8.4.4">NSS Configuration</h5>

<p>Edit <code>/etc/nsswitch.conf</code> to include Himmelblau:</p>

<pre>passwd:    files systemd himmelblau
shadow:    files himmelblau
group:     files systemd himmelblau
</pre>

<h5 id="toc_0.8.4.4">PAM Configuration</h5>

<p>Himmelblau’s PAM module can be configured automatically using distribution-specific tools, through the <code>aad-tool</code> utility (v1.0.0+), or manually for advanced customization. This configuration enables systems to authenticate users using their Azure Entra ID credentials through PAM.</p>

<ol>
  <li>
    <p><strong>Automatic Configuration:</strong></p>
    <ul>
      <li>
        <p>On <strong>Ubuntu/Debian</strong>, use the <code>pam-auth-update</code> utility:</p>
        <pre>sudo pam-auth-update</pre>
        <p>Ensure the <strong>Azure authentication</strong> checkbox is enabled. After saving, verify that PAM files were updated correctly.</p>
      </li>
      <li>
        <p>On <strong>openSUSE Tumbleweed</strong> or <strong>SUSE Linux Enterprise</strong>, use:</p>
        <pre>pam-config --add --himmelblau</pre>
      </li>
    </ul>
  </li>

  <li>
    <p><strong>Configuration Using <code>aad-tool</code> (Himmelblau 1.0.0 and above):</strong></p>
    <p>The <code>aad-tool configure-pam</code> command helps inject recommended PAM directives into the appropriate configuration files.</p>

    <p>By default, it performs a <strong>dry run</strong> — showing the changes it would make without modifying any files:</p>
    <pre>sudo aad-tool configure-pam</pre>

    <p>To apply the changes, use the <code>--really</code> flag:</p>
    <pre>sudo aad-tool configure-pam --really</pre>

    <p>To view verbose output, add <code>--debug</code>:</p>
    <pre>sudo aad-tool configure-pam --really --debug</pre>

    <p>You can optionally specify custom target files instead of using the default files in <code>/etc/pam.d</code>:</p>
    <ul>
      <li><code>--auth-file &lt;PATH&gt;</code> – Target file for the <code>auth</code> stack (e.g., <code>common-auth</code>)</li>
      <li><code>--account-file &lt;PATH&gt;</code> – Target file for the <code>account</code> stack</li>
      <li><code>--session-file &lt;PATH&gt;</code> – Target file for the <code>session</code> stack</li>
      <li><code>--password-file &lt;PATH&gt;</code> – Target file for the <code>password</code> stack</li>
    </ul>

    <p>This is especially useful for testing or containerized environments where you don’t want to touch live PAM files:</p>

    <pre>
sudo aad-tool configure-pam \
  --auth-file ./test_pam/common-auth \
  --account-file ./test_pam/common-account \
  --session-file ./test_pam/common-session \
  --password-file ./test_pam/common-password
    </pre>
  </li>

  <li>
    <p><strong>Manual Configuration:</strong></p>
    <p>For full control, you may manually configure the PAM stack. Ensure that <code>pam_himmelblau.so</code> is placed <strong>before</strong> <code>pam_unix.so</code> in <code>common-auth</code>, and always <strong>after</strong> modules like <code>pam_localuser.so</code>. This is important for Hello for Business and passwordless logins. Use the <code>ignore_unknown_user</code> option to prevent errors for local-only accounts.</p>

    <ul>
      <li>
        <p><strong><code>/etc/pam.d/common-auth</code>:</strong></p>
        <pre>
auth        required      pam_env.so
auth        [default=1 ignore=ignore success=ok] pam_localuser.so
auth        sufficient    pam_himmelblau.so ignore_unknown_user
auth        sufficient    pam_unix.so nullok try_first_pass
auth        required      pam_deny.so
        </pre>
      </li>

      <li>
        <p><strong><code>/etc/pam.d/common-account</code>:</strong></p>
        <pre>
account    [default=1 ignore=ignore success=ok] pam_localuser.so
account    sufficient    pam_himmelblau.so ignore_unknown_user
account    sufficient    pam_unix.so
account    required      pam_deny.so
        </pre>
      </li>

      <li>
        <p><strong><code>/etc/pam.d/common-session</code>:</strong></p>
        <pre>
session optional    pam_systemd.so
session required    pam_limits.so
session optional    pam_unix.so try_first_pass
session optional    pam_umask.so
session optional    pam_himmelblau.so
session optional    pam_env.so
        </pre>
      </li>

      <li>
        <p><strong><code>/etc/pam.d/common-password</code>:</strong></p>
        <pre>
password    sufficient    pam_himmelblau.so ignore_unknown_user
password    optional      pam_gnome_keyring.so use_authtok
password    sufficient    pam_unix.so use_authtok nullok shadow try_first_pass
password    required      pam_deny.so
        </pre>
      </li>
    </ul>
  </li>
</ol>

<h4 id="toc_0.8.5">Starting Himmelblau Services</h4>

<p>Once the configuration is complete, enable and start the Himmelblau daemons to activate the service:</p>

<pre>sudo systemctl enable himmelblaud himmelblaud-tasks
sudo systemctl start himmelblaud himmelblaud-tasks
</pre>

<h4 id="toc_0.8.6">Verification</h4>

<ol dir="auto">
<li><p><strong>Service Status:</strong></p>

<ul dir="auto">
<li>Verify that the Himmelblau daemons are running:
<pre>
systemctl status himmelblaud
systemctl status himmelblaud-tasks
</pre></li>
</ul></li>
<li><p><strong>NSS User Resolution:</strong></p>

<ul dir="auto">
<li>Check that NSS resolves Azure Entra ID users correctly:
<pre>
getent passwd user@domain.onmicrosoft.com
</pre></li>
</ul></li>
<li><p><strong>Test Authentication:</strong></p>

<ul dir="auto">
<li>Attempt to log in with a user account from Azure Entra ID:
<pre>
su -l user@domain.onmicrosoft.com
</pre></li>
</ul></li>
<li><p><strong>Check Logs:</strong></p>

<ul dir="auto">
<li><p>Inspect the logs for any errors:</p>

<pre>sudo journalctl -u himmelblaud -u himmelblaud-tasks
</pre></li>
<li><p>Verify that the Himmelblau daemons are running:</p>

<pre>systemctl status himmelblaud
systemctl status himmelblaud-tasks
</pre></li>
</ul></li>
</ol>

<h4 id="toc_0.8.7">Summary</h4>

<p>This chapter covered configuring Himmelblau to integrate with Azure Entra ID, setting up NSS and PAM, and starting the necessary services. By following these steps, you’ll ensure a secure and functional deployment. The next chapter will address advanced configurations and optimization techniques.</p>

        </section>
        <section id="troubleshooting">
            <h2>Troubleshooting Common Issues</h2>

<h4 id="toc_0.9.1">Overview</h4>

<p>While Himmelblau is designed for seamless integration, issues may arise during deployment or operation. This chapter covers common problems and their resolutions, focusing on MFA-related SSH authentication issues and techniques for debugging authentication traffic.</p>

<h4 id="toc_0.9.2">Resolving MFA Problems with SSH</h4>

<p>SSH authentication involving Azure Entra ID MFA can present challenges, especially when using interactive prompts. Below are some common issues and solutions:</p>

<h5 id="toc_0.9.2.4">Problem: MFA Prompt Not Displayed in SSH Sessions</h5>

<p><strong>Symptoms:</strong> Users attempting to authenticate via SSH do not see the MFA prompt or entropy code. Authentication eventually times out or fails.</p>

<p><strong>Solution:</strong></p>

<ol dir="auto">
<li><p><strong>Enable Keyboard-Interactive Authentication:</strong></p>

<ul dir="auto">
<li>Verify that <code>AuthenticationMethods</code> in the SSH daemon configuration includes <code>keyboard-interactive:pam</code>.</li>
<li>Edit <code>/etc/ssh/sshd_config</code>:
<pre>
AuthenticationMethods keyboard-interactive:pam
KbdInteractiveAuthentication yes
UsePAM yes
</pre></li>
<li>Restart the SSH service:
<pre>
sudo systemctl restart sshd
</pre></li>
</ul></li>
<li><p><strong>Verify PAM Configuration:</strong></p>

<ul dir="auto">
<li>Ensure that <code>pam_himmelblau.so</code> is configured in the PAM stack for <code>auth</code> and <code>account</code>.</li>
<li>Example for <code>/etc/pam.d/sshd</code>:
<pre>
auth    required    pam_himmelblau.so
account required    pam_himmelblau.so
</pre></li>
</ul></li>
<li><p><strong>Test Locally:</strong></p>

<ul dir="auto">
<li>Log in locally to confirm that MFA prompts function correctly. This can help isolate SSH-specific issues:
<pre>
su -l user@domain.onmicrosoft.com
</pre></li>
</ul></li>
<li><p><strong>Check Logs:</strong></p>

<ul dir="auto">
<li>Inspect the SSH and Himmelblau logs for errors:
<pre>
sudo journalctl -u sshd -u himmelblaud
</pre></li>
</ul></li>
</ol>

<h5 id="toc_0.9.2.4">Problem: SSH Hangs After Entering Password</h5>

<p><strong>Symptoms:</strong> Users successfully enter their password, but the session hangs instead of displaying the MFA prompt.</p>

<p><strong>Solution:</strong></p>

<ul dir="auto">
<li>This issue is linked to OpenSSH Bug 2876, which affects how SSH handles interactive MFA prompts. Use the <code>mfa_poll_prompt</code> option to resolve this issue:

<ol dir="auto">
<li>Edit the PAM configuration for Himmelblau (e.g., <code>/etc/pam.d/sshd</code>) to include:
<pre>
auth    required    pam_himmelblau.so mfa_poll_prompt
account required    pam_himmelblau.so
</pre></li>
<li>Restart the SSH service to apply changes:
<pre>
sudo systemctl restart sshd
</pre></li>
<li>Test SSH authentication again to confirm the issue is resolved.</li>
</ol></li>
</ul>

<h4 id="toc_0.9.3">Debugging Authentication Traffic</h4>

<p>Effective debugging is essential for resolving complex authentication issues. Himmelblau supports various methods for capturing and analyzing authentication traffic.</p>

<h5 id="toc_0.9.3.1">Using <code>cirrus-scope</code> with <code>mitmproxy</code></h5>

<p>The <code>cirrus-scope</code> tool, in conjunction with <code>mitmproxy</code>, allows for comprehensive testing and debugging of Azure Entra ID authentication flows.</p>

<p><strong>Steps:</strong></p>

<ol>
  <li>
    <p><strong>Download and Install <code>cirrus-scope</code>:</strong></p>
    <ul>
      <li>Visit the Himmelblau downloads page: <a href="https://himmelblau-idm.org/downloads.html">https://himmelblau-idm.org/downloads.html</a></li>
      <li>Select your Linux distribution from the list provided. If your distribution isn't listed, you can file an <a href="https://github.com/himmelblau-idm/himmelblau/issues">enhancement request</a>.</li>
      <li>Follow the on-screen instructions to download and install the appropriate package for your system.</li>
    </ul>
  </li>
  <li>
    <p><strong>Download and Extract <code>mitmproxy</code>:</strong></p>
    <ul>
      <li>Download <code>mitmproxy</code> from their official website and extract the binaries:
        <pre>
tar -xf mitmproxy-11.0.0-linux-x86_64.tar.gz
        </pre>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>Start <code>mitmweb</code>:</strong></p>
    <ul>
      <li>Run the following command to start <code>mitmweb</code>:
        <pre>
./mitmweb
        </pre>
        This starts <code>mitmweb</code> and opens a web interface for monitoring HTTP and HTTPS traffic.
      </li>
    </ul>
  </li>
  <li>
    <p><strong>Install the <code>mitmproxy</code> CA Certificate:</strong></p>
    <ul>
      <li>On Ubuntu:
        <pre>
sudo cp $HOME/.mitmproxy/mitmproxy-ca-cert.pem /usr/local/share/ca-certificates/mitmproxy.crt
sudo update-ca-certificates
        </pre>
      </li>
      <li>On Fedora:
        <pre>
sudo cp $HOME/.mitmproxy/mitmproxy-ca-cert.pem /etc/pki/ca-trust/source/anchors/
sudo update-ca-trust
        </pre>
      </li>
      <li>On openSUSE Leap:
        <pre>
sudo cp $HOME/.mitmproxy/mitmproxy-ca-cert.pem /usr/share/pki/trust/anchors/mitmproxy.crt
sudo update-ca-certificates
        </pre>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>Access the Web Interface:</strong></p>
    <ul>
      <li>Open your web browser and navigate to:
        <pre>
http://127.0.0.1:8081/
        </pre>
        You should see the <code>mitmweb</code> dashboard for viewing captured traffic.
      </li>
    </ul>
  </li>
  <li>
    <p><strong>Run <code>cirrus-scope</code> with Proxy Enabled:</strong></p>
    <ul>
      <li>Execute the desired test command from <code>cirrus-scope</code>, routing its traffic through <code>mitmproxy</code> by setting the <code>HTTPS_PROXY</code> environment variable. For example:
        <pre>
HTTPS_PROXY=http://127.0.0.1:8080 cirrus-scope auth-test --name your_user@example.com
        </pre>
        You will be prompted to enter credentials interactively. For detailed logs, add the <code>--debug</code> flag:
        <pre>
HTTPS_PROXY=http://127.0.0.1:8080 cirrus-scope auth-test --name your_user@example.com --debug
        </pre>
        Other available test commands include:
        <ul>
          <li><code>enrollment-test</code>: Simulates device enrollment</li>
          <li><code>refresh-token-acquire</code>: Acquires new access tokens using a refresh token</li>
          <li><code>provision-hello-key-test</code>: Tests Hello for Business key provisioning</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>Capture and Save the HAR File:</strong></p>
    <ul>
      <li>In the <code>mitmweb</code> dashboard, click on the "File" drop-down menu, then select "Save". Your browser will download a file called 'flows'.</li>
      <li><strong>Important:</strong> Search the contents of the file for your password, as it will be present. Remove this password before sharing the file.</li>
      <li>If the authentication was successful, there will also be a valid access token and refresh token present. These should also be removed or obfuscated. Search the file for JSON keys such as 'refresh_token' and 'access_token'.</li>
    </ul>
  </li>
</ol>

<h4 id="toc_0.9.4">Summary</h4>

<p>This section provided guidance on debugging authentication traffic using tools like <code>cirrus-scope</code> and <code>mitmproxy</code>. These troubleshooting techniques ensure that Himmelblau operates smoothly and securely in your environment. The next section will explore future directions and enhancements for Himmelblau.</p>

        </section>
    <footer>
        <p>&copy; 2025 Himmelblau Project. All rights reserved.</p>
    </footer>
    </div>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const banner = document.getElementById("announcement-banner");
    const closeButton = document.getElementById("close-banner");
    const content = document.getElementById("announcement-content");

    // Function to generate a simple hash from a string
    function generateHash(text) {
        let hash = 0;
        for (let i = 0; i < text.length; i++) {
            hash = (hash << 5) - hash + text.charCodeAt(i);
            hash |= 0; // Convert to 32-bit integer
        }
        return hash.toString();
    }

    // Fetch the announcement text
    fetch("announcements.txt")
        .then(response => response.text())
        .then(html => {
            const newHash = generateHash(html.trim()); // Generate hash from announcement text
            const dismissedHash = localStorage.getItem("dismissedAnnouncementHash");

            // Show the banner if the announcement is different from the last dismissed one
            if (newHash !== dismissedHash) {
                content.innerHTML = html;
                banner.style.display = "flex";

                // Store the current announcement's hash (but don't mark it dismissed)
                localStorage.setItem("announcementHash", newHash);
            }
        })
        .catch(error => console.error("Failed to load announcement:", error));

    // Close the banner and remember dismissal only for the current announcement
    closeButton.addEventListener("click", function () {
        banner.style.display = "none";
        const currentHash = localStorage.getItem("announcementHash");
        localStorage.setItem("dismissedAnnouncementHash", currentHash); // Store only the dismissed announcement
    });
});
</script>
</body>
</html>
