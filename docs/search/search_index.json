{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Quickstart Himmelblau is an open-source authentication framework that brings Microsoft Entra ID login, policy enforcement, and Hello PIN support to Linux systems. This documentation will guide you through installation, configuration, and best practices for integrating Himmelblau into your environment. Get Started \ud83d\udce5 Installation Guide \u2699\ufe0f Configuration Reference \ud83d\udd10 NSS and PAM Setup \ud83e\udde0 Understanding Enrollment TL;DR Himmelblau is designed with sensible defaults to make initial setup fast and simple. If you're eager to get started without reading all the details, follow these basic steps: \ud83d\udce6 Download and install the packages (Choose the appropriate DEB or RPM for your system and install them.) \u270f\ufe0f Edit your config: Set the primary domain of your Entra ID tenant in /etc/himmelblau/himmelblau.conf : [global] domain = example.onmicrosoft.com To enforce MDM Intune compliance, enable it: [global] apply_policy = true \ud83d\udd10 Configure PAM On Debian based distros, pam configuration happened automatically when you installed Himmelblau. On openSUSE or SUSE Linux Enterprise: sudo pam-config --add --himmelblau On all other distros, you can run the manual config utility bundled with Himmelblau: sudo aad-tool configure-pam \ud83d\udc65 Configure NSS Add himmelblau to your /etc/nsswitch.conf to resolve Entra ID users and groups. passwd: files himmelblau group: files himmelblau \ud83d\ude80 Start the daemons: sudo systemctl enable himmelblaud himmelblaud-tasks sudo systemctl restart himmelblaud himmelblaud-tasks You\u2019re now ready to log in with your Entra ID credentials!","title":"Quickstart"},{"location":"#quickstart","text":"Himmelblau is an open-source authentication framework that brings Microsoft Entra ID login, policy enforcement, and Hello PIN support to Linux systems. This documentation will guide you through installation, configuration, and best practices for integrating Himmelblau into your environment.","title":"Quickstart"},{"location":"#get-started","text":"\ud83d\udce5 Installation Guide \u2699\ufe0f Configuration Reference \ud83d\udd10 NSS and PAM Setup \ud83e\udde0 Understanding Enrollment","title":"Get Started"},{"location":"#tldr","text":"Himmelblau is designed with sensible defaults to make initial setup fast and simple. If you're eager to get started without reading all the details, follow these basic steps: \ud83d\udce6 Download and install the packages (Choose the appropriate DEB or RPM for your system and install them.) \u270f\ufe0f Edit your config: Set the primary domain of your Entra ID tenant in /etc/himmelblau/himmelblau.conf : [global] domain = example.onmicrosoft.com To enforce MDM Intune compliance, enable it: [global] apply_policy = true \ud83d\udd10 Configure PAM On Debian based distros, pam configuration happened automatically when you installed Himmelblau. On openSUSE or SUSE Linux Enterprise: sudo pam-config --add --himmelblau On all other distros, you can run the manual config utility bundled with Himmelblau: sudo aad-tool configure-pam \ud83d\udc65 Configure NSS Add himmelblau to your /etc/nsswitch.conf to resolve Entra ID users and groups. passwd: files himmelblau group: files himmelblau \ud83d\ude80 Start the daemons: sudo systemctl enable himmelblaud himmelblaud-tasks sudo systemctl restart himmelblaud himmelblaud-tasks You\u2019re now ready to log in with your Entra ID credentials!","title":"TL;DR"},{"location":"about/","text":"About Himmelblau Himmelblau is an open-source authentication framework for Linux that integrates securely with Microsoft Entra ID (formerly Azure Active Directory). It bridges the long-standing gap between modern cloud identity and traditional Unix authentication (PAM/NSS), bringing MFA, device compliance, and policy enforcement to Linux \u2014 without proprietary agents or extra infrastructure. Himmelblau is German for \u201csky blue\u201d \u2014 a nod to Microsoft\u2019s Azure cloud and our mission to bring seamless cloud identity to Linux. Origins & Mission Himmelblau was conceived to address the growing need for seamless integration between Linux environments and Microsoft Entra ID . Originating as a fork of the Kanidm OAuth2 client led by William Brown (SUSE), Himmelblau tailors Kanidm\u2019s proven, security-focused foundations to the specifics of Entra ID, while pushing deeper into Intune policy enforcement, compliance reporting, and Hello for Business flows . Our mission is simple: Parity with Windows for authentication security and ease. First-class cloud identity on Linux \u2014 with open code, auditable flows, and a modern Rust codebase. Pragmatic interoperability with existing enterprise tooling. Key Features Microsoft Entra ID integration Native support for interactive and brokered OAuth 2.0 / OIDC flows, MFA, SSO, secure token management, and modern enterprise identity standards. (Optional / hybrid) Kerberos compatibility Extends Entra ID scenarios to Kerberos-backed environments for cloud and on-premises hybrid use cases. Intune policy & compliance Apply and report Linux Intune compliance results; cache and enforce password/PIN policies locally. Passwordless & FIDO2 Early support for passwordless authentication paths. Rust-first, modular architecture A systemd daemon ( himmelblaud ) plus PAM/NSS modules and CLI tooling \u2014 designed for reliability, memory safety, and maintainability. Open source & community-driven Built in the open, with transparent design, rigorous logging, and well-defined extension points. Supported Platforms Himmelblau targets a wide range of enterprise and community Linux distributions, including: SUSE / SLES Rocky Linux / RHEL Fedora Ubuntu Debian NixOS (We actively maintain cross-distro build pipelines and packaging; contributions for additional platforms are welcome.) Who\u2019s Behind It? Himmelblau is created and primarily maintained by David Mulder , with key contributions from William Brown and support from SUSE engineers and a growing community of open-source contributors. Get Involved We welcome contributors of all kinds \u2014 code, docs, packaging, testing, and real-world deployment feedback: Source & issues : Github Discuss / report bugs / request features : Open a GitHub issue or PR Sponsorship / support : Reach out to discuss enterprise needs, or sponsor the project . License Himmelblau is released under the GPLv3 (or later) \u2014 ensuring the code remains free, auditable, and community-owned.","title":"About"},{"location":"about/#about-himmelblau","text":"Himmelblau is an open-source authentication framework for Linux that integrates securely with Microsoft Entra ID (formerly Azure Active Directory). It bridges the long-standing gap between modern cloud identity and traditional Unix authentication (PAM/NSS), bringing MFA, device compliance, and policy enforcement to Linux \u2014 without proprietary agents or extra infrastructure. Himmelblau is German for \u201csky blue\u201d \u2014 a nod to Microsoft\u2019s Azure cloud and our mission to bring seamless cloud identity to Linux.","title":"About Himmelblau"},{"location":"about/#origins-mission","text":"Himmelblau was conceived to address the growing need for seamless integration between Linux environments and Microsoft Entra ID . Originating as a fork of the Kanidm OAuth2 client led by William Brown (SUSE), Himmelblau tailors Kanidm\u2019s proven, security-focused foundations to the specifics of Entra ID, while pushing deeper into Intune policy enforcement, compliance reporting, and Hello for Business flows . Our mission is simple: Parity with Windows for authentication security and ease. First-class cloud identity on Linux \u2014 with open code, auditable flows, and a modern Rust codebase. Pragmatic interoperability with existing enterprise tooling.","title":"Origins &amp; Mission"},{"location":"about/#key-features","text":"Microsoft Entra ID integration Native support for interactive and brokered OAuth 2.0 / OIDC flows, MFA, SSO, secure token management, and modern enterprise identity standards. (Optional / hybrid) Kerberos compatibility Extends Entra ID scenarios to Kerberos-backed environments for cloud and on-premises hybrid use cases. Intune policy & compliance Apply and report Linux Intune compliance results; cache and enforce password/PIN policies locally. Passwordless & FIDO2 Early support for passwordless authentication paths. Rust-first, modular architecture A systemd daemon ( himmelblaud ) plus PAM/NSS modules and CLI tooling \u2014 designed for reliability, memory safety, and maintainability. Open source & community-driven Built in the open, with transparent design, rigorous logging, and well-defined extension points.","title":"Key Features"},{"location":"about/#supported-platforms","text":"Himmelblau targets a wide range of enterprise and community Linux distributions, including: SUSE / SLES Rocky Linux / RHEL Fedora Ubuntu Debian NixOS (We actively maintain cross-distro build pipelines and packaging; contributions for additional platforms are welcome.)","title":"Supported Platforms"},{"location":"about/#whos-behind-it","text":"Himmelblau is created and primarily maintained by David Mulder , with key contributions from William Brown and support from SUSE engineers and a growing community of open-source contributors.","title":"Who\u2019s Behind It?"},{"location":"about/#get-involved","text":"We welcome contributors of all kinds \u2014 code, docs, packaging, testing, and real-world deployment feedback: Source & issues : Github Discuss / report bugs / request features : Open a GitHub issue or PR Sponsorship / support : Reach out to discuss enterprise needs, or sponsor the project .","title":"Get Involved"},{"location":"about/#license","text":"Himmelblau is released under the GPLv3 (or later) \u2014 ensuring the code remains free, auditable, and community-owned.","title":"License"},{"location":"architecture/","text":"Understanding Himmelblau Architecture Overview Himmelblau\u2019s architecture is modular, scalable, and designed to integrate deeply with both Linux system services and Microsoft Azure Entra ID. Its core components work together to authenticate users, manage tokens, provide session services, and bridge cloud-based identity with traditional POSIX environments. Key Components himmelblaud : Authentication Daemon The central daemon responsible for: Initiating and processing Entra Id authentication flows Requesting Primary Refresh Tokens (PRTs) and access tokens Managing token lifecycles: storage, renewal, expiration Securely communicating with other services via UNIX sockets Integrating with: PAM (authentication/account/session/password stacks) NSS (for user/group resolution) All authentication events funnel through himmelblaud , whether invoked via login, SSH, or user switching. himmelblau-broker : SSO Interface A DBus-based service that: Exposes authentication tokens to applications and browser plugins Supports automatic token refresh for SSO continuity Bridges the gap between system-level login and application-level authentication Used primarily in desktop environments or with SSO-capable CLI tools. himmelblaud-tasks : Background Worker This helper service performs actions that are triggered post-authentication: Requests cloud-based Kerberos TGTs and stores them in krb5cc caches Creates and initializes user home directories Enforces Intune policies (if enabled). It runs as a system service alongside himmelblaud . /etc/himmelblau/himmelblau.conf : Configuration File Defines the global and per-domain settings used by Himmelblau: Entra ID domain (automatically associated with the tenant) Logging and debugging options POSIX mapping preferences Allowed groups for login authorization Session environment behavior Example: [global] domain = example.com pam_allow_groups = 00000000-1111-2222-3333-444444444444 home_attr = CN use_etc_skel = true \ud83d\udcd8 See Also: The himmelblau.conf man page for detailed configuration options The aad-tool man page for command-line configuration and diagnostics","title":"Architecture"},{"location":"architecture/#understanding-himmelblau-architecture","text":"","title":"Understanding Himmelblau Architecture"},{"location":"architecture/#overview","text":"Himmelblau\u2019s architecture is modular, scalable, and designed to integrate deeply with both Linux system services and Microsoft Azure Entra ID. Its core components work together to authenticate users, manage tokens, provide session services, and bridge cloud-based identity with traditional POSIX environments.","title":"Overview"},{"location":"architecture/#key-components","text":"","title":"Key Components"},{"location":"architecture/#himmelblaud-authentication-daemon","text":"The central daemon responsible for: Initiating and processing Entra Id authentication flows Requesting Primary Refresh Tokens (PRTs) and access tokens Managing token lifecycles: storage, renewal, expiration Securely communicating with other services via UNIX sockets Integrating with: PAM (authentication/account/session/password stacks) NSS (for user/group resolution) All authentication events funnel through himmelblaud , whether invoked via login, SSH, or user switching.","title":"himmelblaud: Authentication Daemon"},{"location":"architecture/#himmelblau-broker-sso-interface","text":"A DBus-based service that: Exposes authentication tokens to applications and browser plugins Supports automatic token refresh for SSO continuity Bridges the gap between system-level login and application-level authentication Used primarily in desktop environments or with SSO-capable CLI tools.","title":"himmelblau-broker: SSO Interface"},{"location":"architecture/#himmelblaud-tasks-background-worker","text":"This helper service performs actions that are triggered post-authentication: Requests cloud-based Kerberos TGTs and stores them in krb5cc caches Creates and initializes user home directories Enforces Intune policies (if enabled). It runs as a system service alongside himmelblaud .","title":"himmelblaud-tasks: Background Worker"},{"location":"architecture/#etchimmelblauhimmelblauconf-configuration-file","text":"Defines the global and per-domain settings used by Himmelblau: Entra ID domain (automatically associated with the tenant) Logging and debugging options POSIX mapping preferences Allowed groups for login authorization Session environment behavior Example: [global] domain = example.com pam_allow_groups = 00000000-1111-2222-3333-444444444444 home_attr = CN use_etc_skel = true \ud83d\udcd8 See Also: The himmelblau.conf man page for detailed configuration options The aad-tool man page for command-line configuration and diagnostics","title":"/etc/himmelblau/himmelblau.conf: Configuration File"},{"location":"configuration/","text":"Configuration Overview Himmelblau is configured primarily through a single file: /etc/himmelblau/himmelblau.conf . This file controls authentication behavior, domain bindings, environment setup, policy enforcement, and more. This page also describes required system integration steps, including PAM and NSS configuration. Config File: /etc/himmelblau/himmelblau.conf To enable authentication, you must configure the domain option in the /etc/himmelblau/himmelblau.conf file. This setting determines which tenant/domain is permitted to authenticate to the host. You SHOULD specify the primary domain for the tenant. All other configuration options are optional. Format The file uses an INI-like syntax with support for [global] and per-domain sections: [global] domain = example.com [example.com] app_id = 00000000-1111-2222-3333-444444444444 Key Options Key Description domain The allowed Entra ID domain pam_allow_groups Group object IDs and user UPNs allowed to authenticate enable_hello Enables Linux Hello PIN support Note: Leaving the pam_allow_groups option unset in the /etc/himmelblau/himmelblau.conf file permits all users to authenticate . Note: On Ubuntu, you should additionally set use_etc_skel to true and configure home_attr and home_alias to match (I recommend using the CN or SPN attributes). These parameters are necessary, otherwise Ubuntu's snaps will fail to execute. These settings are set by default using the Himmelblau project Debian/Ubuntu packages. [global] home_attr = CN home_alias = CN use_etc_skel = true Refer to the himmelblau.conf man page for a full list of options. \u26a0\ufe0f Important : To enable hardware-backed security, you must configure TPM support before authenticating or enrolling this device . It is disabled by default. Learn how to configure TPM \u00bb . PAM Configuration To allow users to authenticate with Azure Entra ID, Himmelblau must be integrated into your system\u2019s PAM (Pluggable Authentication Module) stack. This directs authentication requests to the pam_himmelblau.so module. Preferred Configuration Methods Use one of the following automated tools to insert Himmelblau into the appropriate PAM files. Ubuntu / Debian: sudo pam-auth-update Then check the box labeled Azure authentication . openSUSE / Tumbleweed: sudo pam-config --add --himmelblau All systems (manual file editing): sudo aad-tool configure-pam This directly modifies PAM config files such as: /etc/pam.d/common-auth \u2139\ufe0f This tool is safe to use as a starting point, and allows fine-grained control later if needed. Manual Configuration (Advanced) If the above tools don\u2019t produce the desired result or you require precise control over module ordering and behavior, you may manually edit your PAM stack. Guidelines: Place pam_himmelblau.so after pam_localuser.so If using Linux Hello or Passwordless, place Himmelblau before pam_unix.so to avoid password prompts Always include ignore_unknown_user Ensure pam_deny.so is placed last Example: /etc/pam.d/common-auth auth required pam_env.so auth [default=1 ignore=ignore success=ok] pam_localuser.so auth sufficient pam_unix.so nullok try_first_pass auth sufficient pam_himmelblau.so ignore_unknown_user auth required pam_deny.so \ud83d\udca1 For Passwordless login, move pam_himmelblau.so above pam_unix.so in the pam auth stack to avoid fallback password prompts. Example: /etc/pam.d/common-account account [default=1 ignore=ignore success=ok] pam_localuser.so account sufficient pam_unix.so account sufficient pam_himmelblau.so ignore_unknown_user account required pam_deny.so Example: /etc/pam.d/common-session session optional pam_systemd.so session required pam_limits.so session optional pam_unix.so try_first_pass session optional pam_umask.so session optional pam_himmelblau.so session optional pam_env.so Example: /etc/pam.d/common-password password sufficient pam_himmelblau.so ignore_unknown_user password optional pam_gnome_keyring.so use_authtok password sufficient pam_unix.so use_authtok nullok shadow try_first_pass password required pam_deny.so NSS Configuration To ensure system tools can resolve Entra ID users and groups: Edit /etc/nsswitch.conf Find the passwd and group lines and modify them to include himmelblau , for example: passwd: files himmelblau group: files himmelblau Disabling Linux Hello PIN Linux Hello authentication is enabled by default. To disable it: [global] enable_hello = false Debug Logging Enable debug logs for troubleshooting: [global] debug = true Logs are written to: journalctl -u himmelblaud -u himmelblaud-tasks","title":"Configuration"},{"location":"configuration/#configuration","text":"","title":"Configuration"},{"location":"configuration/#overview","text":"Himmelblau is configured primarily through a single file: /etc/himmelblau/himmelblau.conf . This file controls authentication behavior, domain bindings, environment setup, policy enforcement, and more. This page also describes required system integration steps, including PAM and NSS configuration.","title":"Overview"},{"location":"configuration/#config-file-etchimmelblauhimmelblauconf","text":"To enable authentication, you must configure the domain option in the /etc/himmelblau/himmelblau.conf file. This setting determines which tenant/domain is permitted to authenticate to the host. You SHOULD specify the primary domain for the tenant. All other configuration options are optional.","title":"Config File: /etc/himmelblau/himmelblau.conf"},{"location":"configuration/#format","text":"The file uses an INI-like syntax with support for [global] and per-domain sections: [global] domain = example.com [example.com] app_id = 00000000-1111-2222-3333-444444444444","title":"Format"},{"location":"configuration/#key-options","text":"Key Description domain The allowed Entra ID domain pam_allow_groups Group object IDs and user UPNs allowed to authenticate enable_hello Enables Linux Hello PIN support Note: Leaving the pam_allow_groups option unset in the /etc/himmelblau/himmelblau.conf file permits all users to authenticate . Note: On Ubuntu, you should additionally set use_etc_skel to true and configure home_attr and home_alias to match (I recommend using the CN or SPN attributes). These parameters are necessary, otherwise Ubuntu's snaps will fail to execute. These settings are set by default using the Himmelblau project Debian/Ubuntu packages. [global] home_attr = CN home_alias = CN use_etc_skel = true Refer to the himmelblau.conf man page for a full list of options. \u26a0\ufe0f Important : To enable hardware-backed security, you must configure TPM support before authenticating or enrolling this device . It is disabled by default. Learn how to configure TPM \u00bb .","title":"Key Options"},{"location":"configuration/#pam-configuration","text":"To allow users to authenticate with Azure Entra ID, Himmelblau must be integrated into your system\u2019s PAM (Pluggable Authentication Module) stack. This directs authentication requests to the pam_himmelblau.so module.","title":"PAM Configuration"},{"location":"configuration/#preferred-configuration-methods","text":"Use one of the following automated tools to insert Himmelblau into the appropriate PAM files. Ubuntu / Debian: sudo pam-auth-update Then check the box labeled Azure authentication . openSUSE / Tumbleweed: sudo pam-config --add --himmelblau All systems (manual file editing): sudo aad-tool configure-pam This directly modifies PAM config files such as: /etc/pam.d/common-auth \u2139\ufe0f This tool is safe to use as a starting point, and allows fine-grained control later if needed.","title":"Preferred Configuration Methods"},{"location":"configuration/#manual-configuration-advanced","text":"If the above tools don\u2019t produce the desired result or you require precise control over module ordering and behavior, you may manually edit your PAM stack. Guidelines: Place pam_himmelblau.so after pam_localuser.so If using Linux Hello or Passwordless, place Himmelblau before pam_unix.so to avoid password prompts Always include ignore_unknown_user Ensure pam_deny.so is placed last","title":"Manual Configuration (Advanced)"},{"location":"configuration/#example-etcpamdcommon-auth","text":"auth required pam_env.so auth [default=1 ignore=ignore success=ok] pam_localuser.so auth sufficient pam_unix.so nullok try_first_pass auth sufficient pam_himmelblau.so ignore_unknown_user auth required pam_deny.so \ud83d\udca1 For Passwordless login, move pam_himmelblau.so above pam_unix.so in the pam auth stack to avoid fallback password prompts.","title":"Example: /etc/pam.d/common-auth"},{"location":"configuration/#example-etcpamdcommon-account","text":"account [default=1 ignore=ignore success=ok] pam_localuser.so account sufficient pam_unix.so account sufficient pam_himmelblau.so ignore_unknown_user account required pam_deny.so","title":"Example: /etc/pam.d/common-account"},{"location":"configuration/#example-etcpamdcommon-session","text":"session optional pam_systemd.so session required pam_limits.so session optional pam_unix.so try_first_pass session optional pam_umask.so session optional pam_himmelblau.so session optional pam_env.so","title":"Example: /etc/pam.d/common-session"},{"location":"configuration/#example-etcpamdcommon-password","text":"password sufficient pam_himmelblau.so ignore_unknown_user password optional pam_gnome_keyring.so use_authtok password sufficient pam_unix.so use_authtok nullok shadow try_first_pass password required pam_deny.so","title":"Example: /etc/pam.d/common-password"},{"location":"configuration/#nss-configuration","text":"To ensure system tools can resolve Entra ID users and groups: Edit /etc/nsswitch.conf Find the passwd and group lines and modify them to include himmelblau , for example: passwd: files himmelblau group: files himmelblau","title":"NSS Configuration"},{"location":"configuration/#disabling-linux-hello-pin","text":"Linux Hello authentication is enabled by default. To disable it: [global] enable_hello = false","title":"Disabling Linux Hello PIN"},{"location":"configuration/#debug-logging","text":"Enable debug logs for troubleshooting: [global] debug = true Logs are written to: journalctl -u himmelblaud -u himmelblaud-tasks","title":"Debug Logging"},{"location":"ecosystem/","text":"The Himmelblau Ecosystem Overview Himmelblau is more than just a login module \u2014 it\u2019s a full ecosystem for managing identity integration between Azure Entra ID and Linux systems. Core Features and Benefits Azure Entra ID Integration Himmelblau supports modern Azure Entra ID authentication flows: OAuth2 authorization with MS-OAPX and OAPXBC extensions Primary Refresh Token (PRT) issuance and renewal Support for multi-factor authentication (MFA), including: Microsoft Authenticator FIDO2 hardware keys One-time passwords via SMS Temporary Access Pass Secure Token Storage and Device Registration All credentials and issued tokens are stored in encrypted, machine-bound storage SoftHSM and TPM backends are supported Seamless device registration with Azure Entra ID during first login Kerberos Support Himmelblau retrieves and caches Ticket Granting Tickets (TGTs) from Azure\u2019s cloud KDC, enabling: Secure SSO access to Kerberos-based applications Hybrid workflows that combine cloud and on-prem AD Kerberos services Single Sign-On (SSO) Via integration with Siemens' linux-entra-sso , Himmelblau enables: Firefox/Chrome Browser SSO for Microsoft 365 and Entra ID\u2013protected apps Secure, refreshable token storage for long-lived sessions Supported Linux Distributions Himmelblau supports a broad range of Linux distributions, including: Enterprise-focused: SUSE Linux Enterprise (SLE) Red Hat Enterprise Linux (RHEL) Rocky Linux Community-driven: Ubuntu Debian Fedora openSUSE NixOS Interoperability with Microsoft Services By emulating Windows authentication flows and integrating directly with Microsoft APIs, Himmelblau enables Linux clients to: Authenticate to Microsoft 365 services (Exchange, SharePoint, Teams) Access Azure-based applications protected by Entra ID Conditional Access Report device state and compliance to Microsoft Intune (optional) Function in hybrid environments with both on-prem and cloud resources","title":"Ecosystem"},{"location":"ecosystem/#the-himmelblau-ecosystem","text":"","title":"The Himmelblau Ecosystem"},{"location":"ecosystem/#overview","text":"Himmelblau is more than just a login module \u2014 it\u2019s a full ecosystem for managing identity integration between Azure Entra ID and Linux systems.","title":"Overview"},{"location":"ecosystem/#core-features-and-benefits","text":"","title":"Core Features and Benefits"},{"location":"ecosystem/#azure-entra-id-integration","text":"Himmelblau supports modern Azure Entra ID authentication flows: OAuth2 authorization with MS-OAPX and OAPXBC extensions Primary Refresh Token (PRT) issuance and renewal Support for multi-factor authentication (MFA), including: Microsoft Authenticator FIDO2 hardware keys One-time passwords via SMS Temporary Access Pass","title":"Azure Entra ID Integration"},{"location":"ecosystem/#secure-token-storage-and-device-registration","text":"All credentials and issued tokens are stored in encrypted, machine-bound storage SoftHSM and TPM backends are supported Seamless device registration with Azure Entra ID during first login","title":"Secure Token Storage and Device Registration"},{"location":"ecosystem/#kerberos-support","text":"Himmelblau retrieves and caches Ticket Granting Tickets (TGTs) from Azure\u2019s cloud KDC, enabling: Secure SSO access to Kerberos-based applications Hybrid workflows that combine cloud and on-prem AD Kerberos services","title":"Kerberos Support"},{"location":"ecosystem/#single-sign-on-sso","text":"Via integration with Siemens' linux-entra-sso , Himmelblau enables: Firefox/Chrome Browser SSO for Microsoft 365 and Entra ID\u2013protected apps Secure, refreshable token storage for long-lived sessions","title":"Single Sign-On (SSO)"},{"location":"ecosystem/#supported-linux-distributions","text":"Himmelblau supports a broad range of Linux distributions, including: Enterprise-focused: SUSE Linux Enterprise (SLE) Red Hat Enterprise Linux (RHEL) Rocky Linux Community-driven: Ubuntu Debian Fedora openSUSE NixOS","title":"Supported Linux Distributions"},{"location":"ecosystem/#interoperability-with-microsoft-services","text":"By emulating Windows authentication flows and integrating directly with Microsoft APIs, Himmelblau enables Linux clients to: Authenticate to Microsoft 365 services (Exchange, SharePoint, Teams) Access Azure-based applications protected by Entra ID Conditional Access Report device state and compliance to Microsoft Intune (optional) Function in hybrid environments with both on-prem and cloud resources","title":"Interoperability with Microsoft Services"},{"location":"installation/","text":"Installing Himmelblau Overview Himmelblau is packaged for a wide range of Linux distributions and supports multiple installation methods, including .deb and .rpm packages, container builds, and manual source compilation. This page covers how to install Himmelblau on Ubuntu, Debian, RHEL, Rocky, SUSE, and other distributions. Supported Distributions The following distributions are currently packaged by the Himmelblau project: Distribution Version Fedora 41 Fedora 42 Fedora 43 Fedora Rawhide Rocky Linux 8 Rocky Linux 9 Rocky Linux 10 Red Hat Enterprise Linux 8 Red Hat Enterprise Linux 9 Red Hat Enterprise Linux 10 Oracle Linux 8 Oracle Linux 9 Oracle Linux 10 SUSE Linux Enterprise 15 SP6 SUSE Linux Enterprise 15 SP7 SUSE Linux Enterprise 16 openSUSE Leap 15.6 openSUSE Leap 16 openSUSE Tumbleweed Debian 12 Debian 13 Ubuntu 22.04 Ubuntu 24.04 Linux Mint 21.3 Linux Mint 22 NixOS Installation Prebuilt Packages (Recommended) Himmelblau provides prebuilt packages for all major Linux distributions \u2014 including Debian, Ubuntu, Fedora, Rocky Linux, RHEL, openSUSE Leap, SLE, and NixOS \u2014 via our official build server. \u27a1\ufe0f Visit the Downloads page to: Select your distribution and release channel (Stable / Nightly) View the correct repository setup commands for your system Copy one-click install instructions for your package manager ( apt , dnf , or zypper ) This is the recommended installation method for production systems and most users. The downloads page is always kept in sync with the latest release metadata on packages.himmelblau-idm.org . Building from Source (Advanced / Developer Use) If you prefer to build Himmelblau locally \u2014 for testing, development, or packaging validation \u2014 use the included Makefile . The build system automatically detects your host distribution and uses either Podman or Docker for reproducible container builds. Steps 1. Clone the repository: git clone https://github.com/himmelblau-idm/himmelblau cd himmelblau 2. Build packages: make # auto-detects host distro and builds matching packages or build explicitly for a target: make ubuntu24.04 # or debian13, rocky9, sle16, etc. Run make help for the full list of available targets. 3. Install on your current host: sudo make install This installs the locally built packages using the native package manager (apt / dnf / zypper). Need another distro? If your environment isn\u2019t listed on the Supported Distributions table, please open an issue or contact a maintainer \u2014 we\u2019re happy to help add new targets.","title":"Installation"},{"location":"installation/#installing-himmelblau","text":"","title":"Installing Himmelblau"},{"location":"installation/#overview","text":"Himmelblau is packaged for a wide range of Linux distributions and supports multiple installation methods, including .deb and .rpm packages, container builds, and manual source compilation. This page covers how to install Himmelblau on Ubuntu, Debian, RHEL, Rocky, SUSE, and other distributions.","title":"Overview"},{"location":"installation/#supported-distributions","text":"The following distributions are currently packaged by the Himmelblau project: Distribution Version Fedora 41 Fedora 42 Fedora 43 Fedora Rawhide Rocky Linux 8 Rocky Linux 9 Rocky Linux 10 Red Hat Enterprise Linux 8 Red Hat Enterprise Linux 9 Red Hat Enterprise Linux 10 Oracle Linux 8 Oracle Linux 9 Oracle Linux 10 SUSE Linux Enterprise 15 SP6 SUSE Linux Enterprise 15 SP7 SUSE Linux Enterprise 16 openSUSE Leap 15.6 openSUSE Leap 16 openSUSE Tumbleweed Debian 12 Debian 13 Ubuntu 22.04 Ubuntu 24.04 Linux Mint 21.3 Linux Mint 22 NixOS","title":"Supported Distributions"},{"location":"installation/#installation","text":"","title":"Installation"},{"location":"installation/#prebuilt-packages-recommended","text":"Himmelblau provides prebuilt packages for all major Linux distributions \u2014 including Debian, Ubuntu, Fedora, Rocky Linux, RHEL, openSUSE Leap, SLE, and NixOS \u2014 via our official build server. \u27a1\ufe0f Visit the Downloads page to: Select your distribution and release channel (Stable / Nightly) View the correct repository setup commands for your system Copy one-click install instructions for your package manager ( apt , dnf , or zypper ) This is the recommended installation method for production systems and most users. The downloads page is always kept in sync with the latest release metadata on packages.himmelblau-idm.org .","title":"Prebuilt Packages (Recommended)"},{"location":"installation/#building-from-source-advanced-developer-use","text":"If you prefer to build Himmelblau locally \u2014 for testing, development, or packaging validation \u2014 use the included Makefile . The build system automatically detects your host distribution and uses either Podman or Docker for reproducible container builds.","title":"Building from Source (Advanced / Developer Use)"},{"location":"installation/#steps","text":"","title":"Steps"},{"location":"installation/#1-clone-the-repository","text":"git clone https://github.com/himmelblau-idm/himmelblau cd himmelblau","title":"1. Clone the repository:"},{"location":"installation/#2-build-packages","text":"make # auto-detects host distro and builds matching packages or build explicitly for a target: make ubuntu24.04 # or debian13, rocky9, sle16, etc. Run make help for the full list of available targets.","title":"2. Build packages:"},{"location":"installation/#3-install-on-your-current-host","text":"sudo make install This installs the locally built packages using the native package manager (apt / dnf / zypper).","title":"3. Install on your current host:"},{"location":"installation/#need-another-distro","text":"If your environment isn\u2019t listed on the Supported Distributions table, please open an issue or contact a maintainer \u2014 we\u2019re happy to help add new targets.","title":"Need another distro?"},{"location":"integration/","text":"Transitioning from On-Prem AD to Azure Entra ID When migrating from traditional Active Directory (AD) to Azure Entra ID, preserving existing UID and GID values is crucial for Linux systems. Himmelblau 1.0 and newer provides support for POSIX attribute migration and identity mapping via the aad-tool utility. Migration Paths for UID/GID Preservation Himmelblau offers two strategies for UID/GID migration, depending on whether you want globally consistent attributes or host-specific mappings. 1. Sync POSIX Attributes to Entra ID (Recommended) Use aad-tool user set-posix-attrs and aad-tool group set-posix-attrs to store UID/GID values directly on Entra ID objects via directory schema extensions. These values are then consistently available across all Entra ID\u2013joined Linux systems. You have two options for getting POSIX attributes into Entra ID: Option A: If your users already have uidNumber , gidNumber , or unixHomeDirectory values in on-prem Active Directory, you can sync them to Entra ID using Entra Connect Sync . Option B: Manually register schema extensions and assign POSIX attributes using aad-tool . To manually register and assign: Add the schema extensions: aad-tool application add-schema-extensions \\ --client-id <SCHEMA_CLIENT_ID> \\ --schema-app-object-id <APPLICATION_OBJECT_ID> Set attributes on users or groups: aad-tool user set-posix-attrs \\ --schema-client-id <SCHEMA_CLIENT_ID> \\ --user-id <USER_OBJECT_ID> \\ --uid <UID> \\ --gid <GID> \\ --home /home/example \\ --shell /bin/bash \ud83d\udca1 POSIX attributes stored in Entra ID can be retrieved at login time, even before authentication completes \u2014 if Himmelblau is configured with Confidential Client Credentials. Using Confidential Client Credentials To enable early attribute lookup (e.g., uidNumber , gidNumber ) before login: Use aad-tool cred secret or aad-tool cred cert to configure confidential client authentication: # Using a client secret aad-tool cred secret \\ --client-id <APP_ID> \\ --domain <YOUR_DOMAIN> \\ --secret <SECRET_VALUE> # Or using a self-signed client certificate aad-tool cred cert \\ --client-id <APP_ID> \\ --domain <YOUR_DOMAIN> \\ --valid-days 365 \\ --cert-out /tmp/my-cert.pem These credentials allow Himmelblau to authenticate securely and perform Graph API lookups before any user logs in. Pre-Caching POSIX Attributes (Optional) If you haven\u2019t configured confidential client credentials, UID/GID attributes won\u2019t be available until after login. To avoid this, you can pre-cache attribute mappings using: aad-tool enumerate This command fetches all users and groups with POSIX attributes from Entra ID and stores them locally for use during authentication. \u26a0\ufe0f aad-tool enumerate only works on devices that are already Entra ID\u2013joined, and where the calling user has delegated Graph API access. 2. Use Static ID Mapping (Host-Specific) If UID/GID mappings vary by system or cannot be stored in Entra ID, use the static ID map cache instead: aad-tool idmap user-add --name user@domain --uid 10001 --gid 100 aad-tool idmap group-add --name group@domain --gid 100 These mappings are stored locally and applied consistently on the host during lookup. \u26a0\ufe0f This approach is best used when global consistency is not feasible.","title":"Migration from On-Prem"},{"location":"integration/#transitioning-from-on-prem-ad-to-azure-entra-id","text":"When migrating from traditional Active Directory (AD) to Azure Entra ID, preserving existing UID and GID values is crucial for Linux systems. Himmelblau 1.0 and newer provides support for POSIX attribute migration and identity mapping via the aad-tool utility.","title":"Transitioning from On-Prem AD to Azure Entra ID"},{"location":"integration/#migration-paths-for-uidgid-preservation","text":"Himmelblau offers two strategies for UID/GID migration, depending on whether you want globally consistent attributes or host-specific mappings.","title":"Migration Paths for UID/GID Preservation"},{"location":"integration/#1-sync-posix-attributes-to-entra-id-recommended","text":"Use aad-tool user set-posix-attrs and aad-tool group set-posix-attrs to store UID/GID values directly on Entra ID objects via directory schema extensions. These values are then consistently available across all Entra ID\u2013joined Linux systems. You have two options for getting POSIX attributes into Entra ID: Option A: If your users already have uidNumber , gidNumber , or unixHomeDirectory values in on-prem Active Directory, you can sync them to Entra ID using Entra Connect Sync . Option B: Manually register schema extensions and assign POSIX attributes using aad-tool . To manually register and assign: Add the schema extensions: aad-tool application add-schema-extensions \\ --client-id <SCHEMA_CLIENT_ID> \\ --schema-app-object-id <APPLICATION_OBJECT_ID> Set attributes on users or groups: aad-tool user set-posix-attrs \\ --schema-client-id <SCHEMA_CLIENT_ID> \\ --user-id <USER_OBJECT_ID> \\ --uid <UID> \\ --gid <GID> \\ --home /home/example \\ --shell /bin/bash \ud83d\udca1 POSIX attributes stored in Entra ID can be retrieved at login time, even before authentication completes \u2014 if Himmelblau is configured with Confidential Client Credentials.","title":"1. Sync POSIX Attributes to Entra ID (Recommended)"},{"location":"integration/#using-confidential-client-credentials","text":"To enable early attribute lookup (e.g., uidNumber , gidNumber ) before login: Use aad-tool cred secret or aad-tool cred cert to configure confidential client authentication: # Using a client secret aad-tool cred secret \\ --client-id <APP_ID> \\ --domain <YOUR_DOMAIN> \\ --secret <SECRET_VALUE> # Or using a self-signed client certificate aad-tool cred cert \\ --client-id <APP_ID> \\ --domain <YOUR_DOMAIN> \\ --valid-days 365 \\ --cert-out /tmp/my-cert.pem These credentials allow Himmelblau to authenticate securely and perform Graph API lookups before any user logs in.","title":"Using Confidential Client Credentials"},{"location":"integration/#pre-caching-posix-attributes-optional","text":"If you haven\u2019t configured confidential client credentials, UID/GID attributes won\u2019t be available until after login. To avoid this, you can pre-cache attribute mappings using: aad-tool enumerate This command fetches all users and groups with POSIX attributes from Entra ID and stores them locally for use during authentication. \u26a0\ufe0f aad-tool enumerate only works on devices that are already Entra ID\u2013joined, and where the calling user has delegated Graph API access.","title":"Pre-Caching POSIX Attributes (Optional)"},{"location":"integration/#2-use-static-id-mapping-host-specific","text":"If UID/GID mappings vary by system or cannot be stored in Entra ID, use the static ID map cache instead: aad-tool idmap user-add --name user@domain --uid 10001 --gid 100 aad-tool idmap group-add --name group@domain --gid 100 These mappings are stored locally and applied consistently on the host during lookup. \u26a0\ufe0f This approach is best used when global consistency is not feasible.","title":"2. Use Static ID Mapping (Host-Specific)"},{"location":"introduction/","text":"A Practical Introduction to Himmelblau by Stefan Kania Himmelblau is an open-source authentication framework that provides Microsoft's Azure Entra ID login for Linux systems. Its seamless and simple installation makes it easy to integrate Linux systems into Azure Entra ID and Intune. Both the enforcement of configured policies and Hello PIN support are provided for Linux systems. Himmelblau also offers support for Office 365 single sign-on (SSO) and multi-factor authentication (MFA). Debian, Suse, and RedHat distributions are supported. Technical details Azure Entra ID was formerly known as Azure Active Directory and manages all user login data in the cloud. There are no longer any local domain controllers; all login information is managed centrally in the cloud. Clients no longer need to be explicitly added to the domain; a client is added when any user logs in for the first time. However, unlike a local login to a local Active Directory, a user registration is only valid on the client on which the user has registered. If a user wants to use a different client, they must first re-register there. To do this, they always need their Entra ID password, which they generated when they first logged in. However, users can generate different PINs on each client. An administrator can also require PINs of different lengths for different clients. Azure Entra ID is initially only a service for authentication on Windows clients. It is only through the development of Himmelblau that users with Linux clients can also authenticate with their Intra ID. This requires the authentication processes developed by Microsoft to be implemented on Linux. The extent of the problem that arises can be described here based on the very first login of a new user to a new client: When an administrator hands a user a laptop configured with Himmelblau and the user wants to log in from this device for the first time, this is possible. The only problem is that they have to authenticate with a DAG (Device Authorization Grant). Anyone who has ever authenticated with a video service such as Netflix is already familiar with this DAG authentication. With a DAG, the user is shown a code and a URL, and authentication with this information must then be performed from another device. User\u2019s MFA status Device state DAG needed? Notes MFA already set up Unjoined new device No User signs in with normal MFA; join/enroll proceeds. MFA not set up (brand new user) Unjoined new device Yes Use DAG once; then complete MFA setup after login. With Himmelblau, this is a little more complicated. For the user, the process is almost transparent. With Himmelblau, it is not possible to register a real Hello key with DAG authentication (Microsoft prohibits this). Himmelblau therefore sets up a so-called \"disconnected\" Hello PIN. This Hello PIN is cryptographically secure, but Himmelblau cannot request new Entra ID credentials in this way, only update existing credentials (a regular Hello key registered with MFA can do both). Himmelblau's offline login and SSO strategy is slightly less effective when the user authenticates in this way. The user will probably not notice this particularly, but they may have to re-authenticate via the DAG every few weeks to maintain their SSO. If a user changes their temporary password and sets up MFA from another client first, none of this is necessary, but it does require a client already integrated into Azure for the user's initial authentication. One way to circumvent all this is to support a so-called Temporary Access Pass (TAP). This is a concept developed by Microsoft. A TAP is valid for a limited number of uses or for a limited period of time. These can be issued by an administrator so that a user can register with Himmelblau using a Hello PIN. With this method, the user never has Entra ID credentials except those that are exclusively linked to that specific host. From that point on, users authenticate with their device PIN. This PIN grants users MFA SSO in the browser. However, users do not have the option of using this Entra ID to authenticate on another client. The key point here is that a user must have MFA configured before they can register their device with Entra ID. Technically speaking, this is not a mandatory requirement from Microsoft, but a restriction imposed by Himmelblau. The reason is that Microsoft sometimes requires MFA for device registration and sometimes does not. Instead of trying to accommodate both situations, Himmelblau always requires MFA. At least for device registration. For the registration of additional users, authentication with password only can then also be enabled as an option. Core features and benefits Himmelblau supports modern Azure Entra ID authentication workflows: OAuth2 authorization with MS-OAPX and OAPXBC extensions Issuance and renewal of Primary Refresh Tokens (PRT) Support for multi-factor authentication (MFA), including: Microsoft Authenticator FIDO2 hardware keys One-time passwords via SMS Temporary access pass Secure token storage and device registration SoftHSM and TPM backends are supported All login data and issued tokens are stored in encrypted, machine-bound memory. Seamless device registration with Azure Entra ID during initial login, eliminating the need to join a domain. When the first user logs in to a client, the client is automatically added to the domain. Through integration with Siemens' linux-entra-sso, Himmelblau enables: Firefox, Chrome and Microsoft Edge browser SSO for Microsoft 365 and Entra ID-protected applications Secure, updatable token storage for long-lived sessions Himmelblau is available for almost all major distributions. The current version 2.0 is also available for Debian 13. The following distributions are supported: Distribution Version Debian 12 + 13 Fedora 42 + 43 Fedora Rawhide Linux Mint 21.3 + 22 openSUSE 15.6 openSUSE 16 openSUSE Tumbleweed Oracle Linux 9 + 10 RHEL 9 + 10 Rocky Linux 9 + 10 SUSE Linux Enterprise 15 SP6 + SP7 SUSE Linux Enterprise 16 Ubuntu 22.04 + 24.04 NixOS In the first part, a Linux system without a graphical user interface is set up. For the distributions listed in the table here, there are repositories available at https://himmelblau-idm.org/downloads/index.html. Himmelblau consists of a total of eight packages: himmelblau_<version><distribution> himmelblau-sshd-config_<version><distribution> himmelblau-sso_<version><distribution> nss-himmelblau_<version><distribution> pam-himmelblau_<version><distribution> himmelblau-qr-greeter_<version><distribution> cirrus-scope_<version><distribution> himmelblau-selinux_<version><distribution> o365_<version><distribution> The cirrus-scope package is a package for debugging authentication between Azure Entra Id and the Himmelblau Library. It is not required for normal use. The o365 package integrates Microsoft Office desktop applications (Teams, Outlook, Word, Excel, PowerPoint, etc.) into Linux. These applications use taskbar icons to manage their background processes and quick access menus. All Microsoft o365 applications are displayed in the application menu after installing the package. Starting with version 2.0 for some distributions ther will be a special selinux package available. Installation and setup of the packages To test the login for the first time, a Linux client without a graphical user interface is sufficient. Only the packages: himmelblau_<version><distribution> pam-himmelblau_<version><distribution> nss-himmelblau_<version><distribution himmelblau-sshd-config_<version><distribution> are installed for this purpose. The himmelblau-sshd-config package is only required if login via SSH on the client is to be possible. After installing the packages, distributions based on Red Hat and SUSE require some manual work for integration into PAM. For all supported distributions based on Debian, all necessary PAM entries are made automatically. On Debian systems, the Himmelblau entries are made in the common- files in the /etc/pam.d/ directory. On Suse systems, it is necessary to customize the PAM system with the command sudo pam-config --add --himmelblau . For all other distributions, the command aad-tool configure-pam can be used. The aad-tool command is part of the Himmelblau packages. To also allow users to access via SSH using the PIN, it is necessary to adjust the line from Listing 1 in the file /etc/pam.d/common-auth: --------- Listing 1------- auth [success=2 default=ignore] pam_himmelblau.so ignore_unknown_user mfa_poll_prompt ---------------------------- Without this adjustment, the password will always be requested instead of the PIN. The option mfa_poll_prompt is only needed if a distribution is usesd with an unfixed patch of OpenSSH. In Ubuntu and openSUSE OpenSSH isd already patched. To access a Linux client via SSH, you also need to adjust the SSH configuration. To do this, create the file /etc/ssh/sshd_config.d/himmelblau.conf with the content from Listing 2: ----- Listing 2 ----------- KbdInteractiveAuthentication yes ---------------------------- Then restart the SSH service. To enable the Linux system to access the user database, the file /etc/nsswitch.conf must now be adjusted. Listing 2 shows the adjustments: ------- Listing 3 ------- passwd: files systemd himmelblau group: files systemd himmelblau shadow: files systemd himmelblau ------------------------- If the packages from the original URL are used, these entries are also generated automatically. The only thing missing is the domain at which users should log in on the client. To do this, the configuration of Himmelblau is adjusted in the file /etc/himmelblau/himmelblau.conf. Listing 4 shows the change in the file: ------- Listing 4 -------- domain=example.onmicrosoft.com --------------------------- Only the name of your own domain is required. All other settings can be adopted for the time being. Anyone who has already gained experience with Entra ID and Microsoft clients will be surprised by this entry, because with a Windows client, the name of the domain is determined from the user's UPN when they log in, which does not yet work with Himmelblau. After configuring Himmelblau, it is still necessary to start the two services himmelblaud and himmelblaud-tasks and activate them permanently. Only then can the first login be performed. Listing 5 shows how to start the services: ----------- Listing 5 --------- systemctl enable --now himmelblaud himmelblaud-tasks -------------------------------- The first login of a new user After the user has been created in the Azure portal and assigned an initial password, the user can log in with the new account and the initial password. Listing 6 shows the first login of a new user on a Linux client integrated into the domain -------Listing 6 ---- ssh user02@192.168.56.81 (user02@192.168.56.81) Use the password for your Office 365 or Microsoft online login. Entra Id Password: <initial password> (user02@192.168.56.81) To sign in, use a web browser to open the page https/microsoft.codevicelogin and enter the code DG94ZUCB2 to authenticate. Press enter to continue ------------ The new user must always log in via a browser using the URL listed in Listing 6 the first time. This is because two-factor authentication and a password change are still required. Registration is only performed once; if the user wants to log in to another system later, these steps are no longer necessary. When logging in via the browser, the code generated in the command line is required. Only after entering the code does the actual login take place. The user logs in with their full name, in this case user02@example.onmicrosoft.com . The initial password is required again here and must be changed in the next step. This is followed by a note on setting up two-factor authentication. Here you can use any app, such as Google Authenticator or Microsoft Authenticator. Microsoft Authenticator has the advantage that the user can later log in directly in the app with a two-digit number. However, the user can also change which app is used later. This is followed by instructions on how to use the app and a link to install it. Once the user has installed the app on their smartphone, they can continue with the setup. In this example, Microsoft Authenticator is used, which is why the setup instructions are provided here. After another window with additional instructions, a window with a QR code appears, which is scanned using the app. Only when the account has been entered correctly in the app can the user click on CONTINUE. The following test checks whether the setup was successful. To perform the test, the user must enter the two-digit number in their app. Only if the number is correct will the next screen appear with confirmation of the setup. Please note: This test is only performed if Microsoft Authenticator is used; Google Authenticator cannot perform this two-factor verification with a two-digit number. Finally, the successful first login is summarized and displayed again. If the app needs to be changed later, the user can do this themselves via the URL https://mysignins.microsoft.com/security-info. After completing the setup, the first login (here via ssh) to the Linux client follows. However, it is also possible to log in directly to a client integrated in Azure. Even when logging in locally on the client, it is sufficient to specify the CN (the CN is the part before the @ in the UPN); it is not necessary to specify the full name (User Principle Name (UPN)). The name is resolved via NSS, because himmelblau is entered there as the authentication source. Note: To make user logins unique, care should be taken to ensure that there are no local users with the same name in the domain. Listing 7 shows the first login attempt after setting up two-factor authentication: --------------Listing 7 --------------- ssh user02@192.168.56.81 (user02@192.168.56.81) Use the password for your Office 365 or Microsoft online login. Entra Id Password: (user02@192.168.56.81) Open your Authenticator app, and enter the number '11' to sign in. No push? Check your mobile device's internet connection. Press enter to continue (user02@192.168.56.81) Set up a PIN A Hello PIN is a fast, secure way to sign in to your device, apps, and services. The minimum PIN length is 6 characters. New PIN: (user02@192.168.56.81) Set up a PIN A Hello PIN is a fast, secure way to sign in to your device, apps, and services. The minimum PIN length is 6 characters. Confirm PIN: Enrolling the Hello PIN. Please wait... Enrolling the Hello PIN. Please wait... ... user02@himmelblau:~$ ----------------------------- When you log in to the console for the first time, you will be asked to enter your new password again. If the password is correct, a two-digit number (11 in the example) will be displayed here, which you then enter in the app. Only when this number has been verified by the app will the system generate a new Hello PIN, which will then be used later to log in instead of the password. When logging in for the first time, a $HOME directory is always created for the user. This part of the login must be performed by the user on every new Linux client on which the user logs in for the first time. However, the user can use the same PIN for each client. The system does not check whether the PIN is already being used on another client. This would not be possible anyway, as the information is encrypted on the client. For each subsequent login, only the PIN is now required, regardless of whether it is a local login or a login via ssh. Listing 8 shows another login using the PIN: -------------Listing 8 -------------- ssh user02@192.168.56.81 (user02@192.168.56.81) Use the Linux Hello PIN for this device. PIN: ... user02@himmelblau:~$ --------------------------- The Linux client What happens on the Linux client when it is integrated into Azure? During setup, Himmelblau was entered into the /etc/nsswitch.conf file. Now the domain specified in the configuration is searched for users and groups. The identity of the user can also be queried with the command id or getent passwd . Listing 10 shows the information for the user just set up: ------------ Listing 10 ----------- user02@himmelblau:~$ id uid=773235643(user02) gid=773235643(user02) groups=773235643(user02),100(users),145696387(datengruppe),154317179(MSFT) user02@himmelblau:~$ getent passwd user02 user02:x:773235643:773235643:user02homuser02bibash ----------------------------------- But what about the groups in the Azure domain? A simple getent group does not return any results. For security reasons, the query via the group name has been disabled. Another reason is that there is no UPN for groups, so there may be groups with the same name in different domains. This could lead to the group not being unique. The query only works via the GID, or Entra Id Object Id of the group. Listing 11 shows the difference: ----- Listing 11 ------ root@himmelblau:~# getent group datengruppe root@himmelblau:~# root@himmelblau:~# getent group 145696387 datengruppe:x:145696387:user02,user01 root@himmelblau:~# getent group bb845f7f-8f6a-4101-b4c7-8db3cb94c9e6 datengruppe:x:1496389:user01,stka ----------------------- Since logging in to an Azure domain is no different from logging in to a local Active Directory (in terms of ID mapping), the UIDs and GIDs are always identical on all systems. Local parameters Local parameters can also be defined in the configuration file. These are settings that affect behavior on the client. For example, you can specify which local group a user from the domains is a member of. The local parameters that affect settings on the local client are located in the [global] section of the configuration; unfortunately, there is no separate section for adjustments that affect settings on the local client. To enter users locally in groups on a client, the local_groups variable is extended. The individual local groups are entered separated by commas. If a group is later removed at this point, the users must be manually removed from the group. To do this, edit the /etc/groups file. When a user logs in for the first time, a home directory is automatically created. The default directory for this is home . If you want the directory to be created in a different location in the file system, you can specify this using the variable home_prefix =*. It is also possible to copy certain data from a directory to the user's new home directory. This process is identical to creating a local user via the /etc/skel directory. To transfer data, the variable use_etc_skel = true can be set, then all files and directories from /etc/skel will be transferred. Since no shell is specified in the user's profile in the Azure domain, a default shell can be assigned to all users using the variable shell =/bin/bash . Note: The attributes from Listing 12 should always be set on Debian and Ubuntu systems. These values are also always entered in the configuration when installing the packages: ----- Listing 12 ----- home_attr = CN home_alias = CN use_etc_skel = true ------------------------ Global parameters Some settings can only be defined globally, i.e. for all registered domains. The [global] section is always at the beginning of the configuration. The settings also include customizing the login on the client. Customizing login security The configuration file can also be used to set parameters that improve login security. It is important to note that these adjustments must always be made in the [global] section, as these parameters always apply to all domains set up on the client. All changes to the configuration require a restart of both Himmelblau services. For example, it is possible to disable PIN-based logins and always require MFA. To do this, the configuration is adjusted as shown in Listing 13. -------- Listing 13 ------ ## Disable PIN login and always use MFA enable_hello=false ---------------------------- After restarting the himmelblaud and himmelblaud-tasks services, the Entra ID password is always requested when logging in to this client and a two-digit number is generated, which must then be entered in the app. Login with the PIN is then no longer possible. However, even when using the PIN, some additional security options can be configured. All PIN-related adjustments can only be entered in the [global] area on a client. The settings are always identical for all domains. Listing 14 shows the options: ----- Listing 14 ---- ## Minimum length of the PIN hello_pin_min_length = 8 ## Number of invalid retries hello_pin_retry_count = 4 ## Customize the PIN prompt hello_pin_prompt = Please enter your PIN for login ## Customize Entra Id password prompt entra_id_password_prompt = Please enter your Entra Id password ----------------------- It is also possible to allow only certain users or groups to log in to a client. To do this, insert the line from Listing 15 into the configuration: ----- Listing 15 ----- ## Only the following users and groups are allowed on this client pam_allow_groups = user01@example.onmicrosoft.com,bb845f7f-8f6a-4101-b4c7-8db3cb94c9e6 ------------------------ Users and groups are entered here separated by commas. For users, the UPN must be used. For groups, the Object ID GUID must be used. The reason for this is that when using group names and connecting to multiple domains, the uniqueness of the groups cannot be guaranteed. If a user who has an Entra ID but is not explicitly entered or is not a member of an entered group attempts to log in, the login is canceled. Listing 16 shows the corresponding output: ----- Listing 16 ----- ssh user02@192.168.56.81 (user02@192.168.56.81) Use the Linux Hello PIN for this device. PIN: Connection closed by 192.168.56.81 port 22 ------------------------ If debugging is enabled in the configuration (debug = true), the following lines from Listing 17 are displayed ----- Listing 17 ------ [debug]: Checking if user is in allowed groups ({\"bb845f7f-8f6a-4101-b4c7-8db3cb94c9e6\", \"user01@example.onmicrosoft.com\"}) -> {\"28174bcd-25b9-4f82-9965-671b2750f090\", \"8 [debug]: Number of intersecting groups: 0 ------------------------- If user01 were to log on to the system, the value would be Number of intersecting groups: 2. Why 2 ? The user is both directly in the list of allowed users and a member of the group entered in the list. This allows a group to be created for specific clients with the users who are allowed to log in to that client. Domain parameters In addition to the local and global parameters, it is also possible to configure specific settings for individual domains. The settings for a domain always begin with the name of the domain in square brackets. Adjusting the idmap range No individual ID mapping has been performed up to this point. If no individual ID mapping is configured, the range from 200000 to 2000200000 is always used as default. Since multiple domains separated by commas can be specified in the configuration file for the domains variable, it is necessary to define a separate range for each domain at this point at the latest. To do this, the file /etc/himmelblau/himmelblau.conf is adjusted as shown in Listing 18: ------ Listing 18 ------ [example.onmicrosoft.com] idmap_range = 1000000-1999999 -------------------------- It is important to enter the adjustment at the end of the file, otherwise the parameters of the [global] section below the entry will no longer be evaluated. Even if the lines are commented out, they must not be located in the middle of the [global] section. After changing the idmap range and restarting the two Himmelblau services, the users and groups can be displayed with a new ID. It is important to make the change on all clients, otherwise the same user (and also the groups) will have different IDs. In addition to adjusting the idmap_range , it is possible to set additional parameters. Here, it is also possible to override certain local settings. For example, if a different target directory for the home directories is to be created for each domain, the additional variable home_prefix=/domainname/ ensures that the home directory for all users of this domain is created in a corresponding directory. The variable entry must be placed below the domain name in square brackets. Further variables that can be set up specifically for domains are described in the man page for the himmelblau.conf file. Resetting a client All information about all users set up on this client is stored in an SQLite database in the file /var/cache/himmelblaud/himmelblau.cache.db. If a client is to be permanently removed from the domain, or if all users are to re-register their accounts on the client, the file can be deleted. This will invalidate all information about all users on this client. Before deleting, the two Himmelblau services should be stopped in any case. Once the file has been deleted and the services have been restarted, the database will be rebuilt. The database can be reset and the client removed from the domain using the aad-tool command. Listing 19 shows the process: ------ Listing 19 ----- root@skyblue:skyblue# aad-tool cache-clear --full This will unjoin the host, clear all caches, and cannot be undone. Proceed? [N]: y success ------------------------- Clients with GUI Of course, not every user will work exclusively with a console or access via SSH; most users will log in to a Linux client with a GUI. There is a solution for this as well. This section shows how to set up a client with a GUI, together with SSO via Firefox. In the first step, the following two packages must also be installed: himmelblau-sso_ himmelblau-qr-greeter_ After installing all packages and setting up the configuration, a user can log in to the system with their Azure ID. The login process involves the same steps as described for the first login to the system without a GUI. If you also want to enable the very first login of a completely new user, you will need to set up qr-greeter. This requires the machinectl program. The program is part of the Debian package systemd-container and must be installed first. After installation, you will need to perform all the steps listed in Listing 20: -------- Listing 20 -------- root@skyblue-gui:~# machinectl shell Debian-gdm@bibash Connected to the local host. Press ^] three times within 1s to exit session. Debian-gdm@himmelblau-gui:~$ gsettings set org.gnome.shell enabled-extensions \"['qr-greeter@himmelblau-idm.org']\" Debian-gdm@himmelblau-gui:~$ exit Debian-gdm@himmelblau-gui:~$systemctl restart gdm3 ------------------------------ IMPORTANT: Under no circumstances should you use your own domain here, only the domain himmelblau-idm.org, otherwise no QR code will be generated when a new user logs in for the first time. If everything has been set up correctly, the following image will appear when a user logs in for the very first time after entering their username and initial password: The user can then scan the QR code with their smartphone and will be taken to the website where they can complete the initial login. This only works if gdm is used as the login manager and a Gnome version >=45 is used. After successful login, the sso can be tested immediately. Installing the himmelblau-sso package also installs and activates the required plugin for Firefox. This allows an immediate connection to the Azure cloud and the booked applications. No further login is necessary. This completes the integration of a Linux client with GUI. The configuration for a client with GUI can be copied 1:1 from another client, even without GUI. It is only important that the idmap range is always identical.","title":"A Practical Introduction to Himmelblau"},{"location":"introduction/#a-practical-introduction-to-himmelblau","text":"by Stefan Kania Himmelblau is an open-source authentication framework that provides Microsoft's Azure Entra ID login for Linux systems. Its seamless and simple installation makes it easy to integrate Linux systems into Azure Entra ID and Intune. Both the enforcement of configured policies and Hello PIN support are provided for Linux systems. Himmelblau also offers support for Office 365 single sign-on (SSO) and multi-factor authentication (MFA). Debian, Suse, and RedHat distributions are supported.","title":"A Practical Introduction to Himmelblau"},{"location":"introduction/#technical-details","text":"Azure Entra ID was formerly known as Azure Active Directory and manages all user login data in the cloud. There are no longer any local domain controllers; all login information is managed centrally in the cloud. Clients no longer need to be explicitly added to the domain; a client is added when any user logs in for the first time. However, unlike a local login to a local Active Directory, a user registration is only valid on the client on which the user has registered. If a user wants to use a different client, they must first re-register there. To do this, they always need their Entra ID password, which they generated when they first logged in. However, users can generate different PINs on each client. An administrator can also require PINs of different lengths for different clients. Azure Entra ID is initially only a service for authentication on Windows clients. It is only through the development of Himmelblau that users with Linux clients can also authenticate with their Intra ID. This requires the authentication processes developed by Microsoft to be implemented on Linux. The extent of the problem that arises can be described here based on the very first login of a new user to a new client: When an administrator hands a user a laptop configured with Himmelblau and the user wants to log in from this device for the first time, this is possible. The only problem is that they have to authenticate with a DAG (Device Authorization Grant). Anyone who has ever authenticated with a video service such as Netflix is already familiar with this DAG authentication. With a DAG, the user is shown a code and a URL, and authentication with this information must then be performed from another device. User\u2019s MFA status Device state DAG needed? Notes MFA already set up Unjoined new device No User signs in with normal MFA; join/enroll proceeds. MFA not set up (brand new user) Unjoined new device Yes Use DAG once; then complete MFA setup after login. With Himmelblau, this is a little more complicated. For the user, the process is almost transparent. With Himmelblau, it is not possible to register a real Hello key with DAG authentication (Microsoft prohibits this). Himmelblau therefore sets up a so-called \"disconnected\" Hello PIN. This Hello PIN is cryptographically secure, but Himmelblau cannot request new Entra ID credentials in this way, only update existing credentials (a regular Hello key registered with MFA can do both). Himmelblau's offline login and SSO strategy is slightly less effective when the user authenticates in this way. The user will probably not notice this particularly, but they may have to re-authenticate via the DAG every few weeks to maintain their SSO. If a user changes their temporary password and sets up MFA from another client first, none of this is necessary, but it does require a client already integrated into Azure for the user's initial authentication. One way to circumvent all this is to support a so-called Temporary Access Pass (TAP). This is a concept developed by Microsoft. A TAP is valid for a limited number of uses or for a limited period of time. These can be issued by an administrator so that a user can register with Himmelblau using a Hello PIN. With this method, the user never has Entra ID credentials except those that are exclusively linked to that specific host. From that point on, users authenticate with their device PIN. This PIN grants users MFA SSO in the browser. However, users do not have the option of using this Entra ID to authenticate on another client. The key point here is that a user must have MFA configured before they can register their device with Entra ID. Technically speaking, this is not a mandatory requirement from Microsoft, but a restriction imposed by Himmelblau. The reason is that Microsoft sometimes requires MFA for device registration and sometimes does not. Instead of trying to accommodate both situations, Himmelblau always requires MFA. At least for device registration. For the registration of additional users, authentication with password only can then also be enabled as an option.","title":"Technical details"},{"location":"introduction/#core-features-and-benefits","text":"Himmelblau supports modern Azure Entra ID authentication workflows: OAuth2 authorization with MS-OAPX and OAPXBC extensions Issuance and renewal of Primary Refresh Tokens (PRT) Support for multi-factor authentication (MFA), including: Microsoft Authenticator FIDO2 hardware keys One-time passwords via SMS Temporary access pass Secure token storage and device registration SoftHSM and TPM backends are supported All login data and issued tokens are stored in encrypted, machine-bound memory. Seamless device registration with Azure Entra ID during initial login, eliminating the need to join a domain. When the first user logs in to a client, the client is automatically added to the domain. Through integration with Siemens' linux-entra-sso, Himmelblau enables: Firefox, Chrome and Microsoft Edge browser SSO for Microsoft 365 and Entra ID-protected applications Secure, updatable token storage for long-lived sessions Himmelblau is available for almost all major distributions. The current version 2.0 is also available for Debian 13. The following distributions are supported: Distribution Version Debian 12 + 13 Fedora 42 + 43 Fedora Rawhide Linux Mint 21.3 + 22 openSUSE 15.6 openSUSE 16 openSUSE Tumbleweed Oracle Linux 9 + 10 RHEL 9 + 10 Rocky Linux 9 + 10 SUSE Linux Enterprise 15 SP6 + SP7 SUSE Linux Enterprise 16 Ubuntu 22.04 + 24.04 NixOS In the first part, a Linux system without a graphical user interface is set up. For the distributions listed in the table here, there are repositories available at https://himmelblau-idm.org/downloads/index.html. Himmelblau consists of a total of eight packages: himmelblau_<version><distribution> himmelblau-sshd-config_<version><distribution> himmelblau-sso_<version><distribution> nss-himmelblau_<version><distribution> pam-himmelblau_<version><distribution> himmelblau-qr-greeter_<version><distribution> cirrus-scope_<version><distribution> himmelblau-selinux_<version><distribution> o365_<version><distribution> The cirrus-scope package is a package for debugging authentication between Azure Entra Id and the Himmelblau Library. It is not required for normal use. The o365 package integrates Microsoft Office desktop applications (Teams, Outlook, Word, Excel, PowerPoint, etc.) into Linux. These applications use taskbar icons to manage their background processes and quick access menus. All Microsoft o365 applications are displayed in the application menu after installing the package. Starting with version 2.0 for some distributions ther will be a special selinux package available.","title":"Core features and benefits"},{"location":"introduction/#installation-and-setup-of-the-packages","text":"To test the login for the first time, a Linux client without a graphical user interface is sufficient. Only the packages: himmelblau_<version><distribution> pam-himmelblau_<version><distribution> nss-himmelblau_<version><distribution himmelblau-sshd-config_<version><distribution> are installed for this purpose. The himmelblau-sshd-config package is only required if login via SSH on the client is to be possible. After installing the packages, distributions based on Red Hat and SUSE require some manual work for integration into PAM. For all supported distributions based on Debian, all necessary PAM entries are made automatically. On Debian systems, the Himmelblau entries are made in the common- files in the /etc/pam.d/ directory. On Suse systems, it is necessary to customize the PAM system with the command sudo pam-config --add --himmelblau . For all other distributions, the command aad-tool configure-pam can be used. The aad-tool command is part of the Himmelblau packages. To also allow users to access via SSH using the PIN, it is necessary to adjust the line from Listing 1 in the file /etc/pam.d/common-auth: --------- Listing 1------- auth [success=2 default=ignore] pam_himmelblau.so ignore_unknown_user mfa_poll_prompt ---------------------------- Without this adjustment, the password will always be requested instead of the PIN. The option mfa_poll_prompt is only needed if a distribution is usesd with an unfixed patch of OpenSSH. In Ubuntu and openSUSE OpenSSH isd already patched. To access a Linux client via SSH, you also need to adjust the SSH configuration. To do this, create the file /etc/ssh/sshd_config.d/himmelblau.conf with the content from Listing 2: ----- Listing 2 ----------- KbdInteractiveAuthentication yes ---------------------------- Then restart the SSH service. To enable the Linux system to access the user database, the file /etc/nsswitch.conf must now be adjusted. Listing 2 shows the adjustments: ------- Listing 3 ------- passwd: files systemd himmelblau group: files systemd himmelblau shadow: files systemd himmelblau ------------------------- If the packages from the original URL are used, these entries are also generated automatically. The only thing missing is the domain at which users should log in on the client. To do this, the configuration of Himmelblau is adjusted in the file /etc/himmelblau/himmelblau.conf. Listing 4 shows the change in the file: ------- Listing 4 -------- domain=example.onmicrosoft.com --------------------------- Only the name of your own domain is required. All other settings can be adopted for the time being. Anyone who has already gained experience with Entra ID and Microsoft clients will be surprised by this entry, because with a Windows client, the name of the domain is determined from the user's UPN when they log in, which does not yet work with Himmelblau. After configuring Himmelblau, it is still necessary to start the two services himmelblaud and himmelblaud-tasks and activate them permanently. Only then can the first login be performed. Listing 5 shows how to start the services: ----------- Listing 5 --------- systemctl enable --now himmelblaud himmelblaud-tasks --------------------------------","title":"Installation and setup of the packages"},{"location":"introduction/#the-first-login-of-a-new-user","text":"After the user has been created in the Azure portal and assigned an initial password, the user can log in with the new account and the initial password. Listing 6 shows the first login of a new user on a Linux client integrated into the domain -------Listing 6 ---- ssh user02@192.168.56.81 (user02@192.168.56.81) Use the password for your Office 365 or Microsoft online login. Entra Id Password: <initial password> (user02@192.168.56.81) To sign in, use a web browser to open the page https/microsoft.codevicelogin and enter the code DG94ZUCB2 to authenticate. Press enter to continue ------------ The new user must always log in via a browser using the URL listed in Listing 6 the first time. This is because two-factor authentication and a password change are still required. Registration is only performed once; if the user wants to log in to another system later, these steps are no longer necessary. When logging in via the browser, the code generated in the command line is required. Only after entering the code does the actual login take place. The user logs in with their full name, in this case user02@example.onmicrosoft.com . The initial password is required again here and must be changed in the next step. This is followed by a note on setting up two-factor authentication. Here you can use any app, such as Google Authenticator or Microsoft Authenticator. Microsoft Authenticator has the advantage that the user can later log in directly in the app with a two-digit number. However, the user can also change which app is used later. This is followed by instructions on how to use the app and a link to install it. Once the user has installed the app on their smartphone, they can continue with the setup. In this example, Microsoft Authenticator is used, which is why the setup instructions are provided here. After another window with additional instructions, a window with a QR code appears, which is scanned using the app. Only when the account has been entered correctly in the app can the user click on CONTINUE. The following test checks whether the setup was successful. To perform the test, the user must enter the two-digit number in their app. Only if the number is correct will the next screen appear with confirmation of the setup. Please note: This test is only performed if Microsoft Authenticator is used; Google Authenticator cannot perform this two-factor verification with a two-digit number. Finally, the successful first login is summarized and displayed again. If the app needs to be changed later, the user can do this themselves via the URL https://mysignins.microsoft.com/security-info. After completing the setup, the first login (here via ssh) to the Linux client follows. However, it is also possible to log in directly to a client integrated in Azure. Even when logging in locally on the client, it is sufficient to specify the CN (the CN is the part before the @ in the UPN); it is not necessary to specify the full name (User Principle Name (UPN)). The name is resolved via NSS, because himmelblau is entered there as the authentication source. Note: To make user logins unique, care should be taken to ensure that there are no local users with the same name in the domain. Listing 7 shows the first login attempt after setting up two-factor authentication: --------------Listing 7 --------------- ssh user02@192.168.56.81 (user02@192.168.56.81) Use the password for your Office 365 or Microsoft online login. Entra Id Password: (user02@192.168.56.81) Open your Authenticator app, and enter the number '11' to sign in. No push? Check your mobile device's internet connection. Press enter to continue (user02@192.168.56.81) Set up a PIN A Hello PIN is a fast, secure way to sign in to your device, apps, and services. The minimum PIN length is 6 characters. New PIN: (user02@192.168.56.81) Set up a PIN A Hello PIN is a fast, secure way to sign in to your device, apps, and services. The minimum PIN length is 6 characters. Confirm PIN: Enrolling the Hello PIN. Please wait... Enrolling the Hello PIN. Please wait... ... user02@himmelblau:~$ ----------------------------- When you log in to the console for the first time, you will be asked to enter your new password again. If the password is correct, a two-digit number (11 in the example) will be displayed here, which you then enter in the app. Only when this number has been verified by the app will the system generate a new Hello PIN, which will then be used later to log in instead of the password. When logging in for the first time, a $HOME directory is always created for the user. This part of the login must be performed by the user on every new Linux client on which the user logs in for the first time. However, the user can use the same PIN for each client. The system does not check whether the PIN is already being used on another client. This would not be possible anyway, as the information is encrypted on the client. For each subsequent login, only the PIN is now required, regardless of whether it is a local login or a login via ssh. Listing 8 shows another login using the PIN: -------------Listing 8 -------------- ssh user02@192.168.56.81 (user02@192.168.56.81) Use the Linux Hello PIN for this device. PIN: ... user02@himmelblau:~$ ---------------------------","title":"The first login of a new user"},{"location":"introduction/#the-linux-client","text":"What happens on the Linux client when it is integrated into Azure? During setup, Himmelblau was entered into the /etc/nsswitch.conf file. Now the domain specified in the configuration is searched for users and groups. The identity of the user can also be queried with the command id or getent passwd . Listing 10 shows the information for the user just set up: ------------ Listing 10 ----------- user02@himmelblau:~$ id uid=773235643(user02) gid=773235643(user02) groups=773235643(user02),100(users),145696387(datengruppe),154317179(MSFT) user02@himmelblau:~$ getent passwd user02 user02:x:773235643:773235643:user02homuser02bibash ----------------------------------- But what about the groups in the Azure domain? A simple getent group does not return any results. For security reasons, the query via the group name has been disabled. Another reason is that there is no UPN for groups, so there may be groups with the same name in different domains. This could lead to the group not being unique. The query only works via the GID, or Entra Id Object Id of the group. Listing 11 shows the difference: ----- Listing 11 ------ root@himmelblau:~# getent group datengruppe root@himmelblau:~# root@himmelblau:~# getent group 145696387 datengruppe:x:145696387:user02,user01 root@himmelblau:~# getent group bb845f7f-8f6a-4101-b4c7-8db3cb94c9e6 datengruppe:x:1496389:user01,stka ----------------------- Since logging in to an Azure domain is no different from logging in to a local Active Directory (in terms of ID mapping), the UIDs and GIDs are always identical on all systems.","title":"The Linux client"},{"location":"introduction/#local-parameters","text":"Local parameters can also be defined in the configuration file. These are settings that affect behavior on the client. For example, you can specify which local group a user from the domains is a member of. The local parameters that affect settings on the local client are located in the [global] section of the configuration; unfortunately, there is no separate section for adjustments that affect settings on the local client. To enter users locally in groups on a client, the local_groups variable is extended. The individual local groups are entered separated by commas. If a group is later removed at this point, the users must be manually removed from the group. To do this, edit the /etc/groups file. When a user logs in for the first time, a home directory is automatically created. The default directory for this is home . If you want the directory to be created in a different location in the file system, you can specify this using the variable home_prefix =*. It is also possible to copy certain data from a directory to the user's new home directory. This process is identical to creating a local user via the /etc/skel directory. To transfer data, the variable use_etc_skel = true can be set, then all files and directories from /etc/skel will be transferred. Since no shell is specified in the user's profile in the Azure domain, a default shell can be assigned to all users using the variable shell =/bin/bash . Note: The attributes from Listing 12 should always be set on Debian and Ubuntu systems. These values are also always entered in the configuration when installing the packages: ----- Listing 12 ----- home_attr = CN home_alias = CN use_etc_skel = true ------------------------","title":"Local parameters"},{"location":"introduction/#global-parameters","text":"Some settings can only be defined globally, i.e. for all registered domains. The [global] section is always at the beginning of the configuration. The settings also include customizing the login on the client.","title":"Global parameters"},{"location":"introduction/#customizing-login-security","text":"The configuration file can also be used to set parameters that improve login security. It is important to note that these adjustments must always be made in the [global] section, as these parameters always apply to all domains set up on the client. All changes to the configuration require a restart of both Himmelblau services. For example, it is possible to disable PIN-based logins and always require MFA. To do this, the configuration is adjusted as shown in Listing 13. -------- Listing 13 ------ ## Disable PIN login and always use MFA enable_hello=false ---------------------------- After restarting the himmelblaud and himmelblaud-tasks services, the Entra ID password is always requested when logging in to this client and a two-digit number is generated, which must then be entered in the app. Login with the PIN is then no longer possible. However, even when using the PIN, some additional security options can be configured. All PIN-related adjustments can only be entered in the [global] area on a client. The settings are always identical for all domains. Listing 14 shows the options: ----- Listing 14 ---- ## Minimum length of the PIN hello_pin_min_length = 8 ## Number of invalid retries hello_pin_retry_count = 4 ## Customize the PIN prompt hello_pin_prompt = Please enter your PIN for login ## Customize Entra Id password prompt entra_id_password_prompt = Please enter your Entra Id password ----------------------- It is also possible to allow only certain users or groups to log in to a client. To do this, insert the line from Listing 15 into the configuration: ----- Listing 15 ----- ## Only the following users and groups are allowed on this client pam_allow_groups = user01@example.onmicrosoft.com,bb845f7f-8f6a-4101-b4c7-8db3cb94c9e6 ------------------------ Users and groups are entered here separated by commas. For users, the UPN must be used. For groups, the Object ID GUID must be used. The reason for this is that when using group names and connecting to multiple domains, the uniqueness of the groups cannot be guaranteed. If a user who has an Entra ID but is not explicitly entered or is not a member of an entered group attempts to log in, the login is canceled. Listing 16 shows the corresponding output: ----- Listing 16 ----- ssh user02@192.168.56.81 (user02@192.168.56.81) Use the Linux Hello PIN for this device. PIN: Connection closed by 192.168.56.81 port 22 ------------------------ If debugging is enabled in the configuration (debug = true), the following lines from Listing 17 are displayed ----- Listing 17 ------ [debug]: Checking if user is in allowed groups ({\"bb845f7f-8f6a-4101-b4c7-8db3cb94c9e6\", \"user01@example.onmicrosoft.com\"}) -> {\"28174bcd-25b9-4f82-9965-671b2750f090\", \"8 [debug]: Number of intersecting groups: 0 ------------------------- If user01 were to log on to the system, the value would be Number of intersecting groups: 2. Why 2 ? The user is both directly in the list of allowed users and a member of the group entered in the list. This allows a group to be created for specific clients with the users who are allowed to log in to that client.","title":"Customizing login security"},{"location":"introduction/#domain-parameters","text":"In addition to the local and global parameters, it is also possible to configure specific settings for individual domains. The settings for a domain always begin with the name of the domain in square brackets.","title":"Domain parameters"},{"location":"introduction/#adjusting-the-idmap-range","text":"No individual ID mapping has been performed up to this point. If no individual ID mapping is configured, the range from 200000 to 2000200000 is always used as default. Since multiple domains separated by commas can be specified in the configuration file for the domains variable, it is necessary to define a separate range for each domain at this point at the latest. To do this, the file /etc/himmelblau/himmelblau.conf is adjusted as shown in Listing 18: ------ Listing 18 ------ [example.onmicrosoft.com] idmap_range = 1000000-1999999 -------------------------- It is important to enter the adjustment at the end of the file, otherwise the parameters of the [global] section below the entry will no longer be evaluated. Even if the lines are commented out, they must not be located in the middle of the [global] section. After changing the idmap range and restarting the two Himmelblau services, the users and groups can be displayed with a new ID. It is important to make the change on all clients, otherwise the same user (and also the groups) will have different IDs. In addition to adjusting the idmap_range , it is possible to set additional parameters. Here, it is also possible to override certain local settings. For example, if a different target directory for the home directories is to be created for each domain, the additional variable home_prefix=/domainname/ ensures that the home directory for all users of this domain is created in a corresponding directory. The variable entry must be placed below the domain name in square brackets. Further variables that can be set up specifically for domains are described in the man page for the himmelblau.conf file.","title":"Adjusting the idmap range"},{"location":"introduction/#resetting-a-client","text":"All information about all users set up on this client is stored in an SQLite database in the file /var/cache/himmelblaud/himmelblau.cache.db. If a client is to be permanently removed from the domain, or if all users are to re-register their accounts on the client, the file can be deleted. This will invalidate all information about all users on this client. Before deleting, the two Himmelblau services should be stopped in any case. Once the file has been deleted and the services have been restarted, the database will be rebuilt. The database can be reset and the client removed from the domain using the aad-tool command. Listing 19 shows the process: ------ Listing 19 ----- root@skyblue:skyblue# aad-tool cache-clear --full This will unjoin the host, clear all caches, and cannot be undone. Proceed? [N]: y success -------------------------","title":"Resetting a client"},{"location":"introduction/#clients-with-gui","text":"Of course, not every user will work exclusively with a console or access via SSH; most users will log in to a Linux client with a GUI. There is a solution for this as well. This section shows how to set up a client with a GUI, together with SSO via Firefox. In the first step, the following two packages must also be installed: himmelblau-sso_ himmelblau-qr-greeter_ After installing all packages and setting up the configuration, a user can log in to the system with their Azure ID. The login process involves the same steps as described for the first login to the system without a GUI. If you also want to enable the very first login of a completely new user, you will need to set up qr-greeter. This requires the machinectl program. The program is part of the Debian package systemd-container and must be installed first. After installation, you will need to perform all the steps listed in Listing 20: -------- Listing 20 -------- root@skyblue-gui:~# machinectl shell Debian-gdm@bibash Connected to the local host. Press ^] three times within 1s to exit session. Debian-gdm@himmelblau-gui:~$ gsettings set org.gnome.shell enabled-extensions \"['qr-greeter@himmelblau-idm.org']\" Debian-gdm@himmelblau-gui:~$ exit Debian-gdm@himmelblau-gui:~$systemctl restart gdm3 ------------------------------ IMPORTANT: Under no circumstances should you use your own domain here, only the domain himmelblau-idm.org, otherwise no QR code will be generated when a new user logs in for the first time. If everything has been set up correctly, the following image will appear when a user logs in for the very first time after entering their username and initial password: The user can then scan the QR code with their smartphone and will be taken to the website where they can complete the initial login. This only works if gdm is used as the login manager and a Gnome version >=45 is used. After successful login, the sso can be tested immediately. Installing the himmelblau-sso package also installs and activates the required plugin for Firefox. This allows an immediate connection to the Azure cloud and the booked applications. No further login is necessary. This completes the integration of a Linux client with GUI. The configuration for a client with GUI can be copied 1:1 from another client, even without GUI. It is only important that the idmap range is always identical.","title":"Clients with GUI"},{"location":"mail_integration/","text":"Setting Up Office 365 Email in Evolution This guide explains how to configure Office 365 email in the Evolution mail client when you are already signed in on your system using Himmelblau . Evolution integrates with Himmelblau's Entra ID authentication, but a brief one-time setup is required. Prerequisites You are logged into your Linux system using Himmelblau. Evolution (3.53.2+) is installed. No passwords will be required during this setup. Himmelblau provides the authentication tokens; Evolution only needs application authorization. Step-by-Step Setup Instructions 1. Open Evolution Account Settings Launch Evolution . In the top\u2011right corner, click the menu button (three horizontal bars). Select Edit \u2192 Accounts . 2. Add a New Mail Account Click Add \u2192 Mail Account . At the welcome screen, click Next . Enter the following: Full Name : Your name Email Address : Your Office 365 / Entra ID email address Click Next . 3. Configure the Account as Microsoft 365 When prompted for account type settings, change Server Type to: Microsoft 365 Click Finish . 4. Save Account Changes Click Apply . Authorizing Evolution You may see an error immediately after clicking Apply . This is expected. A dialog will appear asking you to authorize Evolution. Click to open the connection / authorization dialog . You will be redirected to the Office 365 login authorization page . You will not be asked for your username or password. Himmelblau automatically provides authentication. You will be asked to confirm that Evolution is allowed to access your account. Approve the authorization. Once authorized, Evolution will connect normally and begin syncing your mailbox. Summary With Himmelblau handling authentication, setting up Office 365 in Evolution takes only a few steps: Add account \u2192 enter name/email. Select Microsoft 365 server type. Apply. Authorize the Evolution app when prompted. After authorization, your mail, calendar, and contacts will sync automatically.","title":"Evolution Mail Integration"},{"location":"mail_integration/#setting-up-office-365-email-in-evolution","text":"This guide explains how to configure Office 365 email in the Evolution mail client when you are already signed in on your system using Himmelblau . Evolution integrates with Himmelblau's Entra ID authentication, but a brief one-time setup is required.","title":"Setting Up Office 365 Email in Evolution"},{"location":"mail_integration/#prerequisites","text":"You are logged into your Linux system using Himmelblau. Evolution (3.53.2+) is installed. No passwords will be required during this setup. Himmelblau provides the authentication tokens; Evolution only needs application authorization.","title":"Prerequisites"},{"location":"mail_integration/#step-by-step-setup-instructions","text":"","title":"Step-by-Step Setup Instructions"},{"location":"mail_integration/#1-open-evolution-account-settings","text":"Launch Evolution . In the top\u2011right corner, click the menu button (three horizontal bars). Select Edit \u2192 Accounts .","title":"1. Open Evolution Account Settings"},{"location":"mail_integration/#2-add-a-new-mail-account","text":"Click Add \u2192 Mail Account . At the welcome screen, click Next . Enter the following: Full Name : Your name Email Address : Your Office 365 / Entra ID email address Click Next .","title":"2. Add a New Mail Account"},{"location":"mail_integration/#3-configure-the-account-as-microsoft-365","text":"When prompted for account type settings, change Server Type to: Microsoft 365 Click Finish .","title":"3. Configure the Account as Microsoft 365"},{"location":"mail_integration/#4-save-account-changes","text":"Click Apply .","title":"4. Save Account Changes"},{"location":"mail_integration/#authorizing-evolution","text":"You may see an error immediately after clicking Apply . This is expected. A dialog will appear asking you to authorize Evolution. Click to open the connection / authorization dialog . You will be redirected to the Office 365 login authorization page . You will not be asked for your username or password. Himmelblau automatically provides authentication. You will be asked to confirm that Evolution is allowed to access your account. Approve the authorization. Once authorized, Evolution will connect normally and begin syncing your mailbox.","title":"Authorizing Evolution"},{"location":"mail_integration/#summary","text":"With Himmelblau handling authentication, setting up Office 365 in Evolution takes only a few steps: Add account \u2192 enter name/email. Select Microsoft 365 server type. Apply. Authorize the Evolution app when prompted. After authorization, your mail, calendar, and contacts will sync automatically.","title":"Summary"},{"location":"registration/","text":"Device Registration with Azure Entra ID Overview Himmelblau supports automatic device registration with Azure Entra ID as part of its first-login flow. This enables conditional access, device-based compliance enforcement, and visibility in the Microsoft Entra admin center. Device registration is mandatory for: Intune integration Device-scoped Conditional Access policies When Registration Occurs Device registration is initiated automatically when: A user authenticates with a domain configured in himmelblau.conf The device has no cached registration or device identity This typically happens during the first successful login for each Entra ID\u2013enabled domain. You can enforce registration immediately by running aad-tool auth-test . Registration Workflow Step-by-Step Check for Existing Identity Himmelblau checks whether the device is already registered. This is done by: Looking for sealed credentials in the himmelblau cache. Checking configuration for a device_id Enroll Device If not already registered: Himmelblau contacts the Entra Id /device endpoint Uses device credentials (TPM-backed or SoftHSM-backed key) For more details, view the enrollment documentation . Store Device Identity Upon successful registration: The device ID and related certificate are stored securely Future token requests include device context Intune Enroll Device (Optional) Registering the device with Intune is a separate process: Himmelblau contacts the Intune /enroll endpoint Uses device credentials from Entra Id enrollment to authenticate For more details, view the Intune enrollment documentation . Store Intune Device Identity Upon successful registration: The device ID and related certificate are stored securely Intune and Conditional Access can now recognize the device Security Considerations Registration keys are sealed to the TPM when available Device identity is bound to the machine and cannot be reused elsewhere Managing Registered Devices Once registered, the device can be managed through the Entra admin portal or Microsoft Intune: View device metadata, compliance status, and last check-in Enforce policies Remove stale entries manually if a device is decommissioned","title":"Device Registration"},{"location":"registration/#device-registration-with-azure-entra-id","text":"","title":"Device Registration with Azure Entra ID"},{"location":"registration/#overview","text":"Himmelblau supports automatic device registration with Azure Entra ID as part of its first-login flow. This enables conditional access, device-based compliance enforcement, and visibility in the Microsoft Entra admin center. Device registration is mandatory for: Intune integration Device-scoped Conditional Access policies","title":"Overview"},{"location":"registration/#when-registration-occurs","text":"Device registration is initiated automatically when: A user authenticates with a domain configured in himmelblau.conf The device has no cached registration or device identity This typically happens during the first successful login for each Entra ID\u2013enabled domain. You can enforce registration immediately by running aad-tool auth-test .","title":"When Registration Occurs"},{"location":"registration/#registration-workflow","text":"","title":"Registration Workflow"},{"location":"registration/#step-by-step","text":"Check for Existing Identity Himmelblau checks whether the device is already registered. This is done by: Looking for sealed credentials in the himmelblau cache. Checking configuration for a device_id Enroll Device If not already registered: Himmelblau contacts the Entra Id /device endpoint Uses device credentials (TPM-backed or SoftHSM-backed key) For more details, view the enrollment documentation . Store Device Identity Upon successful registration: The device ID and related certificate are stored securely Future token requests include device context Intune Enroll Device (Optional) Registering the device with Intune is a separate process: Himmelblau contacts the Intune /enroll endpoint Uses device credentials from Entra Id enrollment to authenticate For more details, view the Intune enrollment documentation . Store Intune Device Identity Upon successful registration: The device ID and related certificate are stored securely Intune and Conditional Access can now recognize the device","title":"Step-by-Step"},{"location":"registration/#security-considerations","text":"Registration keys are sealed to the TPM when available Device identity is bound to the machine and cannot be reused elsewhere","title":"Security Considerations"},{"location":"registration/#managing-registered-devices","text":"Once registered, the device can be managed through the Entra admin portal or Microsoft Intune: View device metadata, compliance status, and last check-in Enforce policies Remove stale entries manually if a device is decommissioned","title":"Managing Registered Devices"},{"location":"advanced/Cloud-Kerberos-Trust-for-Linux/","text":"\u26a0\ufe0f Warning: This document is a work in progress. Cloud Kerberos Trust for Linux is also a work in progress and likely requires additional configuration and bug fixes to Himmelblau. Cloud Kerberos Trust Setup for Entra ID Joined Linux Devices This guide outlines the steps to configure Cloud Kerberos Trust between Microsoft Entra ID (formerly Azure AD) and an on-premises Active Directory (AD) for Linux devices joined to Entra ID using Himmelblau. Prerequisites Microsoft Entra ID is configured. On-premises Active Directory is operational. Entra Id Connect is installed and synchronizing users from on-premises AD to Entra ID. Linux client is joined to Entra ID via Himmelblau. Kerberos utilities (e.g., mit-krb5 ) are installed on the Linux client. Network connectivity between the Linux client and on-prem AD domain controllers. Administrative privileges in both on-prem AD and Entra ID. Step 1: Configure Microsoft Entra Kerberos Server Object Install the AzureADHybridAuthenticationManagement PowerShell module on a Windows machine with AD access: Install-Module -Name AzureADHybridAuthenticationManagement -AllowClobber Create the Kerberos server object: # Specify the on-premises Active Directory domain. A new Azure AD # Kerberos Server object will be created in this Active Directory domain. $domain = $env:USERDNSDOMAIN # Enter a UPN of an Azure Active Directory global administrator $userPrincipalName = \"administrator@contoso.onmicrosoft.com\" # Enter a domain administrator username and password. $domainCred = Get-Credential # Create the new Azure AD Kerberos Server object in Active Directory # and then publish it to Azure Active Directory. # Open an interactive sign-in prompt with given username to access the Azure AD. Set-AzureADKerberosServer -Domain $domain -UserPrincipalName $userPrincipalName -DomainCredential $domainCred Verify that the Kerberos server RODC object was created successfully. Get-AzureADKerberosServer -Domain $domain -UserPrincipalName $userPrincipalName Step 2: Configure Kerberos on the Linux Client Edit the Kerberos configuration file ( /etc/krb5.conf ): [libdefaults] default_realm = EXAMPLE.COM dns_lookup_realm = false dns_lookup_kdc = false [realms] EXAMPLE.COM = { kdc = dc1.example.com kdc = dc2.example.com admin_server = dc1.example.com } [domain_realm] .example.com = EXAMPLE.COM example.com = EXAMPLE.COM Replace EXAMPLE.COM with your AD domain in uppercase. Replace example.com with your AD domain in lowercase. Replace dc1.example.com and dc2.example.com with FQDNs of your domain controllers. Verify that time synchronization between the Linux client and the domain controllers is accurate. Step 3: Validate the Configuration on Linux Devices After configuring the policies, validate that Linux devices can obtain Kerberos tickets: Log Out and Log In : On the Linux device, log out and then log back in to initiate the authentication process. Check Kerberos Tickets : Open a terminal and run: klist You should see a valid Kerberos ticket listed, indicating successful authentication.","title":"Cloud Kerberos Trust for Linux"},{"location":"advanced/Cloud-Kerberos-Trust-for-Linux/#cloud-kerberos-trust-setup-for-entra-id-joined-linux-devices","text":"This guide outlines the steps to configure Cloud Kerberos Trust between Microsoft Entra ID (formerly Azure AD) and an on-premises Active Directory (AD) for Linux devices joined to Entra ID using Himmelblau.","title":"Cloud Kerberos Trust Setup for Entra ID Joined Linux Devices"},{"location":"advanced/Cloud-Kerberos-Trust-for-Linux/#prerequisites","text":"Microsoft Entra ID is configured. On-premises Active Directory is operational. Entra Id Connect is installed and synchronizing users from on-premises AD to Entra ID. Linux client is joined to Entra ID via Himmelblau. Kerberos utilities (e.g., mit-krb5 ) are installed on the Linux client. Network connectivity between the Linux client and on-prem AD domain controllers. Administrative privileges in both on-prem AD and Entra ID.","title":"Prerequisites"},{"location":"advanced/Cloud-Kerberos-Trust-for-Linux/#step-1-configure-microsoft-entra-kerberos-server-object","text":"Install the AzureADHybridAuthenticationManagement PowerShell module on a Windows machine with AD access: Install-Module -Name AzureADHybridAuthenticationManagement -AllowClobber Create the Kerberos server object: # Specify the on-premises Active Directory domain. A new Azure AD # Kerberos Server object will be created in this Active Directory domain. $domain = $env:USERDNSDOMAIN # Enter a UPN of an Azure Active Directory global administrator $userPrincipalName = \"administrator@contoso.onmicrosoft.com\" # Enter a domain administrator username and password. $domainCred = Get-Credential # Create the new Azure AD Kerberos Server object in Active Directory # and then publish it to Azure Active Directory. # Open an interactive sign-in prompt with given username to access the Azure AD. Set-AzureADKerberosServer -Domain $domain -UserPrincipalName $userPrincipalName -DomainCredential $domainCred Verify that the Kerberos server RODC object was created successfully. Get-AzureADKerberosServer -Domain $domain -UserPrincipalName $userPrincipalName","title":"Step 1: Configure Microsoft Entra Kerberos Server Object"},{"location":"advanced/Cloud-Kerberos-Trust-for-Linux/#step-2-configure-kerberos-on-the-linux-client","text":"Edit the Kerberos configuration file ( /etc/krb5.conf ): [libdefaults] default_realm = EXAMPLE.COM dns_lookup_realm = false dns_lookup_kdc = false [realms] EXAMPLE.COM = { kdc = dc1.example.com kdc = dc2.example.com admin_server = dc1.example.com } [domain_realm] .example.com = EXAMPLE.COM example.com = EXAMPLE.COM Replace EXAMPLE.COM with your AD domain in uppercase. Replace example.com with your AD domain in lowercase. Replace dc1.example.com and dc2.example.com with FQDNs of your domain controllers. Verify that time synchronization between the Linux client and the domain controllers is accurate.","title":"Step 2: Configure Kerberos on the Linux Client"},{"location":"advanced/Cloud-Kerberos-Trust-for-Linux/#step-3-validate-the-configuration-on-linux-devices","text":"After configuring the policies, validate that Linux devices can obtain Kerberos tickets: Log Out and Log In : On the Linux device, log out and then log back in to initiate the authentication process. Check Kerberos Tickets : Open a terminal and run: klist You should see a valid Kerberos ticket listed, indicating successful authentication.","title":"Step 3: Validate the Configuration on Linux Devices"},{"location":"advanced/Configuring-Unix-Attribute-Synchronization-with-Azure-Entra-ID-Using-Microsoft-Entra-Connect-Sync/","text":"Overview This guide explains how to configure Microsoft Entra Connect Sync to synchronize Unix attributes ( uidNumber , gidNumber , loginShell , unixHomeDirectory , etc.) from an on-premises Active Directory to an existing Azure Entra ID instance. This is essential for Linux authentication solutions like Himmelblau that rely on Unix attributes stored in AD. This guide assumes that Microsoft Entra Connect is already installed and configured. If not, follow the instructions in this wiki to configure Microsoft Entra Connect. Prerequisites A Windows Server with Active Directory Domain Services (AD DS) installed and configured. A configured Active Directory domain with Unix attributes ( uidNumber , gidNumber , unixHomeDirectory , loginShell , etc.) assigned to users and groups. An Azure Entra ID tenant. Microsoft Entra Connect Sync installed on a domain-joined Windows Server. Step-by-Step Configuration 1. Open Microsoft Entra Connect Sync Launch Microsoft Entra Connect Sync from the Start Menu . Click \"Configure\" to begin. 2. Customize Synchronization Options Select \"Customize synchronization options\" and click Next . 3. Connect to Microsoft Entra ID Enter your Azure Entra ID administrator credentials (Global Admin or Hybrid Identity Admin). Sign in when prompted. 4. Connect to Active Directory Verify that the on-premises Active Directory domain (forest) is connected. Click Next . 5. Configure Domain and OU Filtering Choose whether to sync all domains and OUs or only specific OUs. Click Next . 6. Enable Directory Extension Attribute Sync Ensure \"Directory extension attribute sync\" is checked . Click Next . 7. Select Unix Attributes for Synchronization In the Directory Extensions step, select the following attributes: uidNumber (user) gidNumber (user) (the user's primary group attribute) gidNumber (group) loginShell (user) unixHomeDirectory (user) gecos (user) (optional, for additional Unix user details) Click Next . 8. Configure and Apply Settings Click Next to save and apply the synchronization settings. Wait for the configuration to complete. 9. Verify Configuration Completion Once the setup is completed, you\u2019ll see a confirmation message. Click Exit . 10. Validate Synchronization After the setup: Open the Microsoft Entra Admin Center . Go to Hybrid Management \u2192 Microsoft Entra Connect . Check the sync status and ensure that users have their Unix attributes synchronized.","title":"Configuring Unix Attribute Synchronization with Azure Entra ID Using Microsoft Entra Connect Sync"},{"location":"advanced/Configuring-Unix-Attribute-Synchronization-with-Azure-Entra-ID-Using-Microsoft-Entra-Connect-Sync/#overview","text":"This guide explains how to configure Microsoft Entra Connect Sync to synchronize Unix attributes ( uidNumber , gidNumber , loginShell , unixHomeDirectory , etc.) from an on-premises Active Directory to an existing Azure Entra ID instance. This is essential for Linux authentication solutions like Himmelblau that rely on Unix attributes stored in AD. This guide assumes that Microsoft Entra Connect is already installed and configured. If not, follow the instructions in this wiki to configure Microsoft Entra Connect.","title":"Overview"},{"location":"advanced/Configuring-Unix-Attribute-Synchronization-with-Azure-Entra-ID-Using-Microsoft-Entra-Connect-Sync/#prerequisites","text":"A Windows Server with Active Directory Domain Services (AD DS) installed and configured. A configured Active Directory domain with Unix attributes ( uidNumber , gidNumber , unixHomeDirectory , loginShell , etc.) assigned to users and groups. An Azure Entra ID tenant. Microsoft Entra Connect Sync installed on a domain-joined Windows Server.","title":"Prerequisites"},{"location":"advanced/Configuring-Unix-Attribute-Synchronization-with-Azure-Entra-ID-Using-Microsoft-Entra-Connect-Sync/#step-by-step-configuration","text":"","title":"Step-by-Step Configuration"},{"location":"advanced/Configuring-Unix-Attribute-Synchronization-with-Azure-Entra-ID-Using-Microsoft-Entra-Connect-Sync/#1-open-microsoft-entra-connect-sync","text":"Launch Microsoft Entra Connect Sync from the Start Menu . Click \"Configure\" to begin.","title":"1. Open Microsoft Entra Connect Sync"},{"location":"advanced/Configuring-Unix-Attribute-Synchronization-with-Azure-Entra-ID-Using-Microsoft-Entra-Connect-Sync/#2-customize-synchronization-options","text":"Select \"Customize synchronization options\" and click Next .","title":"2. Customize Synchronization Options"},{"location":"advanced/Configuring-Unix-Attribute-Synchronization-with-Azure-Entra-ID-Using-Microsoft-Entra-Connect-Sync/#3-connect-to-microsoft-entra-id","text":"Enter your Azure Entra ID administrator credentials (Global Admin or Hybrid Identity Admin). Sign in when prompted.","title":"3. Connect to Microsoft Entra ID"},{"location":"advanced/Configuring-Unix-Attribute-Synchronization-with-Azure-Entra-ID-Using-Microsoft-Entra-Connect-Sync/#4-connect-to-active-directory","text":"Verify that the on-premises Active Directory domain (forest) is connected. Click Next .","title":"4. Connect to Active Directory"},{"location":"advanced/Configuring-Unix-Attribute-Synchronization-with-Azure-Entra-ID-Using-Microsoft-Entra-Connect-Sync/#5-configure-domain-and-ou-filtering","text":"Choose whether to sync all domains and OUs or only specific OUs. Click Next .","title":"5. Configure Domain and OU Filtering"},{"location":"advanced/Configuring-Unix-Attribute-Synchronization-with-Azure-Entra-ID-Using-Microsoft-Entra-Connect-Sync/#6-enable-directory-extension-attribute-sync","text":"Ensure \"Directory extension attribute sync\" is checked . Click Next .","title":"6. Enable Directory Extension Attribute Sync"},{"location":"advanced/Configuring-Unix-Attribute-Synchronization-with-Azure-Entra-ID-Using-Microsoft-Entra-Connect-Sync/#7-select-unix-attributes-for-synchronization","text":"In the Directory Extensions step, select the following attributes: uidNumber (user) gidNumber (user) (the user's primary group attribute) gidNumber (group) loginShell (user) unixHomeDirectory (user) gecos (user) (optional, for additional Unix user details) Click Next .","title":"7. Select Unix Attributes for Synchronization"},{"location":"advanced/Configuring-Unix-Attribute-Synchronization-with-Azure-Entra-ID-Using-Microsoft-Entra-Connect-Sync/#8-configure-and-apply-settings","text":"Click Next to save and apply the synchronization settings. Wait for the configuration to complete.","title":"8. Configure and Apply Settings"},{"location":"advanced/Configuring-Unix-Attribute-Synchronization-with-Azure-Entra-ID-Using-Microsoft-Entra-Connect-Sync/#9-verify-configuration-completion","text":"Once the setup is completed, you\u2019ll see a confirmation message. Click Exit .","title":"9. Verify Configuration Completion"},{"location":"advanced/Configuring-Unix-Attribute-Synchronization-with-Azure-Entra-ID-Using-Microsoft-Entra-Connect-Sync/#10-validate-synchronization","text":"After the setup: Open the Microsoft Entra Admin Center . Go to Hybrid Management \u2192 Microsoft Entra Connect . Check the sync status and ensure that users have their Unix attributes synchronized.","title":"10. Validate Synchronization"},{"location":"advanced/Configuring-a-Hardware-TPM-for-Secure-Key-Storage/","text":"Configuring a Hardware TPM for Secure Key Storage Himmelblau supports the use of a hardware TPM (Trusted Platform Module) to securely store cryptographic secrets, including Hello PIN keys, device credentials, and the Primary Refresh Token (PRT). By default, Himmelblau uses a software HSM , which provides no hardware-backed security. If your system includes a TPM, we strongly recommend configuring Himmelblau to use it before enrolling the device . \u26a0\ufe0f Warning: TPM support must be configured before authenticating to Entra ID or enrolling the device. If you've already enrolled, you'll need to reset the local cache and re-enroll in order to switch to TPM. When Should I Use TPM? You should configure Himmelblau to use TPM if: Your system includes a TPM 2.0 chip You want hardware-backed protection for Hello PIN credentials You want secure key binding tied to the physical machine (e.g., protection against disk cloning) You're deploying to security-sensitive environments (e.g., laptops, remote workers) \ud83d\udee0\ufe0f TPM Setup Instructions 1. Ensure the TPM Is Available and Functional Check whether a TPM is exposed on your system by running: ls /dev/tpmrm0 If that file exists, you likely have a usable TPM. For further inspection, you can optionally install TPM tools: On openSUSE : bash sudo zypper install tpm2.0-tools * On Debian/Ubuntu : bash sudo apt install tpm2-tools Then run: sudo tpm2_getcap properties-fixed This should output a list of TPM capabilities. If not, verify: TPM is enabled in BIOS/UEFI Kernel drivers ( tpm_crb , tpm_tis ) are loaded 2. Configure himmelblau.conf Open /etc/himmelblau/himmelblau.conf and change the hsm_type setting: hsm_type = tpm If you want to fall back to software HSM on systems without a TPM: hsm_type = tpm_if_possible \u2139\ufe0f You do not need to set tpm_tcti_name unless your TPM is exposed through a nonstandard interface. By default, Himmelblau uses: ini tpm_tcti_name = device:/dev/tpmrm0 3. Restart Himmelblau Services sudo systemctl restart himmelblaud sudo systemctl restart himmelblaud-tasks 4. Enroll the Device Once TPM is configured, proceed with Entra ID authentication and device enrollment. All future key material will be generated and bound to the TPM. Switching to TPM After Enrollment If you've already enrolled the device using hsm_type = soft , you can still switch to TPM, but you'll need to reset the local key cache and re-enroll: sudo aad-tool cache-clear --full Then update himmelblau.conf to use hsm_type = tpm , restart services, and begin re-enrollment. Verifying TPM Usage Check the logs for TPM initialization: journalctl -u himmelblaud | grep -i tpm You should see messages indicating successful communication with the TPM and key creation/binding. Summary Feature Default Recommended for TPM hsm_type soft (no TPM) tpm or tpm_if_possible tpm_tcti_name device:/dev/tpmrm0 (usually don't change) Remember: TPM must be configured before enrollment. Switching afterward requires clearing the secure key cache.","title":"Configuring a Hardware TPM for Secure Key Storage"},{"location":"advanced/Configuring-a-Hardware-TPM-for-Secure-Key-Storage/#configuring-a-hardware-tpm-for-secure-key-storage","text":"Himmelblau supports the use of a hardware TPM (Trusted Platform Module) to securely store cryptographic secrets, including Hello PIN keys, device credentials, and the Primary Refresh Token (PRT). By default, Himmelblau uses a software HSM , which provides no hardware-backed security. If your system includes a TPM, we strongly recommend configuring Himmelblau to use it before enrolling the device . \u26a0\ufe0f Warning: TPM support must be configured before authenticating to Entra ID or enrolling the device. If you've already enrolled, you'll need to reset the local cache and re-enroll in order to switch to TPM.","title":"Configuring a Hardware TPM for Secure Key Storage"},{"location":"advanced/Configuring-a-Hardware-TPM-for-Secure-Key-Storage/#when-should-i-use-tpm","text":"You should configure Himmelblau to use TPM if: Your system includes a TPM 2.0 chip You want hardware-backed protection for Hello PIN credentials You want secure key binding tied to the physical machine (e.g., protection against disk cloning) You're deploying to security-sensitive environments (e.g., laptops, remote workers)","title":"When Should I Use TPM?"},{"location":"advanced/Configuring-a-Hardware-TPM-for-Secure-Key-Storage/#tpm-setup-instructions","text":"","title":"\ud83d\udee0\ufe0f TPM Setup Instructions"},{"location":"advanced/Configuring-a-Hardware-TPM-for-Secure-Key-Storage/#1-ensure-the-tpm-is-available-and-functional","text":"Check whether a TPM is exposed on your system by running: ls /dev/tpmrm0 If that file exists, you likely have a usable TPM. For further inspection, you can optionally install TPM tools: On openSUSE : bash sudo zypper install tpm2.0-tools * On Debian/Ubuntu : bash sudo apt install tpm2-tools Then run: sudo tpm2_getcap properties-fixed This should output a list of TPM capabilities. If not, verify: TPM is enabled in BIOS/UEFI Kernel drivers ( tpm_crb , tpm_tis ) are loaded","title":"1. Ensure the TPM Is Available and Functional"},{"location":"advanced/Configuring-a-Hardware-TPM-for-Secure-Key-Storage/#2-configure-himmelblauconf","text":"Open /etc/himmelblau/himmelblau.conf and change the hsm_type setting: hsm_type = tpm If you want to fall back to software HSM on systems without a TPM: hsm_type = tpm_if_possible \u2139\ufe0f You do not need to set tpm_tcti_name unless your TPM is exposed through a nonstandard interface. By default, Himmelblau uses: ini tpm_tcti_name = device:/dev/tpmrm0","title":"2. Configure himmelblau.conf"},{"location":"advanced/Configuring-a-Hardware-TPM-for-Secure-Key-Storage/#3-restart-himmelblau-services","text":"sudo systemctl restart himmelblaud sudo systemctl restart himmelblaud-tasks","title":"3. Restart Himmelblau Services"},{"location":"advanced/Configuring-a-Hardware-TPM-for-Secure-Key-Storage/#4-enroll-the-device","text":"Once TPM is configured, proceed with Entra ID authentication and device enrollment. All future key material will be generated and bound to the TPM.","title":"4. Enroll the Device"},{"location":"advanced/Configuring-a-Hardware-TPM-for-Secure-Key-Storage/#switching-to-tpm-after-enrollment","text":"If you've already enrolled the device using hsm_type = soft , you can still switch to TPM, but you'll need to reset the local key cache and re-enroll: sudo aad-tool cache-clear --full Then update himmelblau.conf to use hsm_type = tpm , restart services, and begin re-enrollment.","title":"Switching to TPM After Enrollment"},{"location":"advanced/Configuring-a-Hardware-TPM-for-Secure-Key-Storage/#verifying-tpm-usage","text":"Check the logs for TPM initialization: journalctl -u himmelblaud | grep -i tpm You should see messages indicating successful communication with the TPM and key creation/binding.","title":"Verifying TPM Usage"},{"location":"advanced/Configuring-a-Hardware-TPM-for-Secure-Key-Storage/#summary","text":"Feature Default Recommended for TPM hsm_type soft (no TPM) tpm or tpm_if_possible tpm_tcti_name device:/dev/tpmrm0 (usually don't change) Remember: TPM must be configured before enrollment. Switching afterward requires clearing the secure key cache.","title":"Summary"},{"location":"advanced/Creating-an-Entra-ID-Application-for-Himmelblau-GroupMember.Read.All-and-User.Read.All-Permissions/","text":"Overview Himmelblau requires additional API permissions to read group names and extended attributes such as a groups' gidNumber or users' uidNumber (which is essential for RFC2307 attribute ID mapping). The following instructions guide you through registering an Azure Entra ID application, assigning it permissions, and configuring Himmelblau to use either delegated or confidential client authentication. With the default configuration, Himmelblau will attempt to resolve group memberships by masquerading as the Edge browser with delegated access , but this doesn't work in every tenant, and has the limitation of only resolving group memberships after each user has authenticated. Note: - If you set up confidential client credentials (client secret or certificate) using aad-tool cred , you do not need to specify an app_id in himmelblau.conf . - If you choose delegated access , you must set an app_id in your configuration. 1. Register a New Application in Azure Entra ID Navigate to the Azure Entra ID portal . In the left-hand menu, select App registrations . Click New registration . Enter a Name for the application (e.g., Himmelblau ). Under Supported account types , choose Accounts in this organizational directory only . Under Redirect URI , choose Public client/native (mobile & desktop) for the platform and enter himmelblau://Himmelblau.EntraId.BrokerPlugin for the URI. Click Register . 2. Assign API Permissions In the newly created application, navigate to API permissions . Click Add a permission . Select Microsoft Graph . If utilizing Confidential Client Credentials (Option A below) choose Application permissions , otherwise choose Delegated permissions (Option B). Search for GroupMember.Read.All and select it. Also search for User.Read.All and add this permission. Click Add permissions . Click Grant admin consent to approve these permissions for your tenant. Continue with the same procedure for the User.Read.All permission. Warning!: Never use Group.Read.All instead of the GroupMember.Read.All permission, because for Microsoft 365 groups, Group.* permissions grant the app access to the contents of the group ; for example, conversations, files, notes, and so on. 3. Obtain the Application ID Go to Overview in the application\u2019s page. Copy the Application (client) ID . This value will be used in Himmelblau\u2019s configuration. 4. Configure Authentication in Himmelblau You have two main options for enumerating users and group memberships: Option A: Using Confidential Client Credentials (Recommended) This method stores a client secret or client certificate securely in Himmelblau\u2019s encrypted cache and removes the need to specify an app_id in himmelblau.conf . Store a client secret aad-tool cred secret --client-id <CLIENT_ID> --domain <DOMAIN> --secret <SECRET_VALUE> In the Entra ID portal, under Certificates & secrets , create a new Client secret . Copy the Value immediately (you won\u2019t see it again) and use it with the above command. Or set up a client certificate aad-tool cred cert --client-id <CLIENT_ID> --domain <DOMAIN> --valid-days 365 --cert-out /tmp/my-cert.crt Upload /tmp/my-cert.crt in the Entra ID portal under Certificates & secrets > Certificates . The private key never leaves your TPM or software HSM. Note: These credentials expire, and you'll need to repeat these steps each time the credentials expire. Option B: Using Delegated Authentication If you do not configure confidential client credentials, add your application ID to himmelblau.conf for delegated authentication. [example.com] app_id = 98fa618b-e5d2-4697-b0fd-fe3ec5eecdd3 Replace with your actual Application (client) ID found in the app\u2019s Overview page. Note: This method prevents the enumeration of rfc2307 attributes and group memberships until after each user authenticates. Utilizing the aad-tool enumerate command can improve attribute resolution, but will need to be performed each time a new user is added to the directory (or whenever their posix attributes are added/modified). 5. Restart Himmelblau Services To apply changes, restart Himmelblau: sudo systemctl restart himmelblaud sudo systemctl restart himmelblaud-tasks 6. (Optional) Pre-cache UID/GID Mappings You can optionally pre-fetch all users and groups with RFC2307 attributes: aad-tool enumerate This avoids lookups being triggered on first login. 7. Managing Credentials List stored credentials: aad-tool cred list --domain <DOMAIN> Remove credentials if needed: aad-tool cred delete --domain <DOMAIN> Conclusion By following these steps, Himmelblau will be able to retrieve group information necessary for accurate ID mapping using Entra ID. Ensure that the application has the necessary permissions and is correctly configured in himmelblau.conf for seamless integration.","title":"Creating an Entra ID Application for Himmelblau GroupMember.Read.All and User.Read.All Permissions"},{"location":"advanced/Creating-an-Entra-ID-Application-for-Himmelblau-GroupMember.Read.All-and-User.Read.All-Permissions/#overview","text":"Himmelblau requires additional API permissions to read group names and extended attributes such as a groups' gidNumber or users' uidNumber (which is essential for RFC2307 attribute ID mapping). The following instructions guide you through registering an Azure Entra ID application, assigning it permissions, and configuring Himmelblau to use either delegated or confidential client authentication. With the default configuration, Himmelblau will attempt to resolve group memberships by masquerading as the Edge browser with delegated access , but this doesn't work in every tenant, and has the limitation of only resolving group memberships after each user has authenticated. Note: - If you set up confidential client credentials (client secret or certificate) using aad-tool cred , you do not need to specify an app_id in himmelblau.conf . - If you choose delegated access , you must set an app_id in your configuration.","title":"Overview"},{"location":"advanced/Creating-an-Entra-ID-Application-for-Himmelblau-GroupMember.Read.All-and-User.Read.All-Permissions/#1-register-a-new-application-in-azure-entra-id","text":"Navigate to the Azure Entra ID portal . In the left-hand menu, select App registrations . Click New registration . Enter a Name for the application (e.g., Himmelblau ). Under Supported account types , choose Accounts in this organizational directory only . Under Redirect URI , choose Public client/native (mobile & desktop) for the platform and enter himmelblau://Himmelblau.EntraId.BrokerPlugin for the URI. Click Register .","title":"1. Register a New Application in Azure Entra ID"},{"location":"advanced/Creating-an-Entra-ID-Application-for-Himmelblau-GroupMember.Read.All-and-User.Read.All-Permissions/#2-assign-api-permissions","text":"In the newly created application, navigate to API permissions . Click Add a permission . Select Microsoft Graph . If utilizing Confidential Client Credentials (Option A below) choose Application permissions , otherwise choose Delegated permissions (Option B). Search for GroupMember.Read.All and select it. Also search for User.Read.All and add this permission. Click Add permissions . Click Grant admin consent to approve these permissions for your tenant. Continue with the same procedure for the User.Read.All permission. Warning!: Never use Group.Read.All instead of the GroupMember.Read.All permission, because for Microsoft 365 groups, Group.* permissions grant the app access to the contents of the group ; for example, conversations, files, notes, and so on.","title":"2. Assign API Permissions"},{"location":"advanced/Creating-an-Entra-ID-Application-for-Himmelblau-GroupMember.Read.All-and-User.Read.All-Permissions/#3-obtain-the-application-id","text":"Go to Overview in the application\u2019s page. Copy the Application (client) ID . This value will be used in Himmelblau\u2019s configuration.","title":"3. Obtain the Application ID"},{"location":"advanced/Creating-an-Entra-ID-Application-for-Himmelblau-GroupMember.Read.All-and-User.Read.All-Permissions/#4-configure-authentication-in-himmelblau","text":"You have two main options for enumerating users and group memberships:","title":"4. Configure Authentication in Himmelblau"},{"location":"advanced/Creating-an-Entra-ID-Application-for-Himmelblau-GroupMember.Read.All-and-User.Read.All-Permissions/#option-a-using-confidential-client-credentials-recommended","text":"This method stores a client secret or client certificate securely in Himmelblau\u2019s encrypted cache and removes the need to specify an app_id in himmelblau.conf .","title":"Option A: Using Confidential Client Credentials (Recommended)"},{"location":"advanced/Creating-an-Entra-ID-Application-for-Himmelblau-GroupMember.Read.All-and-User.Read.All-Permissions/#store-a-client-secret","text":"aad-tool cred secret --client-id <CLIENT_ID> --domain <DOMAIN> --secret <SECRET_VALUE> In the Entra ID portal, under Certificates & secrets , create a new Client secret . Copy the Value immediately (you won\u2019t see it again) and use it with the above command.","title":"Store a client secret"},{"location":"advanced/Creating-an-Entra-ID-Application-for-Himmelblau-GroupMember.Read.All-and-User.Read.All-Permissions/#or-set-up-a-client-certificate","text":"aad-tool cred cert --client-id <CLIENT_ID> --domain <DOMAIN> --valid-days 365 --cert-out /tmp/my-cert.crt Upload /tmp/my-cert.crt in the Entra ID portal under Certificates & secrets > Certificates . The private key never leaves your TPM or software HSM. Note: These credentials expire, and you'll need to repeat these steps each time the credentials expire.","title":"Or set up a client certificate"},{"location":"advanced/Creating-an-Entra-ID-Application-for-Himmelblau-GroupMember.Read.All-and-User.Read.All-Permissions/#option-b-using-delegated-authentication","text":"If you do not configure confidential client credentials, add your application ID to himmelblau.conf for delegated authentication. [example.com] app_id = 98fa618b-e5d2-4697-b0fd-fe3ec5eecdd3 Replace with your actual Application (client) ID found in the app\u2019s Overview page. Note: This method prevents the enumeration of rfc2307 attributes and group memberships until after each user authenticates. Utilizing the aad-tool enumerate command can improve attribute resolution, but will need to be performed each time a new user is added to the directory (or whenever their posix attributes are added/modified).","title":"Option B: Using Delegated Authentication"},{"location":"advanced/Creating-an-Entra-ID-Application-for-Himmelblau-GroupMember.Read.All-and-User.Read.All-Permissions/#5-restart-himmelblau-services","text":"To apply changes, restart Himmelblau: sudo systemctl restart himmelblaud sudo systemctl restart himmelblaud-tasks","title":"5. Restart Himmelblau Services"},{"location":"advanced/Creating-an-Entra-ID-Application-for-Himmelblau-GroupMember.Read.All-and-User.Read.All-Permissions/#6-optional-pre-cache-uidgid-mappings","text":"You can optionally pre-fetch all users and groups with RFC2307 attributes: aad-tool enumerate This avoids lookups being triggered on first login.","title":"6. (Optional) Pre-cache UID/GID Mappings"},{"location":"advanced/Creating-an-Entra-ID-Application-for-Himmelblau-GroupMember.Read.All-and-User.Read.All-Permissions/#7-managing-credentials","text":"List stored credentials: aad-tool cred list --domain <DOMAIN> Remove credentials if needed: aad-tool cred delete --domain <DOMAIN>","title":"7. Managing Credentials"},{"location":"advanced/Creating-an-Entra-ID-Application-for-Himmelblau-GroupMember.Read.All-and-User.Read.All-Permissions/#conclusion","text":"By following these steps, Himmelblau will be able to retrieve group information necessary for accurate ID mapping using Entra ID. Ensure that the application has the necessary permissions and is correctly configured in himmelblau.conf for seamless integration.","title":"Conclusion"},{"location":"advanced/Design/","text":"Design Principles Adherence to Microsoft Specifications and Windows Behavior While the project aims to align with Microsoft specifications where feasible, our primary guiding principle is adherence to actual Windows behavior. This approach ensures compatibility and interoperability within Microsoft's authentication ecosystem while accommodating any deviations or inaccuracies found in the specifications. Interaction Diagrams Since we try to adhere to Windows behavior, it's helpful to review Microsoft design flows which explain those behaviors, such as How it works: Device registration and Primary Refresh Token Issuance . These flows are similar to the behavior of this project, but project specific design flows are provided here for clarity. Device Enrollment A: Enrollment is first initiated by authenticating to the https://enrollment.manage.microsoft.com resource. This is accomplished using the functions acquire_token_by_username_password_for_device_enrollment() , initiate_device_flow_for_device_enrollment() paired with acquire_token_by_device_flow() , or initiate_acquire_token_by_mfa_flow_for_device_enrollment() paired with acquire_token_by_mfa_flow() . The UserToken from the response is then provided in a call to enroll_device() . B: The enroll_device() function communicates with the TPM and creates 2 RSA keys. One will be used as the transport key, and the other will be used to create a Certificate Signing Request (CSR). The source for this request is found in src/auth.rs within the BrokerClientApplication struct implementation. C: enroll_device() sends a GET request to https://enterpriseregistration.windows.net requesting a list of available services. This request is defined in [MS-DRS] Section 3.1 and [MS-DVRD] Section 4.3 . The source for this request is found in src/discovery.rs . D: The enroll_device_internal() function processes the public transport key by generating a BCRYPT_RSAKEY_BLOB , which is then encoded in base64 format. E: The encoded transport key blob is subsequently included in the enrollment request payload, along with the Certificate Signing Request (CSR), which is also base64 encoded. These, included with the enrollment attributes passed to enroll_device() , are sent to the Azure DRS service for enrollment. The DRS service validates the access token received in A , creates a device id, then generates and signs a device certificate as requested. The device certificate is returned to the client. F: The device certificate is associated with the transport key in the TPM. MDM enrollment via Intune was implemented in Himmelblau 1.0. PRT Issuance via Username/Password A: The logon UI passes the UPN and password to acquire_user_prt_by_username_password() . B: build_jwt_by_username_password() gets a nonce from Microsoft Entra ID. C: build_jwt_by_username_password() constructs the authentication request with the user\u2019s credentials, nonce, and a scope, and signs the request with the Device key. acquire_user_prt_jwt() sends the request to Microsoft Entra ID. D: Microsoft Entra ID validates the user credentials, the nonce, and device signature, verifies that the device is valid in the tenant and issues the encrypted PRT. Along with the PRT, Microsoft Entra ID also issues a symmetric key, called the Session key encrypted by Microsoft Entra ID using the Transport key. In addition, the Session key is also embedded in the PRT. This Session key acts as the Proof-of-possession (PoP) key for subsequent requests with the PRT. Up to two Kerberos TGTs are embeded in the PRT, labeled tgt_ad and tgt_cloud . The first is an on-prem TGT (if configured), while the second is an Azure cloud TGT. E: acquire_user_prt_by_username_password() encrypts the PRT using the Transport key and returns the encrypted blob. exchange_prt_for_access_token() can then be called to obtain an access token for the user.","title":"Design Principles"},{"location":"advanced/Design/#design-principles","text":"","title":"Design Principles"},{"location":"advanced/Design/#adherence-to-microsoft-specifications-and-windows-behavior","text":"While the project aims to align with Microsoft specifications where feasible, our primary guiding principle is adherence to actual Windows behavior. This approach ensures compatibility and interoperability within Microsoft's authentication ecosystem while accommodating any deviations or inaccuracies found in the specifications.","title":"Adherence to Microsoft Specifications and Windows Behavior"},{"location":"advanced/Design/#interaction-diagrams","text":"Since we try to adhere to Windows behavior, it's helpful to review Microsoft design flows which explain those behaviors, such as How it works: Device registration and Primary Refresh Token Issuance . These flows are similar to the behavior of this project, but project specific design flows are provided here for clarity.","title":"Interaction Diagrams"},{"location":"advanced/Design/#device-enrollment","text":"A: Enrollment is first initiated by authenticating to the https://enrollment.manage.microsoft.com resource. This is accomplished using the functions acquire_token_by_username_password_for_device_enrollment() , initiate_device_flow_for_device_enrollment() paired with acquire_token_by_device_flow() , or initiate_acquire_token_by_mfa_flow_for_device_enrollment() paired with acquire_token_by_mfa_flow() . The UserToken from the response is then provided in a call to enroll_device() . B: The enroll_device() function communicates with the TPM and creates 2 RSA keys. One will be used as the transport key, and the other will be used to create a Certificate Signing Request (CSR). The source for this request is found in src/auth.rs within the BrokerClientApplication struct implementation. C: enroll_device() sends a GET request to https://enterpriseregistration.windows.net requesting a list of available services. This request is defined in [MS-DRS] Section 3.1 and [MS-DVRD] Section 4.3 . The source for this request is found in src/discovery.rs . D: The enroll_device_internal() function processes the public transport key by generating a BCRYPT_RSAKEY_BLOB , which is then encoded in base64 format. E: The encoded transport key blob is subsequently included in the enrollment request payload, along with the Certificate Signing Request (CSR), which is also base64 encoded. These, included with the enrollment attributes passed to enroll_device() , are sent to the Azure DRS service for enrollment. The DRS service validates the access token received in A , creates a device id, then generates and signs a device certificate as requested. The device certificate is returned to the client. F: The device certificate is associated with the transport key in the TPM. MDM enrollment via Intune was implemented in Himmelblau 1.0.","title":"Device Enrollment"},{"location":"advanced/Design/#prt-issuance-via-usernamepassword","text":"A: The logon UI passes the UPN and password to acquire_user_prt_by_username_password() . B: build_jwt_by_username_password() gets a nonce from Microsoft Entra ID. C: build_jwt_by_username_password() constructs the authentication request with the user\u2019s credentials, nonce, and a scope, and signs the request with the Device key. acquire_user_prt_jwt() sends the request to Microsoft Entra ID. D: Microsoft Entra ID validates the user credentials, the nonce, and device signature, verifies that the device is valid in the tenant and issues the encrypted PRT. Along with the PRT, Microsoft Entra ID also issues a symmetric key, called the Session key encrypted by Microsoft Entra ID using the Transport key. In addition, the Session key is also embedded in the PRT. This Session key acts as the Proof-of-possession (PoP) key for subsequent requests with the PRT. Up to two Kerberos TGTs are embeded in the PRT, labeled tgt_ad and tgt_cloud . The first is an on-prem TGT (if configured), while the second is an Azure cloud TGT. E: acquire_user_prt_by_username_password() encrypts the PRT using the Transport key and returns the encrypted blob. exchange_prt_for_access_token() can then be called to obtain an access token for the user.","title":"PRT Issuance via Username/Password"},{"location":"advanced/Device-Compliance-Settings-for-Linux-in-Intune-with-Himmelblau/","text":"Device Compliance Settings for Linux in Intune with Himmelblau Himmelblau supports Microsoft Intune compliance policies for Linux by interpreting and enforcing policy settings locally\u2014without requiring the Microsoft Intune app. This enables Linux systems to participate in compliance workflows while maintaining digital sovereignty and compatibility with a wide variety of distributions. \u26a0\ufe0f Critical Behavior Difference: In Himmelblau, non-compliance results in immediate authentication failure . If a device does not meet compliance requirements, login is denied. This is different from Microsoft Intune, where non-compliance typically results in a policy flag or limited access. Plan and test your policies accordingly. Himmelblau policies are configured using the Microsoft Intune Settings Catalog. When creating a compliance policy, select the desired settings as you would for other platforms. Policy Enforcement in Himmelblau To enable policy enforcement, you must set the following global configuration in himmelblau.conf : apply_policy = true Without this setting, compliance policies will not be evaluated or enforced. Linux Settings Categories Allowed Distributions Define minimum and maximum OS versions for specific distributions. Devices outside the allowed range will be marked non-compliant. \u26a0\ufe0f Warning: Enforcing this setting may prevent some Himmelblau systems from authenticating. While Intune only supports Ubuntu and RedHat, Himmelblau is compatible with many more Linux distributions. If a user attempts to log in from an unsupported or disallowed distro, authentication will fail. Custom Compliance Custom compliance settings are currently experimental in Himmelblau. You must explicitly enable them: enable_experimental_intune_custom_compliance = true Once enabled, Himmelblau will attempt to evaluate any custom compliance rules defined in your Intune policy. These are executed locally, and any failure results in blocked authentication. See Microsoft's documentation for guidance on policy creation. \u26a0\ufe0f Note: The Custom Compliance status is not reliably reported to Intune . Device Encryption Enforce disk encryption using dm-crypt (typically via LUKS and cryptsetup ). Himmelblau checks for encrypted fixed writable volumes. \ud83d\udca1 For best results, enable encryption during OS installation. Post-install encryption may be time-consuming and complex. Password Policy These settings apply to the Linux Hello PIN , not the user's system password. \u26a0\ufe0f Important: Enforcing certain complexity rules (e.g., uppercase, symbols) will prevent numeric-only PINs. This may confuse users expecting a simple PIN login experience. Supported rules: Minimum Lowercase Minimum Uppercase Minimum Symbols Minimum Length Minimum Digits Users supplying non-compliant PINs will be denied PIN enrollment . Refreshing Compliance Status Compliance is checked during login. To force re-evaluation, simply re-authenticate.","title":"Device Compliance Settings for Linux in Intune with Himmelblau"},{"location":"advanced/Device-Compliance-Settings-for-Linux-in-Intune-with-Himmelblau/#device-compliance-settings-for-linux-in-intune-with-himmelblau","text":"Himmelblau supports Microsoft Intune compliance policies for Linux by interpreting and enforcing policy settings locally\u2014without requiring the Microsoft Intune app. This enables Linux systems to participate in compliance workflows while maintaining digital sovereignty and compatibility with a wide variety of distributions. \u26a0\ufe0f Critical Behavior Difference: In Himmelblau, non-compliance results in immediate authentication failure . If a device does not meet compliance requirements, login is denied. This is different from Microsoft Intune, where non-compliance typically results in a policy flag or limited access. Plan and test your policies accordingly. Himmelblau policies are configured using the Microsoft Intune Settings Catalog. When creating a compliance policy, select the desired settings as you would for other platforms.","title":"Device Compliance Settings for Linux in Intune with Himmelblau"},{"location":"advanced/Device-Compliance-Settings-for-Linux-in-Intune-with-Himmelblau/#policy-enforcement-in-himmelblau","text":"To enable policy enforcement, you must set the following global configuration in himmelblau.conf : apply_policy = true Without this setting, compliance policies will not be evaluated or enforced.","title":"Policy Enforcement in Himmelblau"},{"location":"advanced/Device-Compliance-Settings-for-Linux-in-Intune-with-Himmelblau/#linux-settings-categories","text":"","title":"Linux Settings Categories"},{"location":"advanced/Device-Compliance-Settings-for-Linux-in-Intune-with-Himmelblau/#allowed-distributions","text":"Define minimum and maximum OS versions for specific distributions. Devices outside the allowed range will be marked non-compliant. \u26a0\ufe0f Warning: Enforcing this setting may prevent some Himmelblau systems from authenticating. While Intune only supports Ubuntu and RedHat, Himmelblau is compatible with many more Linux distributions. If a user attempts to log in from an unsupported or disallowed distro, authentication will fail.","title":"Allowed Distributions"},{"location":"advanced/Device-Compliance-Settings-for-Linux-in-Intune-with-Himmelblau/#custom-compliance","text":"Custom compliance settings are currently experimental in Himmelblau. You must explicitly enable them: enable_experimental_intune_custom_compliance = true Once enabled, Himmelblau will attempt to evaluate any custom compliance rules defined in your Intune policy. These are executed locally, and any failure results in blocked authentication. See Microsoft's documentation for guidance on policy creation. \u26a0\ufe0f Note: The Custom Compliance status is not reliably reported to Intune .","title":"Custom Compliance"},{"location":"advanced/Device-Compliance-Settings-for-Linux-in-Intune-with-Himmelblau/#device-encryption","text":"Enforce disk encryption using dm-crypt (typically via LUKS and cryptsetup ). Himmelblau checks for encrypted fixed writable volumes. \ud83d\udca1 For best results, enable encryption during OS installation. Post-install encryption may be time-consuming and complex.","title":"Device Encryption"},{"location":"advanced/Device-Compliance-Settings-for-Linux-in-Intune-with-Himmelblau/#password-policy","text":"These settings apply to the Linux Hello PIN , not the user's system password. \u26a0\ufe0f Important: Enforcing certain complexity rules (e.g., uppercase, symbols) will prevent numeric-only PINs. This may confuse users expecting a simple PIN login experience. Supported rules: Minimum Lowercase Minimum Uppercase Minimum Symbols Minimum Length Minimum Digits Users supplying non-compliant PINs will be denied PIN enrollment .","title":"Password Policy"},{"location":"advanced/Device-Compliance-Settings-for-Linux-in-Intune-with-Himmelblau/#refreshing-compliance-status","text":"Compliance is checked during login. To force re-evaluation, simply re-authenticate.","title":"Refreshing Compliance Status"},{"location":"advanced/Enabling-the-Himmelblau-QR-Greeter-gnome%E2%80%90shell-Extension/","text":"Download and Install the Extension Package Download the appropriate package for your distribution The package is called himmelblau-qr-greeter . Follow your distribution\u2019s instructions for installing system packages. Enable the Extension for the GDM User Since the extension runs on the GDM (login) screen, you must enable it as the gdm user. Run the following commands: Open a shell as the gdm user: sudo machinectl shell gdm@ /bin/bash Enable the extension for GDM: gsettings set org.gnome.shell enabled-extensions \"['qr-greeter@himmelblau-idm.org']\" Exit the shell: exit Restart GDM To apply the changes, restart GDM: sudo systemctl restart gdm3 After these steps, the Himmelblau QR Greeter extension will be active on your login and lock screens.","title":"Enabling the Himmelblau QR Greeter gnome\u2010shell Extension"},{"location":"advanced/MS-specs-which-Himmelblau-uses/","text":"This page is intended as a place to gather all the MS specification documents that Himmelblau implements, as well as comments about the accuracy of the specs. [MS-OAPX] : OAuth 2.0 Protocol Extensions Used in the MSAL PublicClientApplication for general authentication. [MS-OAPXBC] : OAuth 2.0 Protocol Extensions for Broker Clients Used in the MSAL BrokerClientApplication for PRT requests. [MS-DVRJ] : Device Registration Join Protocol Sections 3.1.5.1.1.1 and 3.1.5.1.1.2 are mostly accurate and used in [MS-DRS] Section 2.1 . [MS-DVRE] : Device Registration Enrollment Protocol This protocol appears to be used by the DRS service in Azure to enroll the client device. Section 2.3.3 Alt-Security-Identities matches the device object which is created within the directory. The client does not use this protocol, but is useful as a reference. [MS-DVRD] : Device Registration Discovery Protocol Accurate, but missing many services, see [MS-DRS] Section 3.1 . [MS-KPP] : Key Provisioning Protocol This is used by MSAL to provision a Windows Hello for Business key. The process for requesting a PRT using that key does not appear to be document (although MSAL copies Windows behavior here to request the PRT).","title":"MS specs which Himmelblau uses"},{"location":"advanced/Syncing-Active-Directory-with-Azure-Entra-ID/","text":"3. Install and Configure Microsoft Entra Connect Download Microsoft Entra Connect from Microsoft: https://www.microsoft.com/en-us/download/details.aspx?id=47594 Run the installer on your AD domain controller or another dedicated server. Choose \"Custom installation\" (recommended for better control). Connect to Azure Entra ID using Global Admin credentials . Connect to Active Directory : Enter your AD DS credentials (Enterprise Admin). It should verify and list your domain. Choose Sync Options : If you want password hash synchronization (PHS), select it. If using Pass-through Authentication (PTA) or Federation, configure as needed. Select \"Start Synchronization\" and finish setup.","title":"Syncing Active Directory with Azure Entra ID"},{"location":"advanced/Syncing-Active-Directory-with-Azure-Entra-ID/#3-install-and-configure-microsoft-entra-connect","text":"Download Microsoft Entra Connect from Microsoft: https://www.microsoft.com/en-us/download/details.aspx?id=47594 Run the installer on your AD domain controller or another dedicated server. Choose \"Custom installation\" (recommended for better control). Connect to Azure Entra ID using Global Admin credentials . Connect to Active Directory : Enter your AD DS credentials (Enterprise Admin). It should verify and list your domain. Choose Sync Options : If you want password hash synchronization (PHS), select it. If using Pass-through Authentication (PTA) or Federation, configure as needed. Select \"Start Synchronization\" and finish setup.","title":"3. Install and Configure Microsoft Entra Connect"},{"location":"advanced/Tray-Icons-for-o365-on-GNOME-Shell/","text":"Tray Icons for o365 on GNOME Shell The Himmelblau o365 package integrates Microsoft Office desktop applications (Teams, Outlook, Word, Excel, PowerPoint, etc.) with Linux. These applications rely on tray icons for managing their background processes and quick-access menus. GNOME Shell and Tray Icons GNOME Shell does not display tray icons by default. If you are using GNOME, the Office apps provided by o365 will not expose their controls unless tray icon support is enabled. Enabling Tray Icons To enable tray icon support in GNOME Shell: Visit the official GNOME Extensions website: \ud83d\udc49 AppIndicator Support Extension Toggle the switch to ON to install and enable AppIndicator and KStatusNotifierItem Support . Once enabled, the tray icons for all o365 apps will appear in the top panel next to your system indicators. \u2705 This step is only required if you use the o365 package .","title":"Tray Icons for o365 on GNOME Shell"},{"location":"advanced/Tray-Icons-for-o365-on-GNOME-Shell/#tray-icons-for-o365-on-gnome-shell","text":"The Himmelblau o365 package integrates Microsoft Office desktop applications (Teams, Outlook, Word, Excel, PowerPoint, etc.) with Linux. These applications rely on tray icons for managing their background processes and quick-access menus.","title":"Tray Icons for o365 on GNOME Shell"},{"location":"advanced/Tray-Icons-for-o365-on-GNOME-Shell/#gnome-shell-and-tray-icons","text":"GNOME Shell does not display tray icons by default. If you are using GNOME, the Office apps provided by o365 will not expose their controls unless tray icon support is enabled.","title":"GNOME Shell and Tray Icons"},{"location":"advanced/Tray-Icons-for-o365-on-GNOME-Shell/#enabling-tray-icons","text":"To enable tray icon support in GNOME Shell: Visit the official GNOME Extensions website: \ud83d\udc49 AppIndicator Support Extension Toggle the switch to ON to install and enable AppIndicator and KStatusNotifierItem Support . Once enabled, the tray icons for all o365 apps will appear in the top panel next to your system indicators. \u2705 This step is only required if you use the o365 package .","title":"Enabling Tray Icons"},{"location":"reference/aad-tool/","text":"NAME aad-tool - Azure Entra ID (AAD) management utility for Himmelblau SYNOPSIS aad-tool <COMMAND> [OPTIONS] DESCRIPTION The aad-tool utility is part of the Himmelblau project, designed to manage and interact with Azure Entra ID through various commands. It allows you to test authentication, manage caches, and check the status of services related to the himmelblaud resolver. SYNOPSIS aad-tool <COMMAND> DESCRIPTION Himmelblau Management Utility Commands: application Manage Entra ID application registrations, including creation, listing, and extension schema configuration auth-test Test authentication of a user via the himmelblaud resolver \"pam\" channel. This does not test that your pam configuration is correct - only that himmelblaud is correctly processing and validating authentications cache-clear Clear or invalidate the himmelblaud resolver cache cache-invalidate (Deprecated) Previously used to mark cache entries as stale for immediate refresh. Now behaves identically to cache-clear and will be removed in a future release configure-pam Configure PAM to use pam_himmelblau cred Manage confidential client credentials for authenticating to Entra ID enumerate Enumerate all users and groups in Entra ID that have rfc2307 attributes, and cache their values locally. This addresses the issue where UID/GID mappings are needed before authentication can succeed, but are normally only retrievable after login user Manage Entra ID user accounts, including POSIX attribute assignment and UID mapping group Manage Entra ID groups, including POSIX attribute assignment and GID mapping idmap Manage the static idmapping cache used to map Entra ID accounts to static UID/GID values. This is useful for migrations from on-prem AD to Entra ID, where existing UID/GID mappings need to be preserved offline-breakglass Activate or deactivate Himmelblau's offline breakglass mode status Check that the himmelblaud daemon is online and able to connect correctly to the himmelblaud server tpm Check whether Himmelblau is utilizing the TPM version Show the version of this tool help Print this message or the help of the given subcommand(s) OPTIONS -h , --help Print help SUBCOMMAND aad-tool application add-schema-extensions [ OPTIONS ] --client-id <CLIENT_ID> --schema-app-object-id <SCHEMA_APP_OBJECT_ID> DESCRIPTION Adds a standard set of POSIX-related schema extensions to an existing Entra ID application. This command registers directory extension attributes (e.g., uidNumber , gidNumber , unixHomeDirectory , loginShell , gecos ) on the application specified by --schema-app-object-id . These extensions will be usable on user and/or group objects, as appropriate. The application specified by --schema-app-object-id must already exist in the tenant, and must be identified by its Object ID (not the Client ID). This value is labeled as \"Object ID\" in the Entra Admin Center and corresponds to the id field in Graph API responses. You must also supply a separate --client-id that grants Application.ReadWrite.All permissions to perform the extension registration. If the --name parameter is omitted, the command authenticates as the currently logged-in user via the Himmelblau SSO broker. If the --name parameter is provided, the command attempts to authenticate as the specified Entra ID user. In this case, the command must be run as root to impersonate another user. This command must be run from a device that has already been joined to Entra ID. OPTIONS -d , --debug -D , --name <ACCOUNT_ID> --client-id <CLIENT_ID> --schema-app-object-id <SCHEMA_APP_OBJECT_ID> -h , --help Print help (see a summary with '-h') SUBCOMMAND aad-tool application create [ OPTIONS ] --client-id <CLIENT_ID> --display-name <DISPLAY_NAME> DESCRIPTION Creates a new Entra ID application registration in the current tenant. This command performs a delegated Microsoft Graph API request using an access token acquired via the specified client application ( --client-id ), which must have Application.ReadWrite.All permissions in the tenant. The new application will be created with the provided --display-name . You may specify one or more --redirect-uri options to configure redirect URIs for the application (used for public client authentication). If no redirect URIs are provided, the application will not include any by default. Use the --user-read-write and/or --group-read-write flags to grant the application additional Microsoft Graph API permissions at registration time, including User.ReadWrite.All and Group.ReadWrite.All . NOTE: If you grant these permissions, it is strongly recommended that you restrict access to the application to specific administrators or groups: In the Microsoft Entra admin portal, go to Entra???ID -> Enterprise applications and find your app's entry. 2. Under Properties, set \"Assignment required?\" to Yes. 3. Go to Users and groups, click Add, and assign only the specific users or groups you want to have access. If the --name parameter is omitted, the command authenticates as the currently logged-in user via the Himmelblau SSO broker. If the --name parameter is provided, the command attempts to authenticate as the specified Entra ID user. In this case, the command must be run as root to impersonate another user. This command must be run from a device that has already been joined to Entra ID. OPTIONS -d , --debug -D , --name <ACCOUNT_ID> --client-id <CLIENT_ID> --display-name <DISPLAY_NAME> --redirect-uri <URI> --user-read-write --group-read-write -h , --help Print help (see a summary with '-h') SUBCOMMAND aad-tool application list-schema-extensions [ OPTIONS ] --client-id <CLIENT_ID> --schema-app-object-id <SCHEMA_APP_OBJECT_ID> DESCRIPTION Lists the schema extension attributes registered on an Entra ID application. This command retrieves the directory extension attributes (e.g., uidNumber , gidNumber , etc.) that have been added to the application identified by --schema-app-object-id . The --schema-app-object-id parameter must be the Object ID of the application (not the Client ID), as shown in the Entra Admin Center. This value corresponds to the id field in Microsoft Graph and is required to query extension properties. You must also supply a separate --client-id that grants Application.Read.All or Application.ReadWrite.All permissions in the tenant to perform this query. If the --name parameter is omitted, the command authenticates as the currently logged-in user via the Himmelblau SSO broker. If the --name parameter is provided, the command attempts to authenticate as the specified Entra ID user. In this case, the command must be run as root to impersonate another user. This command must be run from a device that has already been joined to Entra ID. OPTIONS -d , --debug -D , --name <ACCOUNT_ID> --client-id <CLIENT_ID> --schema-app-object-id <SCHEMA_APP_OBJECT_ID> -h , --help Print help (see a summary with '-h') SUBCOMMAND aad-tool application list [ OPTIONS ] --client-id <CLIENT_ID> DESCRIPTION Lists Entra ID application registrations in the current tenant. This command performs a delegated Microsoft Graph API request using an access token acquired via the specified client application ( --client-id ), which must have Application.Read.All permissions in the tenant. If the --name parameter is omitted, the command authenticates as the currently logged-in user via the Himmelblau SSO broker. If the --name parameter is provided, the command attempts to authenticate as the specified Entra ID user. In this case, the command must be run as root to impersonate another user. This command must be run from a device that has already been joined to Entra ID. OPTIONS -d , --debug -D , --name <ACCOUNT_ID> --client-id <CLIENT_ID> -h , --help Print help (see a summary with '-h') SUBCOMMAND aad-tool auth-test [ OPTIONS ] --name <ACCOUNT_ID> DESCRIPTION Test authentication of a user via the himmelblaud resolver \"pam\" channel. This does not test that your pam configuration is correct - only that himmelblaud is correctly processing and validating authentications OPTIONS -d , --debug -D , --name <ACCOUNT_ID> -h , --help Print help SUBCOMMAND aad-tool cache-clear [ OPTIONS ] DESCRIPTION Clear or invalidate the himmelblaud resolver cache. By default, this marks all cached user and group entries as stale, forcing them to refresh immediately when next used. Specify --nss or --mapped to clear these individual caches as well. Omit both these to clear them all. Use --full to completely purge the user and group cache entries and unjoin the host from Entra ID. This is irreversible. OPTIONS -d , --debug --nss Only clear the nss cache --mapped Only clear the mapped name cache --full Force a full cache wipe and unjoin the host from Entra ID. This is probably not what you want -h , --help Print help (see a summary with '-h') SUBCOMMAND aad-tool cache-invalidate [ OPTIONS ] DESCRIPTION (Deprecated) Previously used to mark cache entries as stale for immediate refresh. Now behaves identically to cache-clear and will be removed in a future release OPTIONS -d , --debug --nss --mapped --full -h , --help Print help SUBCOMMAND aad-tool configure-pam [ OPTIONS ] DESCRIPTION Configure PAM to use pam_himmelblau OPTIONS -d , --debug --really --auth-file <AUTH_FILE> --account-file <ACCOUNT_FILE> --session-file <SESSION_FILE> --password-file <PASSWORD_FILE> -h , --help Print help SUBCOMMAND aad-tool cred cert [ OPTIONS ] --client-id <CLIENT_ID> --domain <DOMAIN> --valid-days <VALID_DAYS> --cert-out <CERT_OUT> DESCRIPTION Generate an RS256 HSM-backed key pair with a self-signed certificate for confidential client authentication. To set this up: In the Entra ID portal, navigate to Azure Active Directory -> App registrations, then open (or create) your application. Under Manage > Certificates & secrets, go to the Certificates tab. Click Upload certificate and select the PEM file generated by this command. Azure will store this cert for authenticating via public key. The private key never leaves your TPM (or SoftHSM). When this cred needs renewed in the future, simple run this command again to replace the expired certificate. Example: aad-tool cred cert --client-id <CLIENT_ID> --valid-days 365 --cert-out /tmp/my-cert.crt OPTIONS -d , --debug --client-id <CLIENT_ID> The Azure AD application (client) ID this certificate is associated with --domain <DOMAIN> The tenant domain this certificate is associated with --valid-days <VALID_DAYS> Number of days the self-signed certificate will be valid --cert-out <CERT_OUT> Path to write the generated PEM certificate file. This is the file you will upload to Entra ID -h , --help Print help (see a summary with '-h') SUBCOMMAND aad-tool cred delete [ OPTIONS ] --domain <DOMAIN> DESCRIPTION Delete confidential client credentials (secret, certificate, or both) This deletes stored confidential client credentials from Himmelblau's encrypted cache. If neither --secret nor --cert is specified, both will be deleted. Example: aad-tool cred delete --domain <DOMAIN> aad-tool cred delete --domain <DOMAIN> --secret aad-tool cred delete --domain <DOMAIN> --cert OPTIONS -d , --debug --domain <DOMAIN> The tenant domain whose creds will be deleted --secret Delete only the client secret (not the certificate) --cert Delete only the client certificate (not the secret) -h , --help Print help (see a summary with '-h') SUBCOMMAND aad-tool cred list [ OPTIONS ] --domain <DOMAIN> DESCRIPTION List the presence of confidential client credentials This checks Himmelblau's encrypted cache to see whether a client secret and/or client certificate exists for the given domain. Example: aad-tool cred list --domain <DOMAIN> OPTIONS -d , --debug --domain <DOMAIN> -h , --help Print help (see a summary with '-h') SUBCOMMAND aad-tool cred secret [ OPTIONS ] --client-id <CLIENT_ID> --domain <DOMAIN> --secret <SECRET> DESCRIPTION Store a client secret for confidential client authentication. To set this up: In the Entra ID portal, navigate to Azure Active Directory -> App registrations, then open (or create) your application. Under Manage > Certificates & secrets, go to the Client secrets tab. Click New client secret, choose an expiry, and click Add. Copy the Value (not Secret ID) immediately. You won't be able to see it again. Use that value with this command to store it in Himmelblau's encrypted cache. When this cred needs renewed in the future, simple run this command again to replace the expired secret. Example: aad-tool cred secret --client-id <CLIENT_ID> --secret <SECRET_VALUE> OPTIONS -d , --debug --client-id <CLIENT_ID> The Azure AD application (client) ID this secret is associated with --domain <DOMAIN> The tenant domain this secret is associated with --secret <SECRET> The client secret value copied from the Entra ID portal -h , --help Print help (see a summary with '-h') SUBCOMMAND aad-tool enumerate [ OPTIONS ] DESCRIPTION Enumerate all users and groups in Entra ID that have rfc2307 attributes, and cache their values locally. This addresses the issue where UID/GID mappings are needed before authentication can succeed, but are normally only retrievable after login. The --client-id parameter is optional and must refer to a registered Entra ID application with User.Read.All and Group.Read.All permissions. The --name parameter specifies the Entra ID user on whose behalf the token is requested, enabling delegated access through the specified client application. This command can only be executed from an Entra Id enrolled host. OPTIONS -d , --debug -D , --name <ACCOUNT_ID> --client-id <CLIENT_ID> -h , --help Print help (see a summary with '-h') SUBCOMMAND aad-tool group set-posix-attrs [ OPTIONS ] --schema-client-id <SCHEMA_CLIENT_ID> --group-id <GROUP_ID> --gid <GID> DESCRIPTION Sets POSIX-related attributes on a specified Entra ID group object. This command updates the gidNumber attribute on the Entra ID group identified by --group-id , which must be a valid Object ID. You must also provide the --schema-client-id , which identifies the application where the extension properties were registered. This value must be the Client ID of the application used for schema registration. The application associated with --schema-client-id must supply Group.ReadWrite.All permissions in the tenant. If the --name parameter is omitted, the command authenticates as the currently logged-in user via the Himmelblau SSO broker. If the --name parameter is provided, the command must be run as root to impersonate another user. This command must be run from a device that has already been joined to Entra ID. OPTIONS -d , --debug -D , --name <ACCOUNT_ID> --schema-client-id <SCHEMA_CLIENT_ID> --group-id <GROUP_ID> --gid <GID> -h , --help Print help (see a summary with '-h') SUBCOMMAND aad-tool idmap clear [ OPTIONS ] DESCRIPTION Clear the contents of the idmap static cache OPTIONS -d , --debug -h , --help Print help SUBCOMMAND aad-tool idmap group-add [ OPTIONS ] --object_id <OBJECT_ID> --gid <GID> DESCRIPTION Add a static group mapping to the idmap cache. This maps an Entra ID group (by Object Id GUID) to a fixed GID. This can be used to maintain group identity and membership compatibility after moving to Entra ID OPTIONS -d , --debug -D , --object_id <OBJECT_ID> -g , --gid <GID> -h , --help Print help SUBCOMMAND aad-tool idmap user-add [ OPTIONS ] --name <ACCOUNT_ID> --uid <UID> --gid <GID> DESCRIPTION Add a static user mapping to the idmap cache. This maps an Entra ID user (by UPN or SAM-compatible name) to a fixed UID and primary group GID OPTIONS -d , --debug -D , --name <ACCOUNT_ID> -u , --uid <UID> -g , --gid <GID> -h , --help Print help SUBCOMMAND aad-tool offline-breakglass [ OPTIONS ] DESCRIPTION Activate or deactivate Himmelblau's offline breakglass mode. This command enables temporary offline password authentication when Azure Entra ID is unreachable. When invoked, Himmelblau enters a controlled \"breakglass\" state, allowing cached Entra ID user passwords to be used for login until the TTL expires. Breakglass mode can only be activated if it was previously enabled in /etc/himmelblau/himmelblau.conf under the [offline_breakglass] section. If the feature was disabled, calling this command will have no effect, and no password verifiers will have been cached. Once activated, Himmelblau will: * Allow cached Entra ID users to log in using their known password. * Automatically exit breakglass mode after the TTL expires or once Entra ID connectivity has been restored. Use --ttl to override the configured duration for this session. The TTL value accepts a time unit suffix ( m , h , or d ) and defaults to the value defined in himmelblau.conf if omitted. To manually exit breakglass mode before TTL expiry, run: aad-tool offline-breakglass --ttl 0 OPTIONS -d , --debug --ttl <TTL> -h , --help Print help (see a summary with '-h') EXAMPLES Activate breakglass mode for 2 hours aad-tool offline-breakglass --ttl 2h Force disable breakglass mode immediately aad-tool offline-breakglass --ttl 0 Use the configured default TTL (from himmelblau.conf) aad-tool offline-breakglass Notes: - If [offline_breakglass] enabled = false in himmelblau.conf, this command will do nothing. - Himmelblau will not cache Entra ID password hashes unless offline breakglass has been explicitly enabled in advance. - This feature should only be used for emergency access during verified outages. SUBCOMMAND aad-tool status [ OPTIONS ] DESCRIPTION Check that the himmelblaud daemon is online and able to connect correctly to the himmelblaud server OPTIONS -d , --debug -h , --help Print help SUBCOMMAND aad-tool tpm [ OPTIONS ] DESCRIPTION Check whether Himmelblau is utilizing the TPM OPTIONS -d , --debug -h , --help Print help SUBCOMMAND aad-tool user set-posix-attrs [ OPTIONS ] --schema-client-id <SCHEMA_CLIENT_ID> --user-id <USER_ID> DESCRIPTION Sets POSIX-related attributes on a specified Entra ID user object. This command updates POSIX attributes ( uidNumber , gidNumber , unixHomeDirectory , loginShell , and gecos ) on the Entra ID user identified by --user-id , which must be a valid Object ID or UPN. You must also provide the --schema-client-id , which identifies the application where the extension properties were registered. This value must be the Client ID of the application used for schema registration. The application associated with --schema-client-id must supply User.ReadWrite.All permissions in the tenant. If the --name parameter is omitted, the command authenticates as the currently logged-in user via the Himmelblau SSO broker. If the --name parameter is provided, the command must be run as root to impersonate another user. This command must be run from a device that has already been joined to Entra ID. OPTIONS -d , --debug -D , --name <ACCOUNT_ID> --schema-client-id <SCHEMA_CLIENT_ID> --user-id <USER_ID> --uid <UID> --gid <GID> --home <HOME> --shell <SHELL> --gecos <GECOS> -h , --help Print help (see a summary with '-h') SEE ALSO himmelblau.conf (5), himmelblaud (8), himmelblaud-tasks (8) AUTHOR David Mulder <dmulder@himmelblau-idm.org>, <dmulder@samba.org>","title":"Aad tool"},{"location":"reference/aad-tool/#name","text":"aad-tool - Azure Entra ID (AAD) management utility for Himmelblau","title":"NAME"},{"location":"reference/aad-tool/#synopsis","text":"aad-tool <COMMAND> [OPTIONS]","title":"SYNOPSIS"},{"location":"reference/aad-tool/#description","text":"The aad-tool utility is part of the Himmelblau project, designed to manage and interact with Azure Entra ID through various commands. It allows you to test authentication, manage caches, and check the status of services related to the himmelblaud resolver.","title":"DESCRIPTION"},{"location":"reference/aad-tool/#synopsis_1","text":"aad-tool <COMMAND>","title":"SYNOPSIS"},{"location":"reference/aad-tool/#description_1","text":"Himmelblau Management Utility","title":"DESCRIPTION"},{"location":"reference/aad-tool/#commands","text":"application Manage Entra ID application registrations, including creation, listing, and extension schema configuration auth-test Test authentication of a user via the himmelblaud resolver \"pam\" channel. This does not test that your pam configuration is correct - only that himmelblaud is correctly processing and validating authentications cache-clear Clear or invalidate the himmelblaud resolver cache cache-invalidate (Deprecated) Previously used to mark cache entries as stale for immediate refresh. Now behaves identically to cache-clear and will be removed in a future release configure-pam Configure PAM to use pam_himmelblau cred Manage confidential client credentials for authenticating to Entra ID enumerate Enumerate all users and groups in Entra ID that have rfc2307 attributes, and cache their values locally. This addresses the issue where UID/GID mappings are needed before authentication can succeed, but are normally only retrievable after login user Manage Entra ID user accounts, including POSIX attribute assignment and UID mapping group Manage Entra ID groups, including POSIX attribute assignment and GID mapping idmap Manage the static idmapping cache used to map Entra ID accounts to static UID/GID values. This is useful for migrations from on-prem AD to Entra ID, where existing UID/GID mappings need to be preserved offline-breakglass Activate or deactivate Himmelblau's offline breakglass mode status Check that the himmelblaud daemon is online and able to connect correctly to the himmelblaud server tpm Check whether Himmelblau is utilizing the TPM version Show the version of this tool help Print this message or the help of the given subcommand(s)","title":"Commands:"},{"location":"reference/aad-tool/#options","text":"-h , --help Print help","title":"OPTIONS"},{"location":"reference/aad-tool/#subcommand","text":"aad-tool application add-schema-extensions [ OPTIONS ] --client-id <CLIENT_ID> --schema-app-object-id <SCHEMA_APP_OBJECT_ID>","title":"SUBCOMMAND"},{"location":"reference/aad-tool/#description_2","text":"Adds a standard set of POSIX-related schema extensions to an existing Entra ID application. This command registers directory extension attributes (e.g., uidNumber , gidNumber , unixHomeDirectory , loginShell , gecos ) on the application specified by --schema-app-object-id . These extensions will be usable on user and/or group objects, as appropriate. The application specified by --schema-app-object-id must already exist in the tenant, and must be identified by its Object ID (not the Client ID). This value is labeled as \"Object ID\" in the Entra Admin Center and corresponds to the id field in Graph API responses. You must also supply a separate --client-id that grants Application.ReadWrite.All permissions to perform the extension registration. If the --name parameter is omitted, the command authenticates as the currently logged-in user via the Himmelblau SSO broker. If the --name parameter is provided, the command attempts to authenticate as the specified Entra ID user. In this case, the command must be run as root to impersonate another user. This command must be run from a device that has already been joined to Entra ID.","title":"DESCRIPTION"},{"location":"reference/aad-tool/#options_1","text":"-d , --debug -D , --name <ACCOUNT_ID> --client-id <CLIENT_ID> --schema-app-object-id <SCHEMA_APP_OBJECT_ID> -h , --help Print help (see a summary with '-h')","title":"OPTIONS"},{"location":"reference/aad-tool/#subcommand_1","text":"aad-tool application create [ OPTIONS ] --client-id <CLIENT_ID> --display-name <DISPLAY_NAME>","title":"SUBCOMMAND"},{"location":"reference/aad-tool/#description_3","text":"Creates a new Entra ID application registration in the current tenant. This command performs a delegated Microsoft Graph API request using an access token acquired via the specified client application ( --client-id ), which must have Application.ReadWrite.All permissions in the tenant. The new application will be created with the provided --display-name . You may specify one or more --redirect-uri options to configure redirect URIs for the application (used for public client authentication). If no redirect URIs are provided, the application will not include any by default. Use the --user-read-write and/or --group-read-write flags to grant the application additional Microsoft Graph API permissions at registration time, including User.ReadWrite.All and Group.ReadWrite.All . NOTE: If you grant these permissions, it is strongly recommended that you restrict access to the application to specific administrators or groups: In the Microsoft Entra admin portal, go to Entra???ID -> Enterprise applications and find your app's entry. 2. Under Properties, set \"Assignment required?\" to Yes. 3. Go to Users and groups, click Add, and assign only the specific users or groups you want to have access. If the --name parameter is omitted, the command authenticates as the currently logged-in user via the Himmelblau SSO broker. If the --name parameter is provided, the command attempts to authenticate as the specified Entra ID user. In this case, the command must be run as root to impersonate another user. This command must be run from a device that has already been joined to Entra ID.","title":"DESCRIPTION"},{"location":"reference/aad-tool/#options_2","text":"-d , --debug -D , --name <ACCOUNT_ID> --client-id <CLIENT_ID> --display-name <DISPLAY_NAME> --redirect-uri <URI> --user-read-write --group-read-write -h , --help Print help (see a summary with '-h')","title":"OPTIONS"},{"location":"reference/aad-tool/#subcommand_2","text":"aad-tool application list-schema-extensions [ OPTIONS ] --client-id <CLIENT_ID> --schema-app-object-id <SCHEMA_APP_OBJECT_ID>","title":"SUBCOMMAND"},{"location":"reference/aad-tool/#description_4","text":"Lists the schema extension attributes registered on an Entra ID application. This command retrieves the directory extension attributes (e.g., uidNumber , gidNumber , etc.) that have been added to the application identified by --schema-app-object-id . The --schema-app-object-id parameter must be the Object ID of the application (not the Client ID), as shown in the Entra Admin Center. This value corresponds to the id field in Microsoft Graph and is required to query extension properties. You must also supply a separate --client-id that grants Application.Read.All or Application.ReadWrite.All permissions in the tenant to perform this query. If the --name parameter is omitted, the command authenticates as the currently logged-in user via the Himmelblau SSO broker. If the --name parameter is provided, the command attempts to authenticate as the specified Entra ID user. In this case, the command must be run as root to impersonate another user. This command must be run from a device that has already been joined to Entra ID.","title":"DESCRIPTION"},{"location":"reference/aad-tool/#options_3","text":"-d , --debug -D , --name <ACCOUNT_ID> --client-id <CLIENT_ID> --schema-app-object-id <SCHEMA_APP_OBJECT_ID> -h , --help Print help (see a summary with '-h')","title":"OPTIONS"},{"location":"reference/aad-tool/#subcommand_3","text":"aad-tool application list [ OPTIONS ] --client-id <CLIENT_ID>","title":"SUBCOMMAND"},{"location":"reference/aad-tool/#description_5","text":"Lists Entra ID application registrations in the current tenant. This command performs a delegated Microsoft Graph API request using an access token acquired via the specified client application ( --client-id ), which must have Application.Read.All permissions in the tenant. If the --name parameter is omitted, the command authenticates as the currently logged-in user via the Himmelblau SSO broker. If the --name parameter is provided, the command attempts to authenticate as the specified Entra ID user. In this case, the command must be run as root to impersonate another user. This command must be run from a device that has already been joined to Entra ID.","title":"DESCRIPTION"},{"location":"reference/aad-tool/#options_4","text":"-d , --debug -D , --name <ACCOUNT_ID> --client-id <CLIENT_ID> -h , --help Print help (see a summary with '-h')","title":"OPTIONS"},{"location":"reference/aad-tool/#subcommand_4","text":"aad-tool auth-test [ OPTIONS ] --name <ACCOUNT_ID>","title":"SUBCOMMAND"},{"location":"reference/aad-tool/#description_6","text":"Test authentication of a user via the himmelblaud resolver \"pam\" channel. This does not test that your pam configuration is correct - only that himmelblaud is correctly processing and validating authentications","title":"DESCRIPTION"},{"location":"reference/aad-tool/#options_5","text":"-d , --debug -D , --name <ACCOUNT_ID>","title":"OPTIONS"},{"location":"reference/aad-tool/#-h-help","text":"Print help","title":"-h, --help"},{"location":"reference/aad-tool/#subcommand_5","text":"aad-tool cache-clear [ OPTIONS ]","title":"SUBCOMMAND"},{"location":"reference/aad-tool/#description_7","text":"Clear or invalidate the himmelblaud resolver cache. By default, this marks all cached user and group entries as stale, forcing them to refresh immediately when next used. Specify --nss or --mapped to clear these individual caches as well. Omit both these to clear them all. Use --full to completely purge the user and group cache entries and unjoin the host from Entra ID. This is irreversible.","title":"DESCRIPTION"},{"location":"reference/aad-tool/#options_6","text":"-d , --debug --nss Only clear the nss cache --mapped Only clear the mapped name cache --full Force a full cache wipe and unjoin the host from Entra ID. This is probably not what you want -h , --help Print help (see a summary with '-h')","title":"OPTIONS"},{"location":"reference/aad-tool/#subcommand_6","text":"aad-tool cache-invalidate [ OPTIONS ]","title":"SUBCOMMAND"},{"location":"reference/aad-tool/#description_8","text":"(Deprecated) Previously used to mark cache entries as stale for immediate refresh. Now behaves identically to cache-clear and will be removed in a future release","title":"DESCRIPTION"},{"location":"reference/aad-tool/#options_7","text":"-d , --debug --nss --mapped --full","title":"OPTIONS"},{"location":"reference/aad-tool/#-h-help_1","text":"Print help","title":"-h, --help"},{"location":"reference/aad-tool/#subcommand_7","text":"aad-tool configure-pam [ OPTIONS ]","title":"SUBCOMMAND"},{"location":"reference/aad-tool/#description_9","text":"Configure PAM to use pam_himmelblau","title":"DESCRIPTION"},{"location":"reference/aad-tool/#options_8","text":"-d , --debug --really --auth-file <AUTH_FILE> --account-file <ACCOUNT_FILE> --session-file <SESSION_FILE> --password-file <PASSWORD_FILE>","title":"OPTIONS"},{"location":"reference/aad-tool/#-h-help_2","text":"Print help","title":"-h, --help"},{"location":"reference/aad-tool/#subcommand_8","text":"aad-tool cred cert [ OPTIONS ] --client-id <CLIENT_ID> --domain <DOMAIN> --valid-days <VALID_DAYS> --cert-out <CERT_OUT>","title":"SUBCOMMAND"},{"location":"reference/aad-tool/#description_10","text":"Generate an RS256 HSM-backed key pair with a self-signed certificate for confidential client authentication. To set this up: In the Entra ID portal, navigate to Azure Active Directory -> App registrations, then open (or create) your application. Under Manage > Certificates & secrets, go to the Certificates tab. Click Upload certificate and select the PEM file generated by this command. Azure will store this cert for authenticating via public key. The private key never leaves your TPM (or SoftHSM). When this cred needs renewed in the future, simple run this command again to replace the expired certificate. Example: aad-tool cred cert --client-id <CLIENT_ID> --valid-days 365 --cert-out /tmp/my-cert.crt","title":"DESCRIPTION"},{"location":"reference/aad-tool/#options_9","text":"-d , --debug --client-id <CLIENT_ID> The Azure AD application (client) ID this certificate is associated with --domain <DOMAIN> The tenant domain this certificate is associated with --valid-days <VALID_DAYS> Number of days the self-signed certificate will be valid --cert-out <CERT_OUT> Path to write the generated PEM certificate file. This is the file you will upload to Entra ID -h , --help Print help (see a summary with '-h')","title":"OPTIONS"},{"location":"reference/aad-tool/#subcommand_9","text":"aad-tool cred delete [ OPTIONS ] --domain <DOMAIN>","title":"SUBCOMMAND"},{"location":"reference/aad-tool/#description_11","text":"Delete confidential client credentials (secret, certificate, or both) This deletes stored confidential client credentials from Himmelblau's encrypted cache. If neither --secret nor --cert is specified, both will be deleted. Example: aad-tool cred delete --domain <DOMAIN> aad-tool cred delete --domain <DOMAIN> --secret aad-tool cred delete --domain <DOMAIN> --cert","title":"DESCRIPTION"},{"location":"reference/aad-tool/#options_10","text":"-d , --debug --domain <DOMAIN> The tenant domain whose creds will be deleted --secret Delete only the client secret (not the certificate) --cert Delete only the client certificate (not the secret) -h , --help Print help (see a summary with '-h')","title":"OPTIONS"},{"location":"reference/aad-tool/#subcommand_10","text":"aad-tool cred list [ OPTIONS ] --domain <DOMAIN>","title":"SUBCOMMAND"},{"location":"reference/aad-tool/#description_12","text":"List the presence of confidential client credentials This checks Himmelblau's encrypted cache to see whether a client secret and/or client certificate exists for the given domain. Example: aad-tool cred list --domain <DOMAIN>","title":"DESCRIPTION"},{"location":"reference/aad-tool/#options_11","text":"-d , --debug --domain <DOMAIN> -h , --help Print help (see a summary with '-h')","title":"OPTIONS"},{"location":"reference/aad-tool/#subcommand_11","text":"aad-tool cred secret [ OPTIONS ] --client-id <CLIENT_ID> --domain <DOMAIN> --secret <SECRET>","title":"SUBCOMMAND"},{"location":"reference/aad-tool/#description_13","text":"Store a client secret for confidential client authentication. To set this up: In the Entra ID portal, navigate to Azure Active Directory -> App registrations, then open (or create) your application. Under Manage > Certificates & secrets, go to the Client secrets tab. Click New client secret, choose an expiry, and click Add. Copy the Value (not Secret ID) immediately. You won't be able to see it again. Use that value with this command to store it in Himmelblau's encrypted cache. When this cred needs renewed in the future, simple run this command again to replace the expired secret. Example: aad-tool cred secret --client-id <CLIENT_ID> --secret <SECRET_VALUE>","title":"DESCRIPTION"},{"location":"reference/aad-tool/#options_12","text":"-d , --debug --client-id <CLIENT_ID> The Azure AD application (client) ID this secret is associated with --domain <DOMAIN> The tenant domain this secret is associated with --secret <SECRET> The client secret value copied from the Entra ID portal -h , --help Print help (see a summary with '-h')","title":"OPTIONS"},{"location":"reference/aad-tool/#subcommand_12","text":"aad-tool enumerate [ OPTIONS ]","title":"SUBCOMMAND"},{"location":"reference/aad-tool/#description_14","text":"Enumerate all users and groups in Entra ID that have rfc2307 attributes, and cache their values locally. This addresses the issue where UID/GID mappings are needed before authentication can succeed, but are normally only retrievable after login. The --client-id parameter is optional and must refer to a registered Entra ID application with User.Read.All and Group.Read.All permissions. The --name parameter specifies the Entra ID user on whose behalf the token is requested, enabling delegated access through the specified client application. This command can only be executed from an Entra Id enrolled host.","title":"DESCRIPTION"},{"location":"reference/aad-tool/#options_13","text":"-d , --debug -D , --name <ACCOUNT_ID> --client-id <CLIENT_ID> -h , --help Print help (see a summary with '-h')","title":"OPTIONS"},{"location":"reference/aad-tool/#subcommand_13","text":"aad-tool group set-posix-attrs [ OPTIONS ] --schema-client-id <SCHEMA_CLIENT_ID> --group-id <GROUP_ID> --gid <GID>","title":"SUBCOMMAND"},{"location":"reference/aad-tool/#description_15","text":"Sets POSIX-related attributes on a specified Entra ID group object. This command updates the gidNumber attribute on the Entra ID group identified by --group-id , which must be a valid Object ID. You must also provide the --schema-client-id , which identifies the application where the extension properties were registered. This value must be the Client ID of the application used for schema registration. The application associated with --schema-client-id must supply Group.ReadWrite.All permissions in the tenant. If the --name parameter is omitted, the command authenticates as the currently logged-in user via the Himmelblau SSO broker. If the --name parameter is provided, the command must be run as root to impersonate another user. This command must be run from a device that has already been joined to Entra ID.","title":"DESCRIPTION"},{"location":"reference/aad-tool/#options_14","text":"-d , --debug -D , --name <ACCOUNT_ID> --schema-client-id <SCHEMA_CLIENT_ID> --group-id <GROUP_ID> --gid <GID> -h , --help Print help (see a summary with '-h')","title":"OPTIONS"},{"location":"reference/aad-tool/#subcommand_14","text":"aad-tool idmap clear [ OPTIONS ]","title":"SUBCOMMAND"},{"location":"reference/aad-tool/#description_16","text":"Clear the contents of the idmap static cache","title":"DESCRIPTION"},{"location":"reference/aad-tool/#options_15","text":"-d , --debug","title":"OPTIONS"},{"location":"reference/aad-tool/#-h-help_3","text":"Print help","title":"-h, --help"},{"location":"reference/aad-tool/#subcommand_15","text":"aad-tool idmap group-add [ OPTIONS ] --object_id <OBJECT_ID> --gid <GID>","title":"SUBCOMMAND"},{"location":"reference/aad-tool/#description_17","text":"Add a static group mapping to the idmap cache. This maps an Entra ID group (by Object Id GUID) to a fixed GID. This can be used to maintain group identity and membership compatibility after moving to Entra ID","title":"DESCRIPTION"},{"location":"reference/aad-tool/#options_16","text":"-d , --debug -D , --object_id <OBJECT_ID> -g , --gid <GID>","title":"OPTIONS"},{"location":"reference/aad-tool/#-h-help_4","text":"Print help","title":"-h, --help"},{"location":"reference/aad-tool/#subcommand_16","text":"aad-tool idmap user-add [ OPTIONS ] --name <ACCOUNT_ID> --uid <UID> --gid <GID>","title":"SUBCOMMAND"},{"location":"reference/aad-tool/#description_18","text":"Add a static user mapping to the idmap cache. This maps an Entra ID user (by UPN or SAM-compatible name) to a fixed UID and primary group GID","title":"DESCRIPTION"},{"location":"reference/aad-tool/#options_17","text":"-d , --debug -D , --name <ACCOUNT_ID> -u , --uid <UID> -g , --gid <GID>","title":"OPTIONS"},{"location":"reference/aad-tool/#-h-help_5","text":"Print help","title":"-h, --help"},{"location":"reference/aad-tool/#subcommand_17","text":"aad-tool offline-breakglass [ OPTIONS ]","title":"SUBCOMMAND"},{"location":"reference/aad-tool/#description_19","text":"Activate or deactivate Himmelblau's offline breakglass mode. This command enables temporary offline password authentication when Azure Entra ID is unreachable. When invoked, Himmelblau enters a controlled \"breakglass\" state, allowing cached Entra ID user passwords to be used for login until the TTL expires. Breakglass mode can only be activated if it was previously enabled in /etc/himmelblau/himmelblau.conf under the [offline_breakglass] section. If the feature was disabled, calling this command will have no effect, and no password verifiers will have been cached. Once activated, Himmelblau will: * Allow cached Entra ID users to log in using their known password. * Automatically exit breakglass mode after the TTL expires or once Entra ID connectivity has been restored. Use --ttl to override the configured duration for this session. The TTL value accepts a time unit suffix ( m , h , or d ) and defaults to the value defined in himmelblau.conf if omitted. To manually exit breakglass mode before TTL expiry, run: aad-tool offline-breakglass --ttl 0","title":"DESCRIPTION"},{"location":"reference/aad-tool/#options_18","text":"-d , --debug --ttl <TTL> -h , --help Print help (see a summary with '-h')","title":"OPTIONS"},{"location":"reference/aad-tool/#examples","text":"","title":"EXAMPLES"},{"location":"reference/aad-tool/#activate-breakglass-mode-for-2-hours-aad-tool-offline-breakglass-ttl-2h","text":"","title":"Activate breakglass mode for 2 hours aad-tool offline-breakglass --ttl 2h"},{"location":"reference/aad-tool/#force-disable-breakglass-mode-immediately-aad-tool-offline-breakglass-ttl-0","text":"","title":"Force disable breakglass mode immediately aad-tool offline-breakglass --ttl 0"},{"location":"reference/aad-tool/#use-the-configured-default-ttl-from-himmelblauconf-aad-tool-offline-breakglass","text":"Notes: - If [offline_breakglass] enabled = false in himmelblau.conf, this command will do nothing. - Himmelblau will not cache Entra ID password hashes unless offline breakglass has been explicitly enabled in advance. - This feature should only be used for emergency access during verified outages.","title":"Use the configured default TTL (from himmelblau.conf) aad-tool offline-breakglass"},{"location":"reference/aad-tool/#subcommand_18","text":"aad-tool status [ OPTIONS ]","title":"SUBCOMMAND"},{"location":"reference/aad-tool/#description_20","text":"Check that the himmelblaud daemon is online and able to connect correctly to the himmelblaud server","title":"DESCRIPTION"},{"location":"reference/aad-tool/#options_19","text":"-d , --debug","title":"OPTIONS"},{"location":"reference/aad-tool/#-h-help_6","text":"Print help","title":"-h, --help"},{"location":"reference/aad-tool/#subcommand_19","text":"aad-tool tpm [ OPTIONS ]","title":"SUBCOMMAND"},{"location":"reference/aad-tool/#description_21","text":"Check whether Himmelblau is utilizing the TPM","title":"DESCRIPTION"},{"location":"reference/aad-tool/#options_20","text":"-d , --debug","title":"OPTIONS"},{"location":"reference/aad-tool/#-h-help_7","text":"Print help","title":"-h, --help"},{"location":"reference/aad-tool/#subcommand_20","text":"aad-tool user set-posix-attrs [ OPTIONS ] --schema-client-id <SCHEMA_CLIENT_ID> --user-id <USER_ID>","title":"SUBCOMMAND"},{"location":"reference/aad-tool/#description_22","text":"Sets POSIX-related attributes on a specified Entra ID user object. This command updates POSIX attributes ( uidNumber , gidNumber , unixHomeDirectory , loginShell , and gecos ) on the Entra ID user identified by --user-id , which must be a valid Object ID or UPN. You must also provide the --schema-client-id , which identifies the application where the extension properties were registered. This value must be the Client ID of the application used for schema registration. The application associated with --schema-client-id must supply User.ReadWrite.All permissions in the tenant. If the --name parameter is omitted, the command authenticates as the currently logged-in user via the Himmelblau SSO broker. If the --name parameter is provided, the command must be run as root to impersonate another user. This command must be run from a device that has already been joined to Entra ID.","title":"DESCRIPTION"},{"location":"reference/aad-tool/#options_21","text":"-d , --debug -D , --name <ACCOUNT_ID> --schema-client-id <SCHEMA_CLIENT_ID> --user-id <USER_ID> --uid <UID> --gid <GID> --home <HOME> --shell <SHELL> --gecos <GECOS> -h , --help Print help (see a summary with '-h')","title":"OPTIONS"},{"location":"reference/aad-tool/#see-also","text":"himmelblau.conf (5), himmelblaud (8), himmelblaud-tasks (8)","title":"SEE ALSO"},{"location":"reference/aad-tool/#author","text":"David Mulder <dmulder@himmelblau-idm.org>, <dmulder@samba.org>","title":"AUTHOR"},{"location":"reference/himmelblau-conf/","text":"NAME himmelblau.conf - Configuration file for Himmelblau, enabling Azure Entra ID authentication on Linux. SYNOPSIS /etc/himmelblau/himmelblau.conf HOW CONFIGURATION CHANGES ARE APPLIED Changes to the configuration file /etc/himmelblau/himmelblau.conf only take effect after restarting the Himmelblau daemons. This includes the himmelblaud daemon, which handles authentication, and the himmelblaud-tasks daemon, which processes related tasks. Restarting the Daemons To apply changes, restart the Himmelblau services using the following systemd commands: EXAMPLES sudo systemctl restart himmelblaud sudo systemctl restart himmelblaud-tasks DESCRIPTION The himmelblau.conf file is the primary configuration file for the Himmelblau authentication module. It defines global and optional settings required for Azure Entra ID-based authentication and device management. FILE FORMAT The file consists of sections headed by a name enclosed in square brackets. Each section contains parameters and their values in the format: parameter = value Lines beginning with a '#' are comments and are ignored by the parser. PARAMETERS [global] This section contains settings that apply globally to all operations of Himmelblau. domain The primary Azure Entra ID domain name used for authentication. This value SHOULD match the domain name that users enter when signing in (for example, the domain portion of their UPN). In most cases, this will be the primary domain of your Azure Entra ID tenant. If your organization uses multiple verified domains or aliases, choose the one that your users actually use to sign in. This parameter is REQUIRED for successful authentication. If it is not specified, no users will be permitted to authenticate. EXAMPLES domain = example.com debug A boolean option that enables debug-level logging. When set to true, debug messages are output to the system journal. EXAMPLES debug = true pam_allow_groups A comma-separated list of Entra Id Users and Groups permitted to access the system. Users should be specified by UPN. Groups MUST be specified using their Object ID GUID. Group names may not be used because these names are not guaranteed to be unique in Entra Id. EXAMPLES pam_allow_groups = f3c9a7e4-7d5a-47e8-832f-3d2d92abcd12,5ba4ef1d-e454-4f43-ba7c-6fe6f1601915,admin@himmelblau-idm.org id_attr_map Specify whether to map uid/gid based on the object name, the object uuid, or based on the rfc2307 schema extension attributes synchronized from an on-prem Active Directory instance. Mapping by name or by rfc2307 is recommeneded. By name mapping is the default. EXAMPLES id_attr_map = <name|uuid|rfc2307> rfc2307_group_fallback_map Specify whether to map group IDs (GIDs) based on the object name or object UUID when no gidNumber attribute is found in an on-prem Active Directory instance synchronized to Azure Entra ID. This option is only applicable if id_attr_map is set to rfc2307. If id_attr_map = rfc2307 and a group does not have a gidNumber defined in the directory, this setting determines the fallback method for mapping the group ID. If this option is not set, groups without a gidNumber will not be available to NSS. EXAMPLES rfc2307_group_fallback_map = <name|uuid> enable_hello Enables or disables user enrollment in Windows Hello authentication. If disabled, users will need to provide MFA for each login. EXAMPLES enable_hello = false hello_pin_min_length The minimum length of the PIN for Windows Hello authentication. The value must be between 6 and 32 characters. EXAMPLES hello_pin_min_length = 8 hello_pin_retry_count The number of invalid Hello PIN attempts allowed before the user is required to perform MFA. After successful MFA, the user will be prompted to set a new PIN. The value must be a non-negative integer. EXAMPLES hello_pin_retry_count = 3 hello_pin_prompt Customizes the prompt text shown when requesting the user\u2019s Linux Hello PIN. If not set, the default prompt is: Use the Linux Hello PIN for this device. EXAMPLES hello_pin_prompt = Enter your device unlock PIN entra_id_password_prompt Customizes the prompt text shown when requesting the user\u2019s Entra ID password. If not set, the default prompt is: Use the password for your Office 365 or Microsoft online login. EXAMPLES entra_id_password_prompt = Enter your Microsoft 365 password enable_sfa_fallback Determines whether password-only (single-factor) authentication is permitted when MFA is unavailable. Disabled by default. EXAMPLES enable_sfa_fallback = true cn_name_mapping Allows users to enter the short form of their username (e.g., 'dave') instead of the full UPN. EXAMPLES cn_name_mapping = true local_groups A comma-separated list of local groups that every Entra ID user should be a member of. For example, you may wish for all Entra ID users to be a member of the sudo group. WARNING: This setting will not REMOVE group member entries when groups are removed from this list. You must remove them manually. EXAMPLES local_groups = sudo,admin sudo_groups A comma-separated list of Azure Entra ID group object IDs whose members should be granted sudo access on this system. If local_sudo_group is not defined, the local group sudo will be used. EXAMPLES sudo_groups = f3c9a7e4-7d5a-47e8-832f-3d2d92abcd12,5ba4ef1d-e454-4f43-ba7c-6fe6f1601915 local_sudo_group The local group that should be given to users in any of the groups specified in sudo_groups. Only has an affect if sudo_groups is set. Removes group from user if they are no longer a member of the specified entra group. logon_script A script that will execute every time a user logs on. Two environment variables are set: USERNAME, and ACCESS_TOKEN. The ACCESS_TOKEN environment variable is an access token for the MS Graph. The token scope config option sets the comma-separated scopes that should be requested for the ACCESS_TOKEN. ACCESS_TOKEN will be empty during offline logon. The return code of the script determines how authentication proceeds. 0 is success, 1 is a soft failure and authentication will proceed, while 2 is a hard failure causing authentication to fail. EXAMPLES logon_script = /etc/himmelblau/logon.sh logon_token_scopes A comma-separated list of the scopes to be requested for the ACCESS_TOKEN during logon. These scopes MUST correspond to the API permissions assigned to the Entra Id Application specified by the app_id option. EXAMPLES logon_token_scopes = user.read,mail.read app_id Specifies the Azure Entra ID application (client) ID used by Himmelblau for directory operations such as reading extended attributes (for example, the gidNumber attribute used in RFC 2307 idmapping). If logon_token_app_id is not set, this application ID is also used when requesting access tokens for the user logon script. Note: In the Azure Portal for the application corresponding to app_id , ensure that the redirect URI himmelblau://Himmelblau.EntraId.BrokerPlugin is enabled under \u201cMobile and desktop applications\u201d in the Authentication section. This allows Himmelblau to correctly handle interactive token redirection. EXAMPLES app_id = d023f7aa-d214-4b59-911d-6074de623765 logon_token_app_id Specifies an alternate Azure Entra ID application (client) ID to be used exclusively for acquiring ACCESS_TOKEN values on behalf of the user during logon script execution. If not set, the value of app_id will be used instead. This option allows using a separate application registration that carries the specific API permissions required by logon scripts. Note: In the Azure Portal for the application corresponding to logon_token_app_id , ensure that the redirect URI https://login.microsoftonline.com/common/oauth2/nativeclient is enabled under \u201cMobile and desktop applications\u201d in the Authentication section. This is required for Himmelblau to obtain tokens via the public client flow. EXAMPLES logon_token_app_id = 544e695f-5d78-442e-b14e-e114e95e640c enable_experimental_mfa A boolean option that enables the experimental multi-factor authentication (MFA) flow, which permits Hello authentication. This experimental flow may encounter failures in certain edge cases. If disabled, the system enforces the Device Authorization Grant (DAG) flow for MFA, which is more robust but does not support Hello authentication. By default, this option is enabled. EXAMPLES enable_experimental_mfa = true enable_experimental_passwordless_fido A boolean option that enables the experimental passwordless FIDO flow for Azure Entra ID authentication. When enabled, Himmelblau will attempt to authenticate with Entra ID using a FIDO2 security key without requiring a password. By default, this option is disabled. EXAMPLES enable_experimental_passwordless_fido = true name_mapping_script Specifies the path to an executable script used for mapping custom names to UPN names. The script MUST accept a single argument, which will always be a mapped name. The script MUST print the corresponding UPN (User Principal Name) to stdout. If the script does not recognize the input name, it MUST simply return the input name unchanged. This option is particularly useful in environments where direct UPN-to-CN mappings are impractical or where custom transformations are required. The script must handle the input gracefully and return the correct UPN or the input name if unrecognized. Errors must be handled to avoid authentication failures. EXAMPLES name_mapping_script = /path/to/mapping_script.sh Example Script: #!/bin/bash # Convert CN to UPN, or return the input name if unrecognized if [[ \"$1\" =~ ^[a-zA-Z0-9._-]+$ ]]; then echo \"$1@example.com\" else echo \"$1\" fi apply_policy A boolean option that enables the application and enforcement of Intune policies to the authenticated user. By default, this option is disabled. EXAMPLES apply_policy = false enable_experimental_intune_custom_compliance A boolean option that enables support for Linux Intune Custom Compliance policies. This feature is experimental and not yet fully functional. While policy settings should be applied locally, the compliance status is not reliably reported to Intune, and failed policies do not currently block authentication. By default, this option is disabled. This option requires apply_policy = true . EXAMPLES enable_experimental_intune_custom_compliance = true authority_host Specifies the hostname for Microsoft authentication. The default value is login.microsoftonline.com. EXAMPLES authority_host = login.microsoftonline.com db_path The location of the cache database. This file is used to store cached authentication data and device state. EXAMPLES db_path = /var/cache/himmelblau/himmelblau.cache.db hsm_type Specifies how Himmelblau should handle secure key storage. This option determines whether to use a TPM (Trusted Platform Module) bound software-based HSM, a TPM, or a hybrid approach. The available options are: tpm_bound_soft_if_possible \u2013 Use a software-based HSM that encrypts key material locally on the system, but binds the parent AuthCode to the TPM, if available. tpm \u2013 Use a hardware TPM exclusively for storing and binding cryptographic keys. tpm_if_possible \u2013 Attempt to use a hardware TPM if available; if not, fall back to the software HSM. If the TPM has previously been used for key storage, the system will not fall back to the software HSM. The default is tpm_bound_soft_if_possible his setting is important for protecting sensitive cryptographic keys in a secure environment, reducing the risk of compromise if the system is breached.Note that the old soft option has been deprecated. Environments currently enrolled using soft will be automatically migrated to tpm_bound_soft_if_possible. To validate whether Himmelblau is utilizing the hardware TPM, run the command sudo aad-tool tpm for a status report. EXAMPLES hsm_type = tpm_bound_soft_if_possible tpm_tcti_name Specifies the TCTI (Trusted Computing Technology Interface) to use when communicating with a Trusted Platform Module (TPM) for secure key operations. This setting is only relevant when hsm_type is set to tpm or tpm_if_possible. Common values include: device:/dev/tpmrm0 \u2013 This uses the kernel TPM resource manager device, which is the recommended default for most Linux systems. Other TCTI strings may be required depending on your system\u2019s TPM driver or configuration. This option allows advanced control over how Himmelblau connects to the TPM for performing cryptographic operations. EXAMPLES tpm_tcti_name = device:/dev/tpmrm0 hsm_pin_path The location where the HSM (Hardware Security Module) PIN will be stored. This PIN is used to protect sensitive cryptographic operations. EXAMPLES hsm_pin_path = /var/lib/himmelblaud/hsm-pin socket_path The path to the socket file for communication between the pam and nss modules and the Himmelblau daemon. EXAMPLES socket_path = /var/run/himmelblaud/socket task_socket_path The path to the socket file for communication with the task daemon. EXAMPLES task_socket_path = /var/run/himmelblaud/task_sock broker_socket_path The path to the socket file for communication with the broker DBus service. EXAMPLES broker_socket_path = /var/run/himmelblaud/broker_sock home_prefix The prefix to use for user home directories. EXAMPLES home_prefix = /home/ home_attr The attribute used to create a home directory for a user. Available options include: UUID (default) SPN CN EXAMPLES home_attr = UUID home_alias The symlinked alias for the user's home directory. Available options include: UUID SPN (default) CN EXAMPLES home_alias = SPN shell The default shell for users. This will be assigned when the user logs in. EXAMPLES shell = /bin/bash idmap_range Specifies the range of IDs to be used for the user and group mappings. When this option is modified, you SHOULD run: sudo aad-tool cache-clear --full To ensure that old cached ID mappings are cleared, preventing potential UID overlaps caused by stale cache data. Afterwards, restart himmelblaud. EXAMPLES idmap_range = 5000000-5999999 connection_timeout The timeout for connections to the authentication server. Default is 2 seconds. EXAMPLES connection_timeout = 5 cache_timeout The timeout for caching authentication data. Default is 300 seconds (5 minutes). EXAMPLES cache_timeout = 10 use_etc_skel If set to true, Himmelblau will use the contents of /etc/skel when creating new user directories. EXAMPLES use_etc_skel = false selinux Whether SELinux security labels should be applied to users' home directories. Set to true to enable. EXAMPLES selinux = true join_type Specifies whether the system should join or register with Microsoft Entra ID. EXAMPLES join_type = register user_map_file Specifies the path to a user-mapping file used to map local user accounts to Azure Entra ID user accounts, allowing them to authenticate using Entra ID credentials. Each line of the file must contain a single mapping entry in the format: local_username:name@domain Blank lines and lines beginning with \u2018#\u2019 are ignored. If this option is not set, the default path /etc/himmelblau/user-map is used. EXAMPLES user_map_file = /path/to/user_map EXAMPLES Example user-map file entries: local_username:samaccountname@domain alice:alice@contoso.com bob:bob.smith@example.org svcuser:service.account@tenant.local OFFLINE BREAKGLASS CONFIGURATION The [offline_breakglass] section configures Himmelblau\u2019s emergency offline authentication mechanism, used when Azure Entra ID is unavailable. Offline breakglass allows Entra ID users who normally require multi-factor authentication (MFA) to authenticate with their cached password when the host is offline. This feature provides a controlled fallback for MFA-only users who would otherwise be unable to sign in during an outage. Single-factor authentication (SFA-only) users and Hello-PIN users already have offline sign-in capability, and are unaffected by this setting. This option exists solely to extend limited offline access to MFA-enabled users when network connectivity to Entra ID cannot be established. [offline_breakglass] This section controls whether and how Himmelblau may perform offline password authentication for MFA-enabled users in emergency conditions. enabled Boolean value specifying whether offline breakglass mode is permitted. When set to true, Himmelblau will cache secure, salted password verifiers for MFA-enabled Entra ID users who successfully authenticate online. These verifiers can then be used to authenticate the same users when Entra ID is unreachable, allowing MFA users to log in using their cached password. If this option is set to false (the default), Himmelblau will continue to cache password verifiers only for SFA-only users, and MFA-enabled users will not be able to authenticate when offline. The aad-tool (1) command aad-tool offline-breakglass will also have no effect. Administrators must enable this option well in advance of an outage, as password verifiers for MFA users are only stored following a successful online authentication. It is too late to enable this feature once Entra ID is already unreachable. Enabling offline breakglass mode carries significant risk. If a device is stolen or compromised, and network access to Entra ID is blocked, attackers could effectively disable MFA protection by forcing the system into a simple password-only (SFA) authentication state. Administrators should enable this mode only after careful consideration of their organization\u2019s security posture and offline access requirements. This feature does not apply to passwordless accounts. If an MFA user signs in using a passwordless method, no password hash exists to cache, and offline breakglass cannot function for that user. EXAMPLES [offline_breakglass] enabled = true ttl = 2h Allow MFA users to authenticate offline for up to 2 hours ttl Specifies how long breakglass mode should remain active once triggered. The value may include a suffix to indicate the unit of time: m for minutes, h for hours, or d for days. If no suffix is provided, the value is interpreted as seconds. After the specified period, offline breakglass mode automatically expires and normal authentication resumes. EXAMPLES [offline_breakglass] enabled = true ttl = 1d Permit offline MFA logins for up to 24 hours after activation SEE ALSO himmelblaud(8), himmelblaud-tasks(8)","title":"Himmelblau conf"},{"location":"reference/himmelblau-conf/#name","text":"himmelblau.conf - Configuration file for Himmelblau, enabling Azure Entra ID authentication on Linux.","title":"NAME"},{"location":"reference/himmelblau-conf/#synopsis","text":"/etc/himmelblau/himmelblau.conf","title":"SYNOPSIS"},{"location":"reference/himmelblau-conf/#how-configuration-changes-are-applied","text":"Changes to the configuration file /etc/himmelblau/himmelblau.conf only take effect after restarting the Himmelblau daemons. This includes the himmelblaud daemon, which handles authentication, and the himmelblaud-tasks daemon, which processes related tasks.","title":"HOW CONFIGURATION CHANGES ARE APPLIED"},{"location":"reference/himmelblau-conf/#restarting-the-daemons","text":"To apply changes, restart the Himmelblau services using the following systemd commands:","title":"Restarting the Daemons"},{"location":"reference/himmelblau-conf/#examples","text":"sudo systemctl restart himmelblaud sudo systemctl restart himmelblaud-tasks","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#description","text":"The himmelblau.conf file is the primary configuration file for the Himmelblau authentication module. It defines global and optional settings required for Azure Entra ID-based authentication and device management.","title":"DESCRIPTION"},{"location":"reference/himmelblau-conf/#file-format","text":"The file consists of sections headed by a name enclosed in square brackets. Each section contains parameters and their values in the format: parameter = value Lines beginning with a '#' are comments and are ignored by the parser.","title":"FILE FORMAT"},{"location":"reference/himmelblau-conf/#parameters","text":"","title":"PARAMETERS"},{"location":"reference/himmelblau-conf/#global","text":"This section contains settings that apply globally to all operations of Himmelblau.","title":"[global]"},{"location":"reference/himmelblau-conf/#domain","text":"The primary Azure Entra ID domain name used for authentication. This value SHOULD match the domain name that users enter when signing in (for example, the domain portion of their UPN). In most cases, this will be the primary domain of your Azure Entra ID tenant. If your organization uses multiple verified domains or aliases, choose the one that your users actually use to sign in. This parameter is REQUIRED for successful authentication. If it is not specified, no users will be permitted to authenticate.","title":"domain"},{"location":"reference/himmelblau-conf/#examples_1","text":"domain = example.com","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#debug","text":"A boolean option that enables debug-level logging. When set to true, debug messages are output to the system journal.","title":"debug"},{"location":"reference/himmelblau-conf/#examples_2","text":"debug = true","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#pam_allow_groups","text":"A comma-separated list of Entra Id Users and Groups permitted to access the system. Users should be specified by UPN. Groups MUST be specified using their Object ID GUID. Group names may not be used because these names are not guaranteed to be unique in Entra Id.","title":"pam_allow_groups"},{"location":"reference/himmelblau-conf/#examples_3","text":"pam_allow_groups = f3c9a7e4-7d5a-47e8-832f-3d2d92abcd12,5ba4ef1d-e454-4f43-ba7c-6fe6f1601915,admin@himmelblau-idm.org","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#id_attr_map","text":"Specify whether to map uid/gid based on the object name, the object uuid, or based on the rfc2307 schema extension attributes synchronized from an on-prem Active Directory instance. Mapping by name or by rfc2307 is recommeneded. By name mapping is the default.","title":"id_attr_map"},{"location":"reference/himmelblau-conf/#examples_4","text":"id_attr_map = <name|uuid|rfc2307>","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#rfc2307_group_fallback_map","text":"Specify whether to map group IDs (GIDs) based on the object name or object UUID when no gidNumber attribute is found in an on-prem Active Directory instance synchronized to Azure Entra ID. This option is only applicable if id_attr_map is set to rfc2307. If id_attr_map = rfc2307 and a group does not have a gidNumber defined in the directory, this setting determines the fallback method for mapping the group ID. If this option is not set, groups without a gidNumber will not be available to NSS.","title":"rfc2307_group_fallback_map"},{"location":"reference/himmelblau-conf/#examples_5","text":"rfc2307_group_fallback_map = <name|uuid>","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#enable_hello","text":"Enables or disables user enrollment in Windows Hello authentication. If disabled, users will need to provide MFA for each login.","title":"enable_hello"},{"location":"reference/himmelblau-conf/#examples_6","text":"enable_hello = false","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#hello_pin_min_length","text":"The minimum length of the PIN for Windows Hello authentication. The value must be between 6 and 32 characters.","title":"hello_pin_min_length"},{"location":"reference/himmelblau-conf/#examples_7","text":"hello_pin_min_length = 8","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#hello_pin_retry_count","text":"The number of invalid Hello PIN attempts allowed before the user is required to perform MFA. After successful MFA, the user will be prompted to set a new PIN. The value must be a non-negative integer.","title":"hello_pin_retry_count"},{"location":"reference/himmelblau-conf/#examples_8","text":"hello_pin_retry_count = 3","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#hello_pin_prompt","text":"Customizes the prompt text shown when requesting the user\u2019s Linux Hello PIN. If not set, the default prompt is: Use the Linux Hello PIN for this device.","title":"hello_pin_prompt"},{"location":"reference/himmelblau-conf/#examples_9","text":"hello_pin_prompt = Enter your device unlock PIN","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#entra_id_password_prompt","text":"Customizes the prompt text shown when requesting the user\u2019s Entra ID password. If not set, the default prompt is: Use the password for your Office 365 or Microsoft online login.","title":"entra_id_password_prompt"},{"location":"reference/himmelblau-conf/#examples_10","text":"entra_id_password_prompt = Enter your Microsoft 365 password","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#enable_sfa_fallback","text":"Determines whether password-only (single-factor) authentication is permitted when MFA is unavailable. Disabled by default.","title":"enable_sfa_fallback"},{"location":"reference/himmelblau-conf/#examples_11","text":"enable_sfa_fallback = true","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#cn_name_mapping","text":"Allows users to enter the short form of their username (e.g., 'dave') instead of the full UPN.","title":"cn_name_mapping"},{"location":"reference/himmelblau-conf/#examples_12","text":"cn_name_mapping = true","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#local_groups","text":"A comma-separated list of local groups that every Entra ID user should be a member of. For example, you may wish for all Entra ID users to be a member of the sudo group. WARNING: This setting will not REMOVE group member entries when groups are removed from this list. You must remove them manually.","title":"local_groups"},{"location":"reference/himmelblau-conf/#examples_13","text":"local_groups = sudo,admin","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#sudo_groups","text":"A comma-separated list of Azure Entra ID group object IDs whose members should be granted sudo access on this system. If local_sudo_group is not defined, the local group sudo will be used.","title":"sudo_groups"},{"location":"reference/himmelblau-conf/#examples_14","text":"sudo_groups = f3c9a7e4-7d5a-47e8-832f-3d2d92abcd12,5ba4ef1d-e454-4f43-ba7c-6fe6f1601915","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#local_sudo_group","text":"The local group that should be given to users in any of the groups specified in sudo_groups. Only has an affect if sudo_groups is set. Removes group from user if they are no longer a member of the specified entra group.","title":"local_sudo_group"},{"location":"reference/himmelblau-conf/#logon_script","text":"A script that will execute every time a user logs on. Two environment variables are set: USERNAME, and ACCESS_TOKEN. The ACCESS_TOKEN environment variable is an access token for the MS Graph. The token scope config option sets the comma-separated scopes that should be requested for the ACCESS_TOKEN. ACCESS_TOKEN will be empty during offline logon. The return code of the script determines how authentication proceeds. 0 is success, 1 is a soft failure and authentication will proceed, while 2 is a hard failure causing authentication to fail.","title":"logon_script"},{"location":"reference/himmelblau-conf/#examples_15","text":"logon_script = /etc/himmelblau/logon.sh","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#logon_token_scopes","text":"A comma-separated list of the scopes to be requested for the ACCESS_TOKEN during logon. These scopes MUST correspond to the API permissions assigned to the Entra Id Application specified by the app_id option.","title":"logon_token_scopes"},{"location":"reference/himmelblau-conf/#examples_16","text":"logon_token_scopes = user.read,mail.read","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#app_id","text":"Specifies the Azure Entra ID application (client) ID used by Himmelblau for directory operations such as reading extended attributes (for example, the gidNumber attribute used in RFC 2307 idmapping). If logon_token_app_id is not set, this application ID is also used when requesting access tokens for the user logon script. Note: In the Azure Portal for the application corresponding to app_id , ensure that the redirect URI himmelblau://Himmelblau.EntraId.BrokerPlugin is enabled under \u201cMobile and desktop applications\u201d in the Authentication section. This allows Himmelblau to correctly handle interactive token redirection.","title":"app_id"},{"location":"reference/himmelblau-conf/#examples_17","text":"app_id = d023f7aa-d214-4b59-911d-6074de623765","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#logon_token_app_id","text":"Specifies an alternate Azure Entra ID application (client) ID to be used exclusively for acquiring ACCESS_TOKEN values on behalf of the user during logon script execution. If not set, the value of app_id will be used instead. This option allows using a separate application registration that carries the specific API permissions required by logon scripts. Note: In the Azure Portal for the application corresponding to logon_token_app_id , ensure that the redirect URI https://login.microsoftonline.com/common/oauth2/nativeclient is enabled under \u201cMobile and desktop applications\u201d in the Authentication section. This is required for Himmelblau to obtain tokens via the public client flow.","title":"logon_token_app_id"},{"location":"reference/himmelblau-conf/#examples_18","text":"logon_token_app_id = 544e695f-5d78-442e-b14e-e114e95e640c","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#enable_experimental_mfa","text":"A boolean option that enables the experimental multi-factor authentication (MFA) flow, which permits Hello authentication. This experimental flow may encounter failures in certain edge cases. If disabled, the system enforces the Device Authorization Grant (DAG) flow for MFA, which is more robust but does not support Hello authentication. By default, this option is enabled.","title":"enable_experimental_mfa"},{"location":"reference/himmelblau-conf/#examples_19","text":"enable_experimental_mfa = true","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#enable_experimental_passwordless_fido","text":"A boolean option that enables the experimental passwordless FIDO flow for Azure Entra ID authentication. When enabled, Himmelblau will attempt to authenticate with Entra ID using a FIDO2 security key without requiring a password. By default, this option is disabled.","title":"enable_experimental_passwordless_fido"},{"location":"reference/himmelblau-conf/#examples_20","text":"enable_experimental_passwordless_fido = true","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#name_mapping_script","text":"Specifies the path to an executable script used for mapping custom names to UPN names. The script MUST accept a single argument, which will always be a mapped name. The script MUST print the corresponding UPN (User Principal Name) to stdout. If the script does not recognize the input name, it MUST simply return the input name unchanged. This option is particularly useful in environments where direct UPN-to-CN mappings are impractical or where custom transformations are required. The script must handle the input gracefully and return the correct UPN or the input name if unrecognized. Errors must be handled to avoid authentication failures.","title":"name_mapping_script"},{"location":"reference/himmelblau-conf/#examples_21","text":"name_mapping_script = /path/to/mapping_script.sh Example Script: #!/bin/bash # Convert CN to UPN, or return the input name if unrecognized if [[ \"$1\" =~ ^[a-zA-Z0-9._-]+$ ]]; then echo \"$1@example.com\" else echo \"$1\" fi apply_policy A boolean option that enables the application and enforcement of Intune policies to the authenticated user. By default, this option is disabled.","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#examples_22","text":"apply_policy = false","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#enable_experimental_intune_custom_compliance","text":"A boolean option that enables support for Linux Intune Custom Compliance policies. This feature is experimental and not yet fully functional. While policy settings should be applied locally, the compliance status is not reliably reported to Intune, and failed policies do not currently block authentication. By default, this option is disabled. This option requires apply_policy = true .","title":"enable_experimental_intune_custom_compliance"},{"location":"reference/himmelblau-conf/#examples_23","text":"enable_experimental_intune_custom_compliance = true","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#authority_host","text":"Specifies the hostname for Microsoft authentication. The default value is login.microsoftonline.com.","title":"authority_host"},{"location":"reference/himmelblau-conf/#examples_24","text":"authority_host = login.microsoftonline.com","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#db_path","text":"The location of the cache database. This file is used to store cached authentication data and device state.","title":"db_path"},{"location":"reference/himmelblau-conf/#examples_25","text":"db_path = /var/cache/himmelblau/himmelblau.cache.db","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#hsm_type","text":"Specifies how Himmelblau should handle secure key storage. This option determines whether to use a TPM (Trusted Platform Module) bound software-based HSM, a TPM, or a hybrid approach. The available options are: tpm_bound_soft_if_possible \u2013 Use a software-based HSM that encrypts key material locally on the system, but binds the parent AuthCode to the TPM, if available. tpm \u2013 Use a hardware TPM exclusively for storing and binding cryptographic keys. tpm_if_possible \u2013 Attempt to use a hardware TPM if available; if not, fall back to the software HSM. If the TPM has previously been used for key storage, the system will not fall back to the software HSM. The default is tpm_bound_soft_if_possible his setting is important for protecting sensitive cryptographic keys in a secure environment, reducing the risk of compromise if the system is breached.Note that the old soft option has been deprecated. Environments currently enrolled using soft will be automatically migrated to tpm_bound_soft_if_possible. To validate whether Himmelblau is utilizing the hardware TPM, run the command sudo aad-tool tpm for a status report.","title":"hsm_type"},{"location":"reference/himmelblau-conf/#examples_26","text":"hsm_type = tpm_bound_soft_if_possible","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#tpm_tcti_name","text":"Specifies the TCTI (Trusted Computing Technology Interface) to use when communicating with a Trusted Platform Module (TPM) for secure key operations. This setting is only relevant when hsm_type is set to tpm or tpm_if_possible. Common values include: device:/dev/tpmrm0 \u2013 This uses the kernel TPM resource manager device, which is the recommended default for most Linux systems. Other TCTI strings may be required depending on your system\u2019s TPM driver or configuration. This option allows advanced control over how Himmelblau connects to the TPM for performing cryptographic operations.","title":"tpm_tcti_name"},{"location":"reference/himmelblau-conf/#examples_27","text":"tpm_tcti_name = device:/dev/tpmrm0","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#hsm_pin_path","text":"The location where the HSM (Hardware Security Module) PIN will be stored. This PIN is used to protect sensitive cryptographic operations.","title":"hsm_pin_path"},{"location":"reference/himmelblau-conf/#examples_28","text":"hsm_pin_path = /var/lib/himmelblaud/hsm-pin","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#socket_path","text":"The path to the socket file for communication between the pam and nss modules and the Himmelblau daemon.","title":"socket_path"},{"location":"reference/himmelblau-conf/#examples_29","text":"socket_path = /var/run/himmelblaud/socket","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#task_socket_path","text":"The path to the socket file for communication with the task daemon.","title":"task_socket_path"},{"location":"reference/himmelblau-conf/#examples_30","text":"task_socket_path = /var/run/himmelblaud/task_sock","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#broker_socket_path","text":"The path to the socket file for communication with the broker DBus service.","title":"broker_socket_path"},{"location":"reference/himmelblau-conf/#examples_31","text":"broker_socket_path = /var/run/himmelblaud/broker_sock","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#home_prefix","text":"The prefix to use for user home directories.","title":"home_prefix"},{"location":"reference/himmelblau-conf/#examples_32","text":"home_prefix = /home/","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#home_attr","text":"The attribute used to create a home directory for a user. Available options include: UUID (default) SPN CN","title":"home_attr"},{"location":"reference/himmelblau-conf/#examples_33","text":"home_attr = UUID","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#home_alias","text":"The symlinked alias for the user's home directory. Available options include: UUID SPN (default) CN","title":"home_alias"},{"location":"reference/himmelblau-conf/#examples_34","text":"home_alias = SPN","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#shell","text":"The default shell for users. This will be assigned when the user logs in.","title":"shell"},{"location":"reference/himmelblau-conf/#examples_35","text":"shell = /bin/bash","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#idmap_range","text":"Specifies the range of IDs to be used for the user and group mappings. When this option is modified, you SHOULD run: sudo aad-tool cache-clear --full To ensure that old cached ID mappings are cleared, preventing potential UID overlaps caused by stale cache data. Afterwards, restart himmelblaud.","title":"idmap_range"},{"location":"reference/himmelblau-conf/#examples_36","text":"idmap_range = 5000000-5999999","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#connection_timeout","text":"The timeout for connections to the authentication server. Default is 2 seconds.","title":"connection_timeout"},{"location":"reference/himmelblau-conf/#examples_37","text":"connection_timeout = 5","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#cache_timeout","text":"The timeout for caching authentication data. Default is 300 seconds (5 minutes).","title":"cache_timeout"},{"location":"reference/himmelblau-conf/#examples_38","text":"cache_timeout = 10","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#use_etc_skel","text":"If set to true, Himmelblau will use the contents of /etc/skel when creating new user directories.","title":"use_etc_skel"},{"location":"reference/himmelblau-conf/#examples_39","text":"use_etc_skel = false","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#selinux","text":"Whether SELinux security labels should be applied to users' home directories. Set to true to enable.","title":"selinux"},{"location":"reference/himmelblau-conf/#examples_40","text":"selinux = true","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#join_type","text":"Specifies whether the system should join or register with Microsoft Entra ID.","title":"join_type"},{"location":"reference/himmelblau-conf/#examples_41","text":"join_type = register","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#user_map_file","text":"Specifies the path to a user-mapping file used to map local user accounts to Azure Entra ID user accounts, allowing them to authenticate using Entra ID credentials. Each line of the file must contain a single mapping entry in the format: local_username:name@domain Blank lines and lines beginning with \u2018#\u2019 are ignored. If this option is not set, the default path /etc/himmelblau/user-map is used.","title":"user_map_file"},{"location":"reference/himmelblau-conf/#examples_42","text":"user_map_file = /path/to/user_map","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#examples_43","text":"","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#example-user-map-file-entries","text":"","title":"Example user-map file entries:"},{"location":"reference/himmelblau-conf/#local_usernamesamaccountnamedomain","text":"alice:alice@contoso.com bob:bob.smith@example.org svcuser:service.account@tenant.local","title":"local_username:samaccountname@domain"},{"location":"reference/himmelblau-conf/#offline-breakglass-configuration","text":"The [offline_breakglass] section configures Himmelblau\u2019s emergency offline authentication mechanism, used when Azure Entra ID is unavailable. Offline breakglass allows Entra ID users who normally require multi-factor authentication (MFA) to authenticate with their cached password when the host is offline. This feature provides a controlled fallback for MFA-only users who would otherwise be unable to sign in during an outage. Single-factor authentication (SFA-only) users and Hello-PIN users already have offline sign-in capability, and are unaffected by this setting. This option exists solely to extend limited offline access to MFA-enabled users when network connectivity to Entra ID cannot be established.","title":"OFFLINE BREAKGLASS CONFIGURATION"},{"location":"reference/himmelblau-conf/#offline_breakglass","text":"This section controls whether and how Himmelblau may perform offline password authentication for MFA-enabled users in emergency conditions.","title":"[offline_breakglass]"},{"location":"reference/himmelblau-conf/#enabled","text":"Boolean value specifying whether offline breakglass mode is permitted. When set to true, Himmelblau will cache secure, salted password verifiers for MFA-enabled Entra ID users who successfully authenticate online. These verifiers can then be used to authenticate the same users when Entra ID is unreachable, allowing MFA users to log in using their cached password. If this option is set to false (the default), Himmelblau will continue to cache password verifiers only for SFA-only users, and MFA-enabled users will not be able to authenticate when offline. The aad-tool (1) command aad-tool offline-breakglass will also have no effect. Administrators must enable this option well in advance of an outage, as password verifiers for MFA users are only stored following a successful online authentication. It is too late to enable this feature once Entra ID is already unreachable. Enabling offline breakglass mode carries significant risk. If a device is stolen or compromised, and network access to Entra ID is blocked, attackers could effectively disable MFA protection by forcing the system into a simple password-only (SFA) authentication state. Administrators should enable this mode only after careful consideration of their organization\u2019s security posture and offline access requirements. This feature does not apply to passwordless accounts. If an MFA user signs in using a passwordless method, no password hash exists to cache, and offline breakglass cannot function for that user.","title":"enabled"},{"location":"reference/himmelblau-conf/#examples_44","text":"[offline_breakglass] enabled = true ttl = 2h","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#allow-mfa-users-to-authenticate-offline-for-up-to-2-hours","text":"","title":"Allow MFA users to authenticate offline for up to 2 hours"},{"location":"reference/himmelblau-conf/#ttl","text":"Specifies how long breakglass mode should remain active once triggered. The value may include a suffix to indicate the unit of time: m for minutes, h for hours, or d for days. If no suffix is provided, the value is interpreted as seconds. After the specified period, offline breakglass mode automatically expires and normal authentication resumes.","title":"ttl"},{"location":"reference/himmelblau-conf/#examples_45","text":"[offline_breakglass] enabled = true ttl = 1d","title":"EXAMPLES"},{"location":"reference/himmelblau-conf/#permit-offline-mfa-logins-for-up-to-24-hours-after-activation","text":"","title":"Permit offline MFA logins for up to 24 hours after activation"},{"location":"reference/himmelblau-conf/#see-also","text":"himmelblaud(8), himmelblaud-tasks(8)","title":"SEE ALSO"},{"location":"reference/himmelblaud/","text":"NAME himmelblaud - Himmelblau Authentication Daemon for Azure Entra ID SYNOPSIS himmelblaud [ OPTIONS ] DESCRIPTION The himmelblaud daemon is responsible for authenticating users against Azure Entra ID and managing group and user information. It operates as a background service, handling authentication requests and maintaining a cache of user and group data. OPTIONS -r , --skip-root-check Bypass the check that prevents running the daemon as the root user. This option is risky and should never be used in production environments due to potential security vulnerabilities. It can also be set through the environment variable HIMMELBLAU_SKIP_ROOT_CHECK . -d , --debug Enable verbose debug output. This option will show detailed diagnostic information useful for troubleshooting and debugging. Can also be set via the environment variable HIMMELBLAU_DEBUG . -t , --configtest Display the daemon\u2019s current configuration and exit. This is useful for verifying that the configuration file is correctly formatted and contains valid options. -c , --config <config> Specify the path to the configuration file for the daemon. The default configuration file is located at /etc/himmelblau/himmelblaud.conf . This option can also be set via the environment variable HIMMELBLAU_CONFIG . -h , --help Show the help message with information about available options. -V , --version Print the version of the himmelblaud daemon and exit. USAGE EXAMPLES Start the daemon: # systemctl start himmelblaud Run with a specific config file: # himmelblaud --config /custom/path/himmelblaud.conf Test the configuration: # himmelblaud --configtest Enable debug mode: # himmelblaud --debug SEE ALSO himmelblaud-tasks(8)","title":"Himmelblaud"},{"location":"reference/himmelblaud/#name","text":"himmelblaud - Himmelblau Authentication Daemon for Azure Entra ID","title":"NAME"},{"location":"reference/himmelblaud/#synopsis","text":"himmelblaud [ OPTIONS ]","title":"SYNOPSIS"},{"location":"reference/himmelblaud/#description","text":"The himmelblaud daemon is responsible for authenticating users against Azure Entra ID and managing group and user information. It operates as a background service, handling authentication requests and maintaining a cache of user and group data.","title":"DESCRIPTION"},{"location":"reference/himmelblaud/#options","text":"-r , --skip-root-check Bypass the check that prevents running the daemon as the root user. This option is risky and should never be used in production environments due to potential security vulnerabilities. It can also be set through the environment variable HIMMELBLAU_SKIP_ROOT_CHECK .","title":"OPTIONS"},{"location":"reference/himmelblaud/#-d-debug","text":"Enable verbose debug output. This option will show detailed diagnostic information useful for troubleshooting and debugging. Can also be set via the environment variable HIMMELBLAU_DEBUG .","title":"-d, --debug"},{"location":"reference/himmelblaud/#-t-configtest","text":"Display the daemon\u2019s current configuration and exit. This is useful for verifying that the configuration file is correctly formatted and contains valid options.","title":"-t, --configtest"},{"location":"reference/himmelblaud/#-c-config-config","text":"Specify the path to the configuration file for the daemon. The default configuration file is located at /etc/himmelblau/himmelblaud.conf . This option can also be set via the environment variable HIMMELBLAU_CONFIG .","title":"-c, --config &lt;config&gt;"},{"location":"reference/himmelblaud/#-h-help","text":"Show the help message with information about available options.","title":"-h, --help"},{"location":"reference/himmelblaud/#-v-version","text":"Print the version of the himmelblaud daemon and exit.","title":"-V, --version"},{"location":"reference/himmelblaud/#usage-examples","text":"Start the daemon: # systemctl start himmelblaud","title":"USAGE EXAMPLES"},{"location":"reference/himmelblaud/#run-with-a-specific-config-file","text":"# himmelblaud --config /custom/path/himmelblaud.conf","title":"Run with a specific config file:"},{"location":"reference/himmelblaud/#test-the-configuration","text":"# himmelblaud --configtest","title":"Test the configuration:"},{"location":"reference/himmelblaud/#enable-debug-mode","text":"# himmelblaud --debug","title":"Enable debug mode:"},{"location":"reference/himmelblaud/#see-also","text":"himmelblaud-tasks(8)","title":"SEE ALSO"},{"location":"reference/himmelblaud_tasks/","text":"NAME himmelblaud_tasks - Home directory creation daemon for Himmelblau SYNOPSIS himmelblaud_tasks DESCRIPTION The himmelblaud-tasks daemon is responsible for managing user accounts and authentication tasks in a Linux environment. Upon successful authentication via Azure Entra ID, it automatically creates home directories for users, adds them to configured local groups, executes the configured logon script, and handles the caching of Kerberos ccache files. This service requires root privileges to perform actions such as creating directories in system locations and managing group memberships. The daemon operates as a background service and does not accept any command-line arguments. It is automatically invoked by the system when required. USAGE The himmelblaud-tasks daemon must be run as the root user. If the daemon is started without root privileges, it will fail with an error. No user interaction is needed beyond ensuring the daemon is active and running correctly. EXAMPLES Start the daemon: # systemctl start himmelblaud-tasks Verify the status of the daemon: # systemctl status himmelblaud-tasks NOTES This daemon is a key component of Himmelblau, handling several critical tasks for user authentication. In addition to creating user home directories, it adds users to the configured local groups, executes the configured logon script, and manages the caching of Kerberos ccache files. These functions ensure that users have the necessary environment and access rights in place for a seamless login experience after authentication. SEE ALSO himmelblaud(8),","title":"Himmelblaud tasks"},{"location":"reference/himmelblaud_tasks/#name","text":"himmelblaud_tasks - Home directory creation daemon for Himmelblau","title":"NAME"},{"location":"reference/himmelblaud_tasks/#synopsis","text":"himmelblaud_tasks","title":"SYNOPSIS"},{"location":"reference/himmelblaud_tasks/#description","text":"The himmelblaud-tasks daemon is responsible for managing user accounts and authentication tasks in a Linux environment. Upon successful authentication via Azure Entra ID, it automatically creates home directories for users, adds them to configured local groups, executes the configured logon script, and handles the caching of Kerberos ccache files. This service requires root privileges to perform actions such as creating directories in system locations and managing group memberships. The daemon operates as a background service and does not accept any command-line arguments. It is automatically invoked by the system when required.","title":"DESCRIPTION"},{"location":"reference/himmelblaud_tasks/#usage","text":"The himmelblaud-tasks daemon must be run as the root user. If the daemon is started without root privileges, it will fail with an error. No user interaction is needed beyond ensuring the daemon is active and running correctly.","title":"USAGE"},{"location":"reference/himmelblaud_tasks/#examples","text":"Start the daemon: # systemctl start himmelblaud-tasks","title":"EXAMPLES"},{"location":"reference/himmelblaud_tasks/#verify-the-status-of-the-daemon","text":"# systemctl status himmelblaud-tasks","title":"Verify the status of the daemon:"},{"location":"reference/himmelblaud_tasks/#notes","text":"This daemon is a key component of Himmelblau, handling several critical tasks for user authentication. In addition to creating user home directories, it adds users to the configured local groups, executes the configured logon script, and manages the caching of Kerberos ccache files. These functions ensure that users have the necessary environment and access rights in place for a seamless login experience after authentication.","title":"NOTES"},{"location":"reference/himmelblaud_tasks/#see-also","text":"himmelblaud(8),","title":"SEE ALSO"},{"location":"reference/pam_himmelblau/","text":"NAME pam_himmelblau (em enable Azure Entra\u202fID authentication via Himmelblau SYNOPSIS pam_himmelblau.so [debug] [use_first_pass] [ignore_unknown_user] [mfa_poll_prompt] [no_hello_pin] DESCRIPTION pam_himmelblau is a PAM module that authenticates users against Microsoft Azure Entra\u202fID using the Himmelblau daemon ( himmelblaud ). OPTIONS debug Enables verbose logging to stdout. use_first_pass Uses a password already provided by a previous PAM module as either a Linux Hello PIN or an Entra Id password, instead of prompting again. ignore_unknown_user Returns CR]PAM_IGNORER] for users not in Entra\u202fID, allowing fallback to local authentication via subsequent PAM modules. mfa_poll_prompt Workaround for OpenSSH Bug\u202f2876, which prevents PAM messages from being flushed to stdout until after sending a prompt for input. This workaround causes pam to prompt the user to `press enter to continue' when polling on another device for MFA. no_hello_pin Disables Linux Hello PIN login for this service (e.g., for sudo or ssh ), even if Hello is configured globally. PAM CONFIGURATION Configuring PAM ensures authentication requests go through Entra\u202fID when appropriate. Automatic setup On Ubuntu/Debian: sudo pam-auth-update Enable \u201cAzure authentication\u201d and verify PAM files. On openSUSE Tumbleweed or SLE: pam-config --add --himmelblau The aad-tool configure-pam command also inserts recommended directives (dry-run unless --really is used). Manual configuration In /etc/pam.d/common-auth , ensure that the pam_himmelblau.so module is placed after other authentication methods (such as pam_unix.so ). Ensure that other authentication modules are not set to required , as this could cause authentication to fail prior to PAM communicating with Entra ID. Include the ignore_unknown_user option for Himmelblau. Ensure pam_deny.so is placed after all modules, so that unknown users are not implicitly allowed. Note: If you intend to use Hello or Passwordless authentication, it(cqs recommended that pam_himmelblau.so be placed before pam_unix.so in the pam auth stack (but always after pam_localuser.so ), otherwise pam_unix will unnecessarily prompt for a password. auth required pam_env.so auth [default=1 ignore=ignore success=ok] pam_localuser.so auth sufficient pam_unix.so nullok try_first_pass auth sufficient pam_himmelblau.so ignore_unknown_user auth required pam_deny.so Configure /etc/pam.d/common-account in a similar manner. account [default=1 ignore=ignore success=ok] pam_localuser.so account sufficient pam_unix.so account sufficient pam_himmelblau.so ignore_unknown_user account required pam_deny.so In /etc/pam.d/common-session , set pam_himmelblau.so as an optional module. session optional pam_systemd.so session required pam_limits.so session optional pam_unix.so try_first_pass session optional pam_umask.so session optional pam_himmelblau.so session optional pam_env.so In /etc/pam.d/common-password , set pam_himmelblau.so as sufficient. password sufficient pam_himmelblau.so ignore_unknown_user password optional pam_gnome_keyring.so use_authtok password sufficient pam_unix.so use_authtok nullok shadow try_first_pass password required pam_deny.so RETURN VALUES PAM_SUCCESS Authentication or Hello PIN update succeeded. B]PAM_AUTH_ERRR] Authentication failed. This may include incorrect credentials, rejected MFA, or other auth-layer failures. B]PAM_USER_UNKNOWNR] The user was not found in Entra\u202fID. This is bypassed if the ignore_unknown_user option is specified. B]PAM_IGNORER] The module was instructed to skip processing (e.g., due to ignore_unknown_user ). This allows fallback to other PAM modules. B]PAM_SERVICE_ERRR] A configuration or initialization error occurred in the module, or a required daemon was unreachable. B]PAM_CRED_INSUFFICIENTR] The user did not meet the required credential policy. B]PAM_ABORTR] A critical, unrecoverable failure occurred(emsuch as a panic inside the himmelblaud service. SEE ALSO himmelblaud(8) , aad-tool(1) , himmelblau.conf(5) , pam(8) AUTHOR David Mulder dmulder@himmelblau-idm.org, dmulder@samba.org","title":"Pam himmelblau"},{"location":"reference/pam_himmelblau/#name","text":"pam_himmelblau (em enable Azure Entra\u202fID authentication via Himmelblau","title":"NAME"},{"location":"reference/pam_himmelblau/#synopsis","text":"pam_himmelblau.so [debug] [use_first_pass] [ignore_unknown_user] [mfa_poll_prompt] [no_hello_pin]","title":"SYNOPSIS"},{"location":"reference/pam_himmelblau/#description","text":"pam_himmelblau is a PAM module that authenticates users against Microsoft Azure Entra\u202fID using the Himmelblau daemon ( himmelblaud ).","title":"DESCRIPTION"},{"location":"reference/pam_himmelblau/#options","text":"debug Enables verbose logging to stdout. use_first_pass Uses a password already provided by a previous PAM module as either a Linux Hello PIN or an Entra Id password, instead of prompting again. ignore_unknown_user Returns CR]PAM_IGNORER] for users not in Entra\u202fID, allowing fallback to local authentication via subsequent PAM modules. mfa_poll_prompt Workaround for OpenSSH Bug\u202f2876, which prevents PAM messages from being flushed to stdout until after sending a prompt for input. This workaround causes pam to prompt the user to `press enter to continue' when polling on another device for MFA. no_hello_pin Disables Linux Hello PIN login for this service (e.g., for sudo or ssh ), even if Hello is configured globally.","title":"OPTIONS"},{"location":"reference/pam_himmelblau/#pam-configuration","text":"Configuring PAM ensures authentication requests go through Entra\u202fID when appropriate.","title":"PAM CONFIGURATION"},{"location":"reference/pam_himmelblau/#automatic-setup","text":"On Ubuntu/Debian: sudo pam-auth-update Enable \u201cAzure authentication\u201d and verify PAM files. On openSUSE Tumbleweed or SLE: pam-config --add --himmelblau The aad-tool configure-pam command also inserts recommended directives (dry-run unless --really is used).","title":"Automatic setup"},{"location":"reference/pam_himmelblau/#manual-configuration","text":"In /etc/pam.d/common-auth , ensure that the pam_himmelblau.so module is placed after other authentication methods (such as pam_unix.so ). Ensure that other authentication modules are not set to required , as this could cause authentication to fail prior to PAM communicating with Entra ID. Include the ignore_unknown_user option for Himmelblau. Ensure pam_deny.so is placed after all modules, so that unknown users are not implicitly allowed.","title":"Manual configuration"},{"location":"reference/pam_himmelblau/#note-if-you-intend-to-use-hello-or-passwordless-authentication-itcqs-recommended-that-pam_himmelblauso-be-placed-before-pam_unixso-in-the-pam-auth-stack-but-always-after-pam_localuserso-otherwise-pam_unix-will-unnecessarily-prompt-for-a-password","text":"auth required pam_env.so auth [default=1 ignore=ignore success=ok] pam_localuser.so auth sufficient pam_unix.so nullok try_first_pass auth sufficient pam_himmelblau.so ignore_unknown_user auth required pam_deny.so Configure /etc/pam.d/common-account in a similar manner. account [default=1 ignore=ignore success=ok] pam_localuser.so account sufficient pam_unix.so account sufficient pam_himmelblau.so ignore_unknown_user account required pam_deny.so In /etc/pam.d/common-session , set pam_himmelblau.so as an optional module. session optional pam_systemd.so session required pam_limits.so session optional pam_unix.so try_first_pass session optional pam_umask.so session optional pam_himmelblau.so session optional pam_env.so In /etc/pam.d/common-password , set pam_himmelblau.so as sufficient. password sufficient pam_himmelblau.so ignore_unknown_user password optional pam_gnome_keyring.so use_authtok password sufficient pam_unix.so use_authtok nullok shadow try_first_pass password required pam_deny.so","title":"Note: If you intend to use Hello or Passwordless authentication, it(cqs recommended that pam_himmelblau.so be placed before pam_unix.so in the pam auth stack (but always after pam_localuser.so), otherwise pam_unix will unnecessarily prompt for a password."},{"location":"reference/pam_himmelblau/#return-values","text":"PAM_SUCCESS Authentication or Hello PIN update succeeded. B]PAM_AUTH_ERRR] Authentication failed. This may include incorrect credentials, rejected MFA, or other auth-layer failures. B]PAM_USER_UNKNOWNR] The user was not found in Entra\u202fID. This is bypassed if the ignore_unknown_user option is specified. B]PAM_IGNORER] The module was instructed to skip processing (e.g., due to ignore_unknown_user ). This allows fallback to other PAM modules. B]PAM_SERVICE_ERRR] A configuration or initialization error occurred in the module, or a required daemon was unreachable. B]PAM_CRED_INSUFFICIENTR] The user did not meet the required credential policy. B]PAM_ABORTR] A critical, unrecoverable failure occurred(emsuch as a panic inside the himmelblaud service.","title":"RETURN VALUES"},{"location":"reference/pam_himmelblau/#see-also","text":"himmelblaud(8) , aad-tool(1) , himmelblau.conf(5) , pam(8)","title":"SEE ALSO"},{"location":"reference/pam_himmelblau/#author","text":"David Mulder dmulder@himmelblau-idm.org, dmulder@samba.org","title":"AUTHOR"},{"location":"troubleshooting/Capturing-authentication-traffic-using-cirrus%E2%80%90scope/","text":"Capturing OAuth2 traffic when authenticating to Azure Entra ID is essential for debugging and resolving issues in the libhimmelblau library. By inspecting the detailed HTTP requests and responses exchanged during the authentication process, developers can identify discrepancies, such as malformed requests, unexpected status codes, or incorrect parameters. This comprehensive view helps pinpoint where errors occur, enabling targeted fixes and enhancements to improve the reliability and functionality of Himmelblau, ultimately leading to smoother integrations and user experiences. This guide walks you through how to capture and inspect authentication traffic using the cirrus-scope diagnostic tool along with mitmproxy . New: cirrus-scope now includes an obfuscate command to help automatically mask sensitive data from these captures before sharing them. Step-by-Step Instructions You\u2019ll learn how to capture traffic, then obfuscate sensitive details using cirrus-scope obfuscate . Download cirrus-scope : Prebuilt binaries are available from the official Himmelblau downloads page: \ud83d\udc49 https://himmelblau-idm.org/downloads.html Download mitmproxy : Download mitmproxy from their website , and extract the binaries. tar -xf mitmproxy-11.0.0-linux-x86_64.tar.gz Start mitmweb : Run the following command to start mitmweb : ./mitmweb This starts mitmweb and opens a web interface for monitoring HTTP and HTTPS traffic. Install the mitmproxy CA Certificate : On Ubuntu, sudo cp $HOME/.mitmproxy/mitmproxy-ca-cert.pem /usr/local/share/ca-certificates/mitmproxy.crt sudo update-ca-certificates Or on Fedora, sudo cp $HOME/.mitmproxy/mitmproxy-ca-cert.pem /etc/pki/ca-trust/source/anchors/ sudo update-ca-trust Or on openSUSE Leap, sudo cp $HOME/.mitmproxy/mitmproxy-ca-cert.pem /usr/share/pki/trust/anchors/mitmproxy.crt sudo update-ca-certificates Access the Web Interface : Open your web browser and go to: http://127.0.0.1:8081/ You should see the mitmweb dashboard for viewing captured traffic. Run cirrus-scope with Proxy Enabled : Run the desired test command from cirrus-scope , routing its traffic through mitmproxy by setting the HTTPS_PROXY environment variable. Example: HTTPS_PROXY=http://127.0.0.1:8080 cirrus-scope auth-test --name your_user@example.com You will be prompted to enter credentials interactively. You can add --debug for detailed logs: HTTPS_PROXY=http://127.0.0.1:8080 cirrus-scope auth-test --name your_user@example.com --debug Other available test commands include: enrollment-test : Simulates device enrollment refresh-token-acquire : Acquires new access tokens using a refresh token provision-hello-key-test : Tests Hello for Business key provisioning Capture and Save the HAR File : Go to the mitmweb dashboard in your web browser. Click on the \"File\" drop down menu, then \"Save\". Your browser will download a file called 'flows' Obfuscate the capture using cirrus-scope : To help protect sensitive information, run the built-in obfuscator on your captured flows file. This will automatically replace known tokens (like JWTs, Kerberos tickets, flow tokens, request blobs, and your tenant ID) with equal-length asterisk sequences so that the file remains structurally valid. Example: bash cirrus-scope obfuscate -i flows -o flows.obfuscated You can also specify explicit secrets to obfuscate using the --custom option, for example: ```bash cirrus-scope obfuscate -i flows -o flows.obfuscated \\ --custom \"your_user@example.com\" \\ --custom \"SuperSecretPassword\" ``` This ensures additional sensitive data like emails or passwords are masked. The resulting file flows.obfuscated will be safe to share for debugging, while still maintaining the exact format required for tools like mitmproxy. That's it! You have now captured, obfuscated, and saved HTTP(S) traffic as a HAR file. Important: Always use cirrus-scope obfuscate to sanitize your capture. Manually editing the file to remove secrets can corrupt the format, making it unreadable by mitmproxy or other tools. This tool replaces sensitive data with exact-length values to keep the file structurally valid. It remains your responsibility to review the file to ensure no secrets remain. Passwords and plaintext credentials are not detected automatically \u2014 always provide them explicitly via --custom if needed.","title":"Capturing authentication traffic using cirrus\u2010scope"},{"location":"troubleshooting/Capturing-authentication-traffic-using-cirrus%E2%80%90scope/#step-by-step-instructions","text":"You\u2019ll learn how to capture traffic, then obfuscate sensitive details using cirrus-scope obfuscate . Download cirrus-scope : Prebuilt binaries are available from the official Himmelblau downloads page: \ud83d\udc49 https://himmelblau-idm.org/downloads.html Download mitmproxy : Download mitmproxy from their website , and extract the binaries. tar -xf mitmproxy-11.0.0-linux-x86_64.tar.gz Start mitmweb : Run the following command to start mitmweb : ./mitmweb This starts mitmweb and opens a web interface for monitoring HTTP and HTTPS traffic. Install the mitmproxy CA Certificate : On Ubuntu, sudo cp $HOME/.mitmproxy/mitmproxy-ca-cert.pem /usr/local/share/ca-certificates/mitmproxy.crt sudo update-ca-certificates Or on Fedora, sudo cp $HOME/.mitmproxy/mitmproxy-ca-cert.pem /etc/pki/ca-trust/source/anchors/ sudo update-ca-trust Or on openSUSE Leap, sudo cp $HOME/.mitmproxy/mitmproxy-ca-cert.pem /usr/share/pki/trust/anchors/mitmproxy.crt sudo update-ca-certificates Access the Web Interface : Open your web browser and go to: http://127.0.0.1:8081/ You should see the mitmweb dashboard for viewing captured traffic. Run cirrus-scope with Proxy Enabled : Run the desired test command from cirrus-scope , routing its traffic through mitmproxy by setting the HTTPS_PROXY environment variable. Example: HTTPS_PROXY=http://127.0.0.1:8080 cirrus-scope auth-test --name your_user@example.com You will be prompted to enter credentials interactively. You can add --debug for detailed logs: HTTPS_PROXY=http://127.0.0.1:8080 cirrus-scope auth-test --name your_user@example.com --debug Other available test commands include: enrollment-test : Simulates device enrollment refresh-token-acquire : Acquires new access tokens using a refresh token provision-hello-key-test : Tests Hello for Business key provisioning Capture and Save the HAR File : Go to the mitmweb dashboard in your web browser. Click on the \"File\" drop down menu, then \"Save\". Your browser will download a file called 'flows' Obfuscate the capture using cirrus-scope : To help protect sensitive information, run the built-in obfuscator on your captured flows file. This will automatically replace known tokens (like JWTs, Kerberos tickets, flow tokens, request blobs, and your tenant ID) with equal-length asterisk sequences so that the file remains structurally valid. Example: bash cirrus-scope obfuscate -i flows -o flows.obfuscated You can also specify explicit secrets to obfuscate using the --custom option, for example: ```bash cirrus-scope obfuscate -i flows -o flows.obfuscated \\ --custom \"your_user@example.com\" \\ --custom \"SuperSecretPassword\" ``` This ensures additional sensitive data like emails or passwords are masked. The resulting file flows.obfuscated will be safe to share for debugging, while still maintaining the exact format required for tools like mitmproxy. That's it! You have now captured, obfuscated, and saved HTTP(S) traffic as a HAR file.","title":"Step-by-Step Instructions"},{"location":"troubleshooting/Capturing-authentication-traffic-using-cirrus%E2%80%90scope/#important","text":"Always use cirrus-scope obfuscate to sanitize your capture. Manually editing the file to remove secrets can corrupt the format, making it unreadable by mitmproxy or other tools. This tool replaces sensitive data with exact-length values to keep the file structurally valid. It remains your responsibility to review the file to ensure no secrets remain. Passwords and plaintext credentials are not detected automatically \u2014 always provide them explicitly via --custom if needed.","title":"Important:"},{"location":"troubleshooting/OpenSSH-Bug-2876-%E2%80%90--Unable-to-use-MFA-over-SSH-%E2%80%90-Workaround/","text":"Summary of Bug 2876 Bug 2876 in OpenSSH pertains to an issue with PAM info messages not being flushed to the console until further interaction is required. This leads to problems in scenarios where multiple authentication prompts are expected, such as with Microsoft Authenticator's Push MFA. Problem Behavior When attempting to authenticate via SSH with an account that requires Microsoft Authenticator (Push) MFA , the prompt displaying the number to enter into the app is delayed or not shown until after the initial authentication fails. This leads to confusion, as the user receives the MFA push notification on their device but cannot complete the authentication due to the missing prompt. Local Login (Working as Expected) When logging in locally (e.g., via su -l ), the password prompt and the MFA number prompt are displayed as expected, and the user is able to complete the login process: admin@dev01:~$ su -l user@domain.onmicrosoft.com Password: Open your Authenticator app, and enter the number '73' to sign in. user@domain.onmicrosoft.com@dev01:~$ whoami user@domain.onmicrosoft.com Remote SSH Login (Delayed MFA Prompt) When logging in remotely via SSH, only the password prompt is shown initially, and the MFA number prompt is delayed until the authentication fails: localuser@workstation:~$ ssh user@domain.onmicrosoft.com@dev01 (user@domain.onmicrosoft.com@dev01) Password: ## Note: The MFA push notification is received, but no number is shown to complete the authentication. (user@domain.onmicrosoft.com@dev01) Open your Authenticator app, and enter the number '59' to sign in. Password: ^C This behavior disrupts the MFA flow, as the number needed to complete the login is not shown to the user until the session has already failed. Upstream Status The fix for this issue has been proposed in Pull Request 452 on GitHub , but the upstream OpenSSH community has been slow to review and merge the patch. This means that users on most systems will continue to face this issue unless they apply the fix downstream. Downstream Fixes openSUSE and Ubuntu have both applied the patch in their respective distributions. Users running OpenSSH on these systems should be free of this bug on recent versions of the distributions. Working Around Bug 2876 in Himmelblau (introduced in Himmelblau 0.6.0) This bug can cause significant disruption to SSH-based logins. If you're using a system affected by Bug 2876 and the patch has not been applied upstream, you can work around the issue by configuring the pam_himmelblau.so module with the mfa_poll_prompt option. This forces the prompt to be shown to the user at the appropriate time. Step-by-Step Instructions Locate the PAM Configuration : See the Himmelblau instructions for configuring PAM . You could apply a targeted work around by modifying the file /etc/pam.d/sshd . Add the mfa_poll_prompt Option : To avoid the prompt delay caused by Bug 2876, modify the PAM configuration for Himmelblau by adding the mfa_poll_prompt option to the pam_himmelblau.so module. Example PAM configuration: auth required pam_himmelblau.so ignore_unknown_user mfa_poll_prompt Test the Setup : Attempt an SSH login using an account with Microsoft Authenticator Push MFA enabled and ensure that the MFA number prompt is displayed as expected. The mfa_poll_prompt option in the workaround introduces a \"Press enter to continue\" prompt during the MFA flow, which forces user interaction. This interaction triggers OpenSSH to flush its buffered output, causing the previously delayed MFA number prompt to be displayed. As a result, the user can view the MFA prompt and complete the authentication process without waiting for a failed login attempt. Here\u2019s an example of what the login process will look like to the user with the workaround in place: localuser@workstation:~$ ssh user@domain.onmicrosoft.com@dev01 (user@domain.onmicrosoft.com@dev01) Password: Open your Authenticator app, and enter the number '59' to sign in. Press enter to continue ## Note: The user must now press enter to continue the MFA authentication.","title":"OpenSSH Bug 2876 \u2010  Unable to use MFA over SSH \u2010 Workaround"},{"location":"troubleshooting/OpenSSH-Bug-2876-%E2%80%90--Unable-to-use-MFA-over-SSH-%E2%80%90-Workaround/#summary-of-bug-2876","text":"Bug 2876 in OpenSSH pertains to an issue with PAM info messages not being flushed to the console until further interaction is required. This leads to problems in scenarios where multiple authentication prompts are expected, such as with Microsoft Authenticator's Push MFA.","title":"Summary of Bug 2876"},{"location":"troubleshooting/OpenSSH-Bug-2876-%E2%80%90--Unable-to-use-MFA-over-SSH-%E2%80%90-Workaround/#problem-behavior","text":"When attempting to authenticate via SSH with an account that requires Microsoft Authenticator (Push) MFA , the prompt displaying the number to enter into the app is delayed or not shown until after the initial authentication fails. This leads to confusion, as the user receives the MFA push notification on their device but cannot complete the authentication due to the missing prompt.","title":"Problem Behavior"},{"location":"troubleshooting/OpenSSH-Bug-2876-%E2%80%90--Unable-to-use-MFA-over-SSH-%E2%80%90-Workaround/#local-login-working-as-expected","text":"When logging in locally (e.g., via su -l ), the password prompt and the MFA number prompt are displayed as expected, and the user is able to complete the login process: admin@dev01:~$ su -l user@domain.onmicrosoft.com Password: Open your Authenticator app, and enter the number '73' to sign in. user@domain.onmicrosoft.com@dev01:~$ whoami user@domain.onmicrosoft.com","title":"Local Login (Working as Expected)"},{"location":"troubleshooting/OpenSSH-Bug-2876-%E2%80%90--Unable-to-use-MFA-over-SSH-%E2%80%90-Workaround/#remote-ssh-login-delayed-mfa-prompt","text":"When logging in remotely via SSH, only the password prompt is shown initially, and the MFA number prompt is delayed until the authentication fails: localuser@workstation:~$ ssh user@domain.onmicrosoft.com@dev01 (user@domain.onmicrosoft.com@dev01) Password: ## Note: The MFA push notification is received, but no number is shown to complete the authentication. (user@domain.onmicrosoft.com@dev01) Open your Authenticator app, and enter the number '59' to sign in. Password: ^C This behavior disrupts the MFA flow, as the number needed to complete the login is not shown to the user until the session has already failed.","title":"Remote SSH Login (Delayed MFA Prompt)"},{"location":"troubleshooting/OpenSSH-Bug-2876-%E2%80%90--Unable-to-use-MFA-over-SSH-%E2%80%90-Workaround/#upstream-status","text":"The fix for this issue has been proposed in Pull Request 452 on GitHub , but the upstream OpenSSH community has been slow to review and merge the patch. This means that users on most systems will continue to face this issue unless they apply the fix downstream.","title":"Upstream Status"},{"location":"troubleshooting/OpenSSH-Bug-2876-%E2%80%90--Unable-to-use-MFA-over-SSH-%E2%80%90-Workaround/#downstream-fixes","text":"openSUSE and Ubuntu have both applied the patch in their respective distributions. Users running OpenSSH on these systems should be free of this bug on recent versions of the distributions.","title":"Downstream Fixes"},{"location":"troubleshooting/OpenSSH-Bug-2876-%E2%80%90--Unable-to-use-MFA-over-SSH-%E2%80%90-Workaround/#working-around-bug-2876-in-himmelblau-introduced-in-himmelblau-060","text":"This bug can cause significant disruption to SSH-based logins. If you're using a system affected by Bug 2876 and the patch has not been applied upstream, you can work around the issue by configuring the pam_himmelblau.so module with the mfa_poll_prompt option. This forces the prompt to be shown to the user at the appropriate time.","title":"Working Around Bug 2876 in Himmelblau (introduced in Himmelblau 0.6.0)"},{"location":"troubleshooting/OpenSSH-Bug-2876-%E2%80%90--Unable-to-use-MFA-over-SSH-%E2%80%90-Workaround/#step-by-step-instructions","text":"Locate the PAM Configuration : See the Himmelblau instructions for configuring PAM . You could apply a targeted work around by modifying the file /etc/pam.d/sshd . Add the mfa_poll_prompt Option : To avoid the prompt delay caused by Bug 2876, modify the PAM configuration for Himmelblau by adding the mfa_poll_prompt option to the pam_himmelblau.so module. Example PAM configuration: auth required pam_himmelblau.so ignore_unknown_user mfa_poll_prompt Test the Setup : Attempt an SSH login using an account with Microsoft Authenticator Push MFA enabled and ensure that the MFA number prompt is displayed as expected. The mfa_poll_prompt option in the workaround introduces a \"Press enter to continue\" prompt during the MFA flow, which forces user interaction. This interaction triggers OpenSSH to flush its buffered output, causing the previously delayed MFA number prompt to be displayed. As a result, the user can view the MFA prompt and complete the authentication process without waiting for a failed login attempt. Here\u2019s an example of what the login process will look like to the user with the workaround in place: localuser@workstation:~$ ssh user@domain.onmicrosoft.com@dev01 (user@domain.onmicrosoft.com@dev01) Password: Open your Authenticator app, and enter the number '59' to sign in. Press enter to continue ## Note: The user must now press enter to continue the MFA authentication.","title":"Step-by-Step Instructions"},{"location":"troubleshooting/Removing-all-Hello-PINs-%26-cached-PRTs-on-a-Himmelblau-host/","text":"Overview Hello PINs (and associated keys) for Himmelblau are stored in the SQLite database: /var/cache/himmelblaud/himmelblau.cache.db They are stored and encrypted as entries in the hsm_data_t table with keys like: <user>/hello <user>/hello_decoupled <user>/hello_prt Where <user> is the full UPN (e.g. alice@domain.com ). This guide provides a script to remove all Hello PINs (regular & decoupled) and cached PRTs, regardless of the user. What exactly gets deleted? Key pattern Meaning %/hello Hello PIN (normal, linked to Entra Id) %/hello_decoupled Hello PIN (offline / decoupled, for DAG MFA) %/hello_prt Cached PRT for offline login with SSO This ensures the host no longer has stored Hello PINs or cached tokens, forcing fresh authentication. The cleanup script Below is a simple shell script that will safely delete these keys using sqlite3 . It requires root privileges because /var/cache/himmelblaud/himmelblau.cache.db is owned by the himmelblaud user. \ud83d\udca1 Make sure the Himmelblau daemon is stopped while running this, to avoid database locking issues. sudo systemctl stop himmelblaud #!/usr/bin/env bash set -euo pipefail DB_PATH=\"/var/cache/himmelblaud/himmelblau.cache.db\" if [[ ! -f \"$DB_PATH\" ]]; then echo \"Error: Database not found at $DB_PATH\" exit 1 fi echo \"Removing all Hello PINs and cached PRTs from $DB_PATH ...\" sqlite3 \"$DB_PATH\" <<EOF DELETE FROM hsm_data_t WHERE key LIKE '%/hello'; DELETE FROM hsm_data_t WHERE key LIKE '%/hello_decoupled'; DELETE FROM hsm_data_t WHERE key LIKE '%/hello_prt'; EOF echo \"Cleanup completed.\" How to use Save the script to a file, e.g. remove_himmelblau_hello_pins.sh Make it executable: chmod +x remove_himmelblau_hello_pins.sh Stop Himmelblau daemon: sudo systemctl stop himmelblaud Run the script: sudo ./remove_himmelblau_hello_pins.sh Restart Himmelblau daemon: sudo systemctl start himmelblaud Notes for Himmelblau versions Himmelblau Version Key types present 0.9.x Only %/hello (regular PINs) >=1.0.x %/hello , %/hello_decoupled , %/hello_prt Done! The host is now wiped of all Hello PINs and cached PRTs. New PIN enrollments or sign-ins will need to occur on next use.","title":"Removing all Hello PINs & cached PRTs on a Himmelblau host"},{"location":"troubleshooting/Removing-all-Hello-PINs-%26-cached-PRTs-on-a-Himmelblau-host/#overview","text":"Hello PINs (and associated keys) for Himmelblau are stored in the SQLite database: /var/cache/himmelblaud/himmelblau.cache.db They are stored and encrypted as entries in the hsm_data_t table with keys like: <user>/hello <user>/hello_decoupled <user>/hello_prt Where <user> is the full UPN (e.g. alice@domain.com ). This guide provides a script to remove all Hello PINs (regular & decoupled) and cached PRTs, regardless of the user.","title":"Overview"},{"location":"troubleshooting/Removing-all-Hello-PINs-%26-cached-PRTs-on-a-Himmelblau-host/#what-exactly-gets-deleted","text":"Key pattern Meaning %/hello Hello PIN (normal, linked to Entra Id) %/hello_decoupled Hello PIN (offline / decoupled, for DAG MFA) %/hello_prt Cached PRT for offline login with SSO This ensures the host no longer has stored Hello PINs or cached tokens, forcing fresh authentication.","title":"What exactly gets deleted?"},{"location":"troubleshooting/Removing-all-Hello-PINs-%26-cached-PRTs-on-a-Himmelblau-host/#the-cleanup-script","text":"Below is a simple shell script that will safely delete these keys using sqlite3 . It requires root privileges because /var/cache/himmelblaud/himmelblau.cache.db is owned by the himmelblaud user. \ud83d\udca1 Make sure the Himmelblau daemon is stopped while running this, to avoid database locking issues. sudo systemctl stop himmelblaud #!/usr/bin/env bash set -euo pipefail DB_PATH=\"/var/cache/himmelblaud/himmelblau.cache.db\" if [[ ! -f \"$DB_PATH\" ]]; then echo \"Error: Database not found at $DB_PATH\" exit 1 fi echo \"Removing all Hello PINs and cached PRTs from $DB_PATH ...\" sqlite3 \"$DB_PATH\" <<EOF DELETE FROM hsm_data_t WHERE key LIKE '%/hello'; DELETE FROM hsm_data_t WHERE key LIKE '%/hello_decoupled'; DELETE FROM hsm_data_t WHERE key LIKE '%/hello_prt'; EOF echo \"Cleanup completed.\"","title":"The cleanup script"},{"location":"troubleshooting/Removing-all-Hello-PINs-%26-cached-PRTs-on-a-Himmelblau-host/#how-to-use","text":"Save the script to a file, e.g. remove_himmelblau_hello_pins.sh Make it executable: chmod +x remove_himmelblau_hello_pins.sh Stop Himmelblau daemon: sudo systemctl stop himmelblaud Run the script: sudo ./remove_himmelblau_hello_pins.sh Restart Himmelblau daemon: sudo systemctl start himmelblaud","title":"How to use"},{"location":"troubleshooting/Removing-all-Hello-PINs-%26-cached-PRTs-on-a-Himmelblau-host/#notes-for-himmelblau-versions","text":"Himmelblau Version Key types present 0.9.x Only %/hello (regular PINs) >=1.0.x %/hello , %/hello_decoupled , %/hello_prt Done! The host is now wiped of all Hello PINs and cached PRTs. New PIN enrollments or sign-ins will need to occur on next use.","title":"Notes for Himmelblau versions"},{"location":"troubleshooting/Testing-Himmelblau-Developer-Builds-with-Packet-Capture/","text":"A Himmelblau developer build allows you to proxy all communication between himmelblaud and Azure Entra ID. This is critical for diagnosing low-level authentication or policy issues. These instructions will walk you through setting up mitmproxy , ensuring your himmelblaud service is routed through it, installing the proxy certificate, and finally capturing and obfuscating the traffic. \ud83d\udea7 Developer Build Notice \u26a0\ufe0f IMPORTANT WARNING: This special Himmelblau developer build is strictly for debugging and diagnostics. It proxies authentication traffic through mitmproxy , exposing sensitive credentials and tokens. \u27a1\ufe0f Never run this in production. Use it only in controlled test environments to diagnose problems. \ud83d\udce8 How to get a developer build Developer builds are not public binaries. To obtain one: Contact David Mulder (project maintainer): \ud83d\udce7 Email: dmulder@himmelblau-idm.org \ud83d\udcac Matrix: #himmelblau\\:matrix.org 1. Verify your HTTPS_PROXY is set in the service file Open your himmelblaud systemd service file and confirm it is configured to use your local mitmproxy. On Ubuntu/Debian : sudo nano /etc/systemd/system/himmelblaud.service On RHEL/Fedora/openSUSE : sudo nano /usr/lib/systemd/system/himmelblaud.service Make sure it includes, and that the HTTPS_PROXY setting is correct for your mitmproxy instance: Environment=\"HTTPS_PROXY=http://127.0.0.1:8080\" Then reload systemd and restart himmelblaud : sudo systemctl daemon-reload sudo systemctl restart himmelblaud himmelblaud-tasks 2. Install and start mitmweb Download mitmproxy from https://mitmproxy.org/ , extract it, and run: ./mitmweb This launches a local web interface at http://127.0.0.1:8081/ . 3. Install the mitmproxy CA certificate This ensures your system trusts mitmproxy\u2019s TLS interception. Ubuntu/Debian: sudo cp ~/.mitmproxy/mitmproxy-ca-cert.pem /usr/local/share/ca-certificates/mitmproxy.crt sudo update-ca-certificates Fedora/RHEL: sudo cp ~/.mitmproxy/mitmproxy-ca-cert.pem /etc/pki/ca-trust/source/anchors/ sudo update-ca-trust openSUSE: sudo cp ~/.mitmproxy/mitmproxy-ca-cert.pem /usr/share/pki/trust/anchors/mitmproxy.crt sudo update-ca-certificates 4. Reproduce your Himmelblau issue At this point: himmelblaud is routing traffic through 127.0.0.1:8080 mitmweb is running to intercept traffic Trigger the behavior you\u2019re testing \u2014 e.g. SSH login, sudo , or any other process that hits pam_himmelblau . Watch the traffic appear in the mitmweb dashboard at http://127.0.0.1:8081/ . 5. Save the flow file In the mitmweb interface: Click File \u2192 Save . This downloads a file typically called flows . 6. Obfuscate sensitive data with cirrus-scope Before sharing your capture, sanitize it using: cirrus-scope obfuscate -i flows -o flows.obfuscated This automatically masks known sensitive data like JWTs, flow tokens, tenant IDs, etc. You can also specify explicit items to redact (emails, passwords, etc): cirrus-scope obfuscate -i flows -o flows.obfuscated \\ --custom \"admin@contoso.com\" \\ --custom \"SuperSecretPassword\" Done! You can now safely provide flows.obfuscated for debugging. It maintains the structure needed for tools like mitmproxy to replay or analyze, while protecting your secrets. \ud83d\udea8 Important Note Always run cirrus-scope obfuscate before sharing captures. Manually editing the file may break its format. This tool preserves lengths to ensure it remains valid for protocol testing.","title":"Testing Himmelblau Developer Builds with Packet Capture"},{"location":"troubleshooting/Testing-Himmelblau-Developer-Builds-with-Packet-Capture/#developer-build-notice","text":"\u26a0\ufe0f IMPORTANT WARNING: This special Himmelblau developer build is strictly for debugging and diagnostics. It proxies authentication traffic through mitmproxy , exposing sensitive credentials and tokens. \u27a1\ufe0f Never run this in production. Use it only in controlled test environments to diagnose problems.","title":"\ud83d\udea7 Developer Build Notice"},{"location":"troubleshooting/Testing-Himmelblau-Developer-Builds-with-Packet-Capture/#how-to-get-a-developer-build","text":"Developer builds are not public binaries. To obtain one: Contact David Mulder (project maintainer): \ud83d\udce7 Email: dmulder@himmelblau-idm.org \ud83d\udcac Matrix: #himmelblau\\:matrix.org","title":"\ud83d\udce8 How to get a developer build"},{"location":"troubleshooting/Testing-Himmelblau-Developer-Builds-with-Packet-Capture/#1-verify-your-https_proxy-is-set-in-the-service-file","text":"Open your himmelblaud systemd service file and confirm it is configured to use your local mitmproxy. On Ubuntu/Debian : sudo nano /etc/systemd/system/himmelblaud.service On RHEL/Fedora/openSUSE : sudo nano /usr/lib/systemd/system/himmelblaud.service Make sure it includes, and that the HTTPS_PROXY setting is correct for your mitmproxy instance: Environment=\"HTTPS_PROXY=http://127.0.0.1:8080\" Then reload systemd and restart himmelblaud : sudo systemctl daemon-reload sudo systemctl restart himmelblaud himmelblaud-tasks","title":"1. Verify your HTTPS_PROXY is set in the service file"},{"location":"troubleshooting/Testing-Himmelblau-Developer-Builds-with-Packet-Capture/#2-install-and-start-mitmweb","text":"Download mitmproxy from https://mitmproxy.org/ , extract it, and run: ./mitmweb This launches a local web interface at http://127.0.0.1:8081/ .","title":"2. Install and start mitmweb"},{"location":"troubleshooting/Testing-Himmelblau-Developer-Builds-with-Packet-Capture/#3-install-the-mitmproxy-ca-certificate","text":"This ensures your system trusts mitmproxy\u2019s TLS interception. Ubuntu/Debian: sudo cp ~/.mitmproxy/mitmproxy-ca-cert.pem /usr/local/share/ca-certificates/mitmproxy.crt sudo update-ca-certificates Fedora/RHEL: sudo cp ~/.mitmproxy/mitmproxy-ca-cert.pem /etc/pki/ca-trust/source/anchors/ sudo update-ca-trust openSUSE: sudo cp ~/.mitmproxy/mitmproxy-ca-cert.pem /usr/share/pki/trust/anchors/mitmproxy.crt sudo update-ca-certificates","title":"3. Install the mitmproxy CA certificate"},{"location":"troubleshooting/Testing-Himmelblau-Developer-Builds-with-Packet-Capture/#4-reproduce-your-himmelblau-issue","text":"At this point: himmelblaud is routing traffic through 127.0.0.1:8080 mitmweb is running to intercept traffic Trigger the behavior you\u2019re testing \u2014 e.g. SSH login, sudo , or any other process that hits pam_himmelblau . Watch the traffic appear in the mitmweb dashboard at http://127.0.0.1:8081/ .","title":"4. Reproduce your Himmelblau issue"},{"location":"troubleshooting/Testing-Himmelblau-Developer-Builds-with-Packet-Capture/#5-save-the-flow-file","text":"In the mitmweb interface: Click File \u2192 Save . This downloads a file typically called flows .","title":"5. Save the flow file"},{"location":"troubleshooting/Testing-Himmelblau-Developer-Builds-with-Packet-Capture/#6-obfuscate-sensitive-data-with-cirrus-scope","text":"Before sharing your capture, sanitize it using: cirrus-scope obfuscate -i flows -o flows.obfuscated This automatically masks known sensitive data like JWTs, flow tokens, tenant IDs, etc. You can also specify explicit items to redact (emails, passwords, etc): cirrus-scope obfuscate -i flows -o flows.obfuscated \\ --custom \"admin@contoso.com\" \\ --custom \"SuperSecretPassword\"","title":"6. Obfuscate sensitive data with cirrus-scope"},{"location":"troubleshooting/Testing-Himmelblau-Developer-Builds-with-Packet-Capture/#done","text":"You can now safely provide flows.obfuscated for debugging. It maintains the structure needed for tools like mitmproxy to replay or analyze, while protecting your secrets.","title":"Done!"},{"location":"troubleshooting/Testing-Himmelblau-Developer-Builds-with-Packet-Capture/#important-note","text":"Always run cirrus-scope obfuscate before sharing captures. Manually editing the file may break its format. This tool preserves lengths to ensure it remains valid for protocol testing.","title":"\ud83d\udea8 Important Note"},{"location":"troubleshooting/Troubleshooting%3A-%60The-user-%27...%27-already-exists%60-and-fake-users-listed-in-NSS/","text":"Overview When using Himmelblau, you might encounter the error: useradd: user 'test1' already exists or similar behavior when attempting to create local users. You might also notice that nss responds affirmatively to the existence of fake users: $ getent passwd fake_user1 fake_user1@example.com:x:955955525:955955525::/home/fake_user1:/bin/bash $ getent passwd fake_user2 fake_user2@example.com:x:1881368896:1881368896::/home/fake_user2:/bin/bash This problem occurs even for users that neither exist locally nor in your Azure Entra ID tenant. Additionally, this issue can lead to complications with package management tools (e.g., apt or dnf ) that need to create system users during installation. Root Cause This behavior arises from the cn_name_mapping parameter in your himmelblau.conf configuration file. By default, this parameter is enabled ( true ) unless explicitly set to false . When enabled, it automatically maps common names (CN) to user principal names (UPN). The issue appears to occur because user enumeration is disabled in Azure Entra ID . Azure Entra ID is responding to all user existence requests as if the user does exist , regardless of whether the user truly exists in the directory. It's unknown which setting in Azure Entra Id is causing this behavior, but it is assumed that Microsoft has implemented this behavior to ensure authentication does not fail for valid users. If the system always responded that users do not exist, authentication would fail even for legitimate accounts. It's assumed that the purpose of this behavior is to prevent the enumeration of valid UPN names from the directory. When an attacker is able to enumerate a list of valid UPN names, it can enable password spray attacks, brute force attacks, phishing attacks, and password reuse attacks. Impact Local User Management : System tools like useradd fail to create new users. Package Installation : Software installations that create system users for daemons may fail, causing package dependency issues. General User Queries : Tools like getent passwd may list users that do not exist. Solution: Disable cn_name_mapping To mitigate this issue, disable the cn_name_mapping parameter in your Himmelblau configuration file. Locate the Configuration File : The default configuration file is located at: /etc/himmelblau/himmelblau.conf Edit the File : Open the file in your preferred text editor: sudo nano /etc/himmelblau/himmelblau.conf Disable cn_name_mapping : Locate the [global] section and add or modify the following line: cn_name_mapping = false Restart Himmelblau Services : After saving the changes, restart the Himmelblau services to apply the new configuration: sudo systemctl restart himmelblaud sudo systemctl restart himmelblaud-tasks After disabling cn_name_mapping , all users will be required to authenticate to the host using their UPN. Verification Check user enumeration again: getent passwd test1 Ensure the user is not falsely listed. Retry adding a new user: sudo useradd test1 It should now succeed without errors. Notes Disabling cn_name_mapping prevents Himmelblau from making optimistic assumptions about user existence. This adjustment ensures compatibility with environments where Azure Entra ID has user enumeration disabled, aligning expected behavior with the tenant\u2019s security configuration. Additional References For more details about himmelblau.conf parameters, refer to the Himmelblau Configuration Guide or the himmelblau.conf man page . If you continue experiencing issues, consider clearing or invalidating the Himmelblau cache using the aad-tool utility: sudo aad-tool cache-clear","title":"Troubleshooting: `The user '...' already exists` and fake users listed in NSS"},{"location":"troubleshooting/Troubleshooting%3A-%60The-user-%27...%27-already-exists%60-and-fake-users-listed-in-NSS/#overview","text":"When using Himmelblau, you might encounter the error: useradd: user 'test1' already exists or similar behavior when attempting to create local users. You might also notice that nss responds affirmatively to the existence of fake users: $ getent passwd fake_user1 fake_user1@example.com:x:955955525:955955525::/home/fake_user1:/bin/bash $ getent passwd fake_user2 fake_user2@example.com:x:1881368896:1881368896::/home/fake_user2:/bin/bash This problem occurs even for users that neither exist locally nor in your Azure Entra ID tenant. Additionally, this issue can lead to complications with package management tools (e.g., apt or dnf ) that need to create system users during installation.","title":"Overview"},{"location":"troubleshooting/Troubleshooting%3A-%60The-user-%27...%27-already-exists%60-and-fake-users-listed-in-NSS/#root-cause","text":"This behavior arises from the cn_name_mapping parameter in your himmelblau.conf configuration file. By default, this parameter is enabled ( true ) unless explicitly set to false . When enabled, it automatically maps common names (CN) to user principal names (UPN). The issue appears to occur because user enumeration is disabled in Azure Entra ID . Azure Entra ID is responding to all user existence requests as if the user does exist , regardless of whether the user truly exists in the directory. It's unknown which setting in Azure Entra Id is causing this behavior, but it is assumed that Microsoft has implemented this behavior to ensure authentication does not fail for valid users. If the system always responded that users do not exist, authentication would fail even for legitimate accounts. It's assumed that the purpose of this behavior is to prevent the enumeration of valid UPN names from the directory. When an attacker is able to enumerate a list of valid UPN names, it can enable password spray attacks, brute force attacks, phishing attacks, and password reuse attacks.","title":"Root Cause"},{"location":"troubleshooting/Troubleshooting%3A-%60The-user-%27...%27-already-exists%60-and-fake-users-listed-in-NSS/#impact","text":"Local User Management : System tools like useradd fail to create new users. Package Installation : Software installations that create system users for daemons may fail, causing package dependency issues. General User Queries : Tools like getent passwd may list users that do not exist.","title":"Impact"},{"location":"troubleshooting/Troubleshooting%3A-%60The-user-%27...%27-already-exists%60-and-fake-users-listed-in-NSS/#solution-disable-cn_name_mapping","text":"To mitigate this issue, disable the cn_name_mapping parameter in your Himmelblau configuration file. Locate the Configuration File : The default configuration file is located at: /etc/himmelblau/himmelblau.conf Edit the File : Open the file in your preferred text editor: sudo nano /etc/himmelblau/himmelblau.conf Disable cn_name_mapping : Locate the [global] section and add or modify the following line: cn_name_mapping = false Restart Himmelblau Services : After saving the changes, restart the Himmelblau services to apply the new configuration: sudo systemctl restart himmelblaud sudo systemctl restart himmelblaud-tasks After disabling cn_name_mapping , all users will be required to authenticate to the host using their UPN.","title":"Solution: Disable cn_name_mapping"},{"location":"troubleshooting/Troubleshooting%3A-%60The-user-%27...%27-already-exists%60-and-fake-users-listed-in-NSS/#verification","text":"Check user enumeration again: getent passwd test1 Ensure the user is not falsely listed. Retry adding a new user: sudo useradd test1 It should now succeed without errors.","title":"Verification"},{"location":"troubleshooting/Troubleshooting%3A-%60The-user-%27...%27-already-exists%60-and-fake-users-listed-in-NSS/#notes","text":"Disabling cn_name_mapping prevents Himmelblau from making optimistic assumptions about user existence. This adjustment ensures compatibility with environments where Azure Entra ID has user enumeration disabled, aligning expected behavior with the tenant\u2019s security configuration.","title":"Notes"},{"location":"troubleshooting/Troubleshooting%3A-%60The-user-%27...%27-already-exists%60-and-fake-users-listed-in-NSS/#additional-references","text":"For more details about himmelblau.conf parameters, refer to the Himmelblau Configuration Guide or the himmelblau.conf man page . If you continue experiencing issues, consider clearing or invalidating the Himmelblau cache using the aad-tool utility: sudo aad-tool cache-clear","title":"Additional References"},{"location":"troubleshooting/Write-Permissions-for-the-%60logon_script%60-Parameter-in-Himmelblau/","text":"Overview In Himmelblau, the logon_script parameter in himmelblau.conf specifies a script that is executed by the himmelblaud-tasks service at logon time. To ensure the script has the appropriate write access, it may be necessary to modify the himmelblaud-tasks.service file to include specific directories in the ReadWritePaths directive. Steps to Modify the Service File for logon_script Locate the himmelblaud-tasks.service File On Rocky/SUSE Linux: sudo vim /usr/lib/systemd/system/himmelblaud-tasks.service On Debian/Ubuntu: sudo nano /etc/systemd/system/himmelblaud-tasks.service Edit the ReadWritePaths Directive Add the paths that need write access for the script specified by logon_script . For example, if the script logs output to /var/log , include /var/log in ReadWritePaths . Updated section of the service file: [Service] ReadWritePaths=/home /var/run/himmelblaud /var/log Save and Close the File Reload systemd and Restart the Service Reload systemd to apply the changes: sudo systemctl daemon-reload Restart the service: sudo systemctl restart himmelblaud-tasks Following these steps will ensure that the logon_script has the necessary permissions to write to the specified paths.","title":"Write Permissions for the `logon script` Parameter in Himmelblau"},{"location":"troubleshooting/Write-Permissions-for-the-%60logon_script%60-Parameter-in-Himmelblau/#overview","text":"In Himmelblau, the logon_script parameter in himmelblau.conf specifies a script that is executed by the himmelblaud-tasks service at logon time. To ensure the script has the appropriate write access, it may be necessary to modify the himmelblaud-tasks.service file to include specific directories in the ReadWritePaths directive.","title":"Overview"},{"location":"troubleshooting/Write-Permissions-for-the-%60logon_script%60-Parameter-in-Himmelblau/#steps-to-modify-the-service-file-for-logon_script","text":"Locate the himmelblaud-tasks.service File On Rocky/SUSE Linux: sudo vim /usr/lib/systemd/system/himmelblaud-tasks.service On Debian/Ubuntu: sudo nano /etc/systemd/system/himmelblaud-tasks.service Edit the ReadWritePaths Directive Add the paths that need write access for the script specified by logon_script . For example, if the script logs output to /var/log , include /var/log in ReadWritePaths . Updated section of the service file: [Service] ReadWritePaths=/home /var/run/himmelblaud /var/log Save and Close the File Reload systemd and Restart the Service Reload systemd to apply the changes: sudo systemctl daemon-reload Restart the service: sudo systemctl restart himmelblaud-tasks Following these steps will ensure that the logon_script has the necessary permissions to write to the specified paths.","title":"Steps to Modify the Service File for logon_script"}]}