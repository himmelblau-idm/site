<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://himmelblau-idm.org/docs/troubleshooting/Troubleshooting%3A-%60The-user-%27...%27-already-exists%60-and-fake-users-listed-in-NSS/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Troubleshooting: `The user '...' already exists` and fake users listed in NSS - Himmelblau Documentation</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Troubleshooting: `The user \u0027...\u0027 already exists` and fake users listed in NSS";
        var mkdocs_page_input_path = "troubleshooting/Troubleshooting:-`The-user-\u0027...\u0027-already-exists`-and-fake-users-listed-in-NSS.md";
        var mkdocs_page_url = "/docs/troubleshooting/Troubleshooting%3A-%60The-user-%27...%27-already-exists%60-and-fake-users-listed-in-NSS/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script>
   
  <script type="text/javascript" data-cmp-ab="1" src="https://cdn.consentmanager.net/delivery/autoblocking/8bffa521a2c48.js" data-cmp-host="c.delivery.consentmanager.net" data-cmp-cdn="cdn.consentmanager.net" data-cmp-codesrc="16"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Himmelblau Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="" href="https://himmelblau-idm.org/s/">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Quickstart</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../installation/">Installation</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../configuration/">Configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../registration/">Device Registration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../integration/">Migration from On-Prem</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../ecosystem/">Ecosystem</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../about/">About</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Reference</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../reference/aad-tool/">Aad tool</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../reference/himmelblau-conf/">Himmelblau conf</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../reference/himmelblaud/">Himmelblaud</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../reference/himmelblaud_tasks/">Himmelblaud tasks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../reference/pam_himmelblau/">Pam himmelblau</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Advanced Topics</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../advanced/Cloud-Kerberos-Trust-for-Linux/">Cloud Kerberos Trust for Linux</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../advanced/Configuring-Unix-Attribute-Synchronization-with-Azure-Entra-ID-Using-Microsoft-Entra-Connect-Sync/">Configuring Unix Attribute Synchronization with Azure Entra ID Using Microsoft Entra Connect Sync</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../advanced/Configuring-a-Hardware-TPM-for-Secure-Key-Storage/">Configuring a Hardware TPM for Secure Key Storage</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../advanced/Creating-an-Entra-ID-Application-for-Himmelblau-GroupMember.Read.All-Permissions/">Creating an Entra ID Application for Himmelblau GroupMember.Read.All Permissions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../advanced/Design/">Design Principles</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../advanced/Device-Compliance-Settings-for-Linux-in-Intune-with-Himmelblau/">Device Compliance Settings for Linux in Intune with Himmelblau</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../advanced/Enabling-the-Himmelblau-QR-Greeter-gnome%E2%80%90shell-Extension/">Enabling the Himmelblau QR Greeter gnome‐shell Extension</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../advanced/MS-specs-which-Himmelblau-uses/">MS specs which Himmelblau uses</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../advanced/Syncing-Active-Directory-with-Azure-Entra-ID/">Syncing Active Directory with Azure Entra ID</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Troubleshooting</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../Capturing-authentication-traffic-using-cirrus%E2%80%90scope/">Capturing authentication traffic using cirrus‐scope</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../OpenSSH-Bug-2876-%E2%80%90--Unable-to-use-MFA-over-SSH-%E2%80%90-Workaround/">OpenSSH Bug 2876 ‐  Unable to use MFA over SSH ‐ Workaround</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Removing-all-Hello-PINs-%26-cached-PRTs-on-a-Himmelblau-host/">Removing all Hello PINs & cached PRTs on a Himmelblau host</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Testing-Himmelblau-Developer-Builds-with-Packet-Capture/">Testing Himmelblau Developer Builds with Packet Capture</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Troubleshooting: `The user '...' already exists` and fake users listed in NSS</a>
    <ul class="current">
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Write-Permissions-for-the-%60logon_script%60-Parameter-in-Himmelblau/">Write Permissions for the `logon script` Parameter in Himmelblau</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Himmelblau Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Troubleshooting</li>
      <li class="breadcrumb-item active">Troubleshooting: `The user '...' already exists` and fake users listed in NSS</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/himmelblau-idm/site/edit/main/mkdocs/docs/troubleshooting/Troubleshooting:-`The-user-'...'-already-exists`-and-fake-users-listed-in-NSS.md">Edit on Himmelblau Documentation</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h4 id="overview">Overview</h4>
<p>When using Himmelblau, you might encounter the error:</p>
<pre><code>useradd: user 'test1' already exists
</code></pre>
<p>or similar behavior when attempting to create local users. You might also notice that nss responds affirmatively to the existence of fake users:</p>
<pre><code>$ getent passwd fake_user1
fake_user1@example.com:x:955955525:955955525::/home/fake_user1:/bin/bash
$ getent passwd fake_user2
fake_user2@example.com:x:1881368896:1881368896::/home/fake_user2:/bin/bash
</code></pre>
<p>This problem occurs even for users that neither exist locally nor in your Azure Entra ID tenant. Additionally, this issue can lead to complications with package management tools (e.g., <code>apt</code> or <code>dnf</code>) that need to create system users during installation.</p>
<h4 id="root-cause">Root Cause</h4>
<p>This behavior arises from the <code>cn_name_mapping</code> parameter in your <strong>himmelblau.conf</strong> configuration file. By default, this parameter is enabled (<code>true</code>) unless explicitly set to <code>false</code>. When enabled, it automatically maps common names (CN) to user principal names (UPN).</p>
<p>The issue appears to occur because <strong>user enumeration is disabled in Azure Entra ID</strong>.</p>
<p>Azure Entra ID is responding to all user existence requests as if the user <strong>does exist</strong>, regardless of whether the user truly exists in the directory.
It's unknown which setting in Azure Entra Id is causing this behavior, but it is assumed that Microsoft has implemented this behavior to ensure authentication does not fail for valid users. If the system always responded that users do not exist, authentication would fail even for legitimate accounts. It's assumed that the purpose of this behavior is to prevent the enumeration of valid UPN names from the directory. When an attacker is able to enumerate a list of valid UPN names, it can enable password spray attacks, brute force attacks, phishing attacks, and password reuse attacks.</p>
<h4 id="impact">Impact</h4>
<ol>
<li><strong>Local User Management</strong>: System tools like <code>useradd</code> fail to create new users.</li>
<li><strong>Package Installation</strong>: Software installations that create system users for daemons may fail, causing package dependency issues.</li>
<li><strong>General User Queries</strong>: Tools like <code>getent passwd</code> may list users that do not exist.</li>
</ol>
<h4 id="solution-disable-cn_name_mapping">Solution: Disable <code>cn_name_mapping</code></h4>
<p>To mitigate this issue, disable the <code>cn_name_mapping</code> parameter in your Himmelblau configuration file.</p>
<ol>
<li>
<p><strong>Locate the Configuration File</strong>:
    The default configuration file is located at:</p>
<p><code>/etc/himmelblau/himmelblau.conf</code></p>
</li>
<li>
<p><strong>Edit the File</strong>:
    Open the file in your preferred text editor:</p>
<p><code>sudo nano /etc/himmelblau/himmelblau.conf</code></p>
</li>
<li>
<p><strong>Disable </strong><strong><code>cn_name_mapping</code></strong>:
    Locate the <code>[global]</code> section and add or modify the following line:</p>
<p><code>cn_name_mapping = false</code></p>
</li>
<li>
<p><strong>Restart Himmelblau Services</strong>:
    After saving the changes, restart the Himmelblau services to apply the new configuration:</p>
<p><code>sudo systemctl restart himmelblaud
sudo systemctl restart himmelblaud-tasks</code></p>
</li>
</ol>
<p>After disabling <code>cn_name_mapping</code>, all users will be required to authenticate to the host using their UPN.</p>
<h4 id="verification">Verification</h4>
<ul>
<li>Check user enumeration again:</li>
</ul>
<p><code>getent passwd test1</code></p>
<p>Ensure the user is not falsely listed.</p>
<ul>
<li>Retry adding a new user:</li>
</ul>
<p><code>sudo useradd test1</code></p>
<p>It should now succeed without errors.</p>
<h4 id="notes">Notes</h4>
<p>Disabling <code>cn_name_mapping</code> prevents Himmelblau from making optimistic assumptions about user existence. This adjustment ensures compatibility with environments where Azure Entra ID has user enumeration disabled, aligning expected behavior with the tenant’s security configuration.</p>
<h4 id="additional-references">Additional References</h4>
<ul>
<li>For more details about <code>himmelblau.conf</code> parameters, refer to the <a href="https://himmelblau-idm.org/docs.html#configuration">Himmelblau Configuration Guide</a> or the <a href="https://manpages.opensuse.org/Tumbleweed/himmelblau/himmelblau.conf.5.en.html"><code>himmelblau.conf</code> man page</a>.</li>
<li>If you continue experiencing issues, consider clearing or invalidating the Himmelblau cache using the <code>aad-tool</code> utility:
  <code>sudo aad-tool cache-clear</code></li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../Testing-Himmelblau-Developer-Builds-with-Packet-Capture/" class="btn btn-neutral float-left" title="Testing Himmelblau Developer Builds with Packet Capture"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../Write-Permissions-for-the-%60logon_script%60-Parameter-in-Himmelblau/" class="btn btn-neutral float-right" title="Write Permissions for the `logon script` Parameter in Himmelblau">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/himmelblau-idm/site.git" class="fa fa-code-fork" style="color: #fcfcfc"> Himmelblau Documentation</a>
        </span>
    
    
      <span><a href="../Testing-Himmelblau-Developer-Builds-with-Packet-Capture/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../Write-Permissions-for-the-%60logon_script%60-Parameter-in-Himmelblau/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../js/distro_list.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
